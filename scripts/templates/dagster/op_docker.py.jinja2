@op(
    name="{{ task.task_id }}",
    description="{{ task.task_name }}",
{% if task.ins %}
    ins={
{%   for input_spec in task.ins %}
        "{{ input_spec.name }}": In({{ input_spec.dagster_type }}),
{%   endfor %}
    },
{% endif %}
{% if task.outs %}
    out={
{%   for output_spec in task.outs %}
        "{{ output_spec.name }}": Out({{ output_spec.dagster_type }}),
{%   endfor %}
    },
{% else %}
    out=Out(Dict[str, Any]),
{% endif %}
{% if task.retries > 0 %}
    retry_policy=RetryPolicy(
        max_retries={{ task.retries }},
        delay={{ task.retry_delay_seconds }},
    ),
{% endif %}
{% if task.required_resource_keys %}
    required_resource_keys={{ task.required_resource_keys | tojson }},
{% endif %}
    tags={"executor": "docker", "pattern": "{{ detected_pattern | default('unknown') }}"},
)
def {{ task.task_id }}(
    context: OpExecutionContext,
{% if task.ins %}
{%   for input_spec in task.ins %}
    {{ input_spec.name }}: {{ input_spec.dagster_type }},
{%   endfor %}
{% endif %}
) -> Dict[str, Any]:
    """
    Docker op: {{ task.task_name }}
    
    Image: {{ task.image }}
    """
    context.log.info(f"Starting op: {{ task.task_id }}")
    
    # Build docker run command
    cmd = [
        'docker', 'run',
        '--rm',
        '-v', f'{HOST_DATA_DIR}:{CONTAINER_DATA_DIR}',
{% if task.network_mode %}
        '--network', '{{ task.network_mode }}',
{% endif %}
    ]
    
    # Environment variables
{% if task.environment %}
{% for key, value in task.environment.items() %}
    cmd.extend(['-e', '{{ key }}={{ value }}'])
{% endfor %}
{% endif %}
    
    # Image
    cmd.append('{{ task.image }}')
    
    # Command
{% if task.command %}
{% if task.command is string %}
    cmd.extend({{ task.command.split() | tojson }})
{% elif task.command is iterable %}
    cmd.extend({{ task.command | tojson }})
{% endif %}
{% endif %}
    
    # Execute
    try:
        result = subprocess.run(
            cmd,
            capture_output=True,
            text=True,
            check=True,
        )
        
        context.log.info(f"Op {{ task.task_id }} completed successfully")
        
        return {
            'op_id': '{{ task.task_id }}',
            'status': 'success',
            'stdout': result.stdout,
            'stderr': result.stderr,
        }
        
    except subprocess.CalledProcessError as e:
        context.log.error(f"Op {{ task.task_id }} failed: {e.stderr}")
        raise Failure(
            description=f"Docker container failed: {e.stderr}",
            metadata={'return_code': e.returncode}
        )