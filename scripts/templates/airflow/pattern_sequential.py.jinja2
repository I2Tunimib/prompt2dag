# ==============================================================================
# Generated Airflow DAG
# Pipeline: {{ pipeline_name }}
# Pattern: {{ detected_pattern }}
# Strategy: {{ generator_strategy }}
# Generated: {{ generation_timestamp }}
# ==============================================================================

from __future__ import annotations

import os
from datetime import datetime, timedelta

from airflow.models.dag import DAG
from airflow.providers.docker.operators.docker import DockerOperator
from airflow.utils.helpers import chain
from docker.types import Mount

# --- Configuration ---
HOST_DATA_DIR = os.getenv('HOST_DATA_DIR', {{ host_data_dir_default | repr }})
CONTAINER_DATA_DIR = '/app/data'

# --- Default Arguments ---
default_args = {
    'owner': 'airflow',
    'depends_on_past': False,
    'email_on_failure': False,
    'email_on_retry': False,
    'retries': {{ default_retries }},
    'retry_delay': timedelta(minutes={{ default_retry_delay }}),
}

# --- DAG Definition ---
with DAG(
    dag_id={{ dag_id | repr }},
    default_args=default_args,
    description={{ pipeline_description | repr }},
    schedule_interval={{ schedule_expression | schedule_repr }},
    start_date=datetime({{ start_date.year }}, {{ start_date.month }}, {{ start_date.day }}),
    catchup={{ catchup }},
    tags={{ tags | to_python_list }},
) as dag:

    # ==========================================================================
    # Task Definitions
    # ==========================================================================
{% for task in processed_tasks %}

    # Task: {{ task.task_id }}
    {{ task.task_id }} = DockerOperator(
        task_id={{ task.task_id | repr }},
        image={{ task.image | repr }},
{% if task.command %}
        command={{ task.command | repr }},
{% endif %}
        environment={{ task.environment | to_python_dict }},
        network_mode={{ task.network_mode | repr }},
        mounts=[Mount(source=HOST_DATA_DIR, target=CONTAINER_DATA_DIR, type='bind')],
        auto_remove={{ task.auto_remove }},
        docker_url={{ task.docker_url | repr }},
        mount_tmp_dir=False,
        force_pull=False,
        tty=True,
    )
{% endfor %}

    # ==========================================================================
    # Task Dependencies
    # ==========================================================================
{% if dependencies %}
{% for src, dst in dependencies %}
    {{ src }} >> {{ dst }}
{% endfor %}
{% else %}
    # No dependencies (single task or parallel execution)
{% endif %}