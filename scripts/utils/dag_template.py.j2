{# scripts/utils/dag_template.py.j2 #}
# Generated by: {{ script_name }}
# Source YAML: {{ source_yaml_filename }}
# Template Based Generation
# Generated at: {{ generation_timestamp }}
# WARNING: Review carefully before execution.
# ==============================================================================

from __future__ import annotations

import os
from datetime import timedelta, datetime

from airflow.models.dag import DAG
from airflow.providers.docker.operators.docker import DockerOperator
from airflow.utils.helpers import chain
from docker.types import Mount

# --- Global Variables ---
# Default HOST_DATA_DIR, overridden by environment variable if set
HOST_DATA_DIR = os.getenv('HOST_DATA_DIR', {{ host_data_dir_default | repr }})
# Standard container path, assumed to be consistent
CONTAINER_DATA_DIR = '/app/data'

# Define other global environment variables needed by tasks
{% for env_name, env_def in global_environment_vars.items() %}
# {{ env_def.description if env_def.description else "Environment variable for " + env_name }}
{{ env_name }} = os.getenv('{{ env_name }}', {{ (env_def.default if env_def.default else '') | repr }})
{% endfor %}

# --- Default Arguments ---
default_args = {
    'owner': 'airflow',
    'depends_on_past': False,
    'email_on_failure': False,
    'email_on_retry': False,
    'retries': {{ default_retries }},
    'retry_delay': timedelta(minutes={{ default_retry_delay }}),
}

# --- DAG Definition ---
with DAG(
    dag_id={{ dag_id | repr }},
    default_args=default_args,
    description={{ description | repr }},
    schedule_interval={{ schedule_interval | schedule_repr }},
    start_date=datetime({{ start_date.year }}, {{ start_date.month }}, {{ start_date.day }}),
    catchup={{ catchup | default(False) }},
    tags={{ tags | default(['generated', 'template', 'docker']) | list | repr }},
) as dag:

    # ==========================================================================
    # Task Definitions
    # ==========================================================================

    # --- Sequential Tasks ---
    {% for task in sequential_tasks %}
    # Task: {{ task.task_id }} (Type: {{ task.component_type_id }})
    {{ task.task_id }} = DockerOperator(
        task_id={{ task.task_id | repr }},
        image={{ task.image | repr }},
        command={{ task.command | format_command_list }},
        environment={{ task.environment | format_environment_dict }},
        network_mode={{ task.network_mode | repr }},
        mounts=[Mount(source=HOST_DATA_DIR, target=CONTAINER_DATA_DIR, type='bind')],
        mount_tmp_dir={{ task.mount_tmp_dir | default(False) }},
        auto_remove={{ task.auto_remove | default(True) }},
        docker_url={{ task.docker_url | default('unix://var/run/docker.sock') | repr }},
        force_pull={{ task.force_pull | default(False) }},
        tty={{ task.tty | default(True) }},
    )
    {% else %}
    # No sequential tasks defined.
    {% endfor %}

    # ==========================================================================
    # Set Task Dependencies
    # ==========================================================================
    {% if dependencies %}
    # Define execution order
    {% for src, dst in dependencies %}
    {{ src }} >> {{ dst }}
    {% endfor %}
    {% else %}
    # No explicit dependencies defined.
    {% endif %}