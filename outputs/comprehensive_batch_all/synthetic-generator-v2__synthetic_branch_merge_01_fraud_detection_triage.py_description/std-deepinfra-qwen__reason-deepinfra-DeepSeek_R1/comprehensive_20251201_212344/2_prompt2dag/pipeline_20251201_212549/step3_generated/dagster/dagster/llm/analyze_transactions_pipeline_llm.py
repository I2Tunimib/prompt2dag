# Generated by Dagster Code Generator
# Generation Date: 2023-10-05
# Dagster Version: 1.5.0

from dagster import (
    job,
    op,
    Out,
    In,
    RetryPolicy,
    multiprocess_executor,
    fs_io_manager,
    resource,
    schedule,
)

# Resources
@resource
def manual_review_queue():
    """Resource for the manual review queue."""
    pass

@resource
def payment_processing_system():
    """Resource for the payment processing system."""
    pass

@resource
def notification_system():
    """Resource for the notification system."""
    pass

@resource
def file_system():
    """Resource for the file system."""
    pass

# Ops
@op(
    out={"transactions": Out()},
    retry_policy=RetryPolicy(max_retries=2),
    required_resource_keys={"file_system"},
)
def analyze_transactions(context):
    """Analyze transactions from CSV files."""
    # Simulate reading transactions from CSV files
    transactions = [{"id": 1, "amount": 100}, {"id": 2, "amount": 200}]
    context.log.info(f"Analyzed {len(transactions)} transactions")
    return transactions

@op(
    ins={"transactions": In()},
    out={"auto_approve_transactions": Out(), "manual_review_transactions": Out()},
    retry_policy=RetryPolicy(max_retries=2),
    required_resource_keys={"manual_review_queue"},
)
def route_transaction(context, transactions):
    """Route transactions to auto-approve or manual review."""
    auto_approve_transactions = []
    manual_review_transactions = []
    for transaction in transactions:
        if transaction["amount"] < 150:
            auto_approve_transactions.append(transaction)
        else:
            manual_review_transactions.append(transaction)
            context.resources.manual_review_queue.add(transaction)
    context.log.info(f"Routed {len(auto_approve_transactions)} transactions to auto-approve")
    context.log.info(f"Routed {len(manual_review_transactions)} transactions to manual review")
    return auto_approve_transactions, manual_review_transactions

@op(
    ins={"transactions": In()},
    retry_policy=RetryPolicy(max_retries=2),
    required_resource_keys={"payment_processing_system"},
)
def route_to_auto_approve(context, transactions):
    """Route transactions to auto-approve in the payment processing system."""
    for transaction in transactions:
        context.resources.payment_processing_system.approve(transaction)
    context.log.info(f"Auto-approved {len(transactions)} transactions")

@op(
    ins={"transactions": In()},
    retry_policy=RetryPolicy(max_retries=2),
    required_resource_keys={"manual_review_queue"},
)
def route_to_manual_review(context, transactions):
    """Route transactions to manual review in the manual review queue."""
    for transaction in transactions:
        context.resources.manual_review_queue.add(transaction)
    context.log.info(f"Routed {len(transactions)} transactions to manual review")

@op(
    ins={"auto_approve_transactions": In(), "manual_review_transactions": In()},
    retry_policy=RetryPolicy(max_retries=2),
    required_resource_keys={"notification_system"},
)
def send_notification(context, auto_approve_transactions, manual_review_transactions):
    """Send notifications for auto-approved and manually reviewed transactions."""
    for transaction in auto_approve_transactions:
        context.resources.notification_system.notify(f"Transaction {transaction['id']} auto-approved")
    for transaction in manual_review_transactions:
        context.resources.notification_system.notify(f"Transaction {transaction['id']} requires manual review")
    context.log.info(f"Sent notifications for {len(auto_approve_transactions)} auto-approved transactions")
    context.log.info(f"Sent notifications for {len(manual_review_transactions)} manual review transactions")

# Job
@job(
    name="analyze_transactions_pipeline",
    description="No description provided.",
    executor_def=multiprocess_executor,
    resource_defs={
        "manual_review_queue": manual_review_queue,
        "payment_processing_system": payment_processing_system,
        "notification_system": notification_system,
        "file_system": file_system,
    },
    config={
        "ops": {
            "analyze_transactions": {
                "config": {}
            },
            "route_transaction": {
                "config": {}
            },
            "route_to_auto_approve": {
                "config": {}
            },
            "route_to_manual_review": {
                "config": {}
            },
            "send_notification": {
                "config": {}
            },
        }
    }
)
def analyze_transactions_pipeline():
    """Dagster job to analyze transactions and route them accordingly."""
    transactions = analyze_transactions()
    auto_approve_transactions, manual_review_transactions = route_transaction(transactions)
    route_to_auto_approve(auto_approve_transactions)
    route_to_manual_review(manual_review_transactions)
    send_notification(auto_approve_transactions, manual_review_transactions)

# Schedule
@schedule(
    job=analyze_transactions_pipeline,
    cron_schedule="@daily",
    execution_timezone="UTC",
    name="analyze_transactions_pipeline_schedule",
    catchup=False,
)
def analyze_transactions_pipeline_schedule(_context):
    return {}