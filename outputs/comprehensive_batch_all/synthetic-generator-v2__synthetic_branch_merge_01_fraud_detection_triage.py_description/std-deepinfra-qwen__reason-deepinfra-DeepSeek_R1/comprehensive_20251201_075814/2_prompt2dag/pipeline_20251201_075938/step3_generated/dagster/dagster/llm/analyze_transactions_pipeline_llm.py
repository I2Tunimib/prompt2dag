# Generated by Dagster Code Generator
# Date: 2023-10-05
# Dagster Version: 1.5.0

from dagster import (
    job,
    op,
    In,
    Out,
    RetryPolicy,
    multiprocess_executor,
    fs_io_manager,
    resource,
    schedule,
)

# Resources
@resource
def file_system():
    """File system resource for managing transaction CSV files."""
    pass

@resource
def payment_processing_system():
    """Payment processing system resource."""
    pass

@resource
def notification_system():
    """Notification system resource."""
    pass

@resource
def manual_review_queue():
    """Manual review queue resource."""
    pass

# Ops
@op(
    out={"transactions": Out()},
    required_resource_keys={"file_system"},
    retry_policy=RetryPolicy(max_retries=2),
)
def analyze_transactions(context):
    """Analyze transactions from CSV files."""
    # Simulate transaction analysis
    transactions = [{"id": 1, "amount": 100}, {"id": 2, "amount": 200}]
    context.log.info(f"Analyzed {len(transactions)} transactions")
    return transactions

@op(
    ins={"transactions": In()},
    out={"auto_approve_transactions": Out(), "manual_review_transactions": Out()},
    required_resource_keys={"payment_processing_system"},
    retry_policy=RetryPolicy(max_retries=2),
)
def route_transaction(context, transactions):
    """Route transactions to auto-approve or manual review."""
    auto_approve_transactions = []
    manual_review_transactions = []
    for transaction in transactions:
        if transaction["amount"] < 150:
            auto_approve_transactions.append(transaction)
        else:
            manual_review_transactions.append(transaction)
    context.log.info(f"Routed {len(auto_approve_transactions)} transactions to auto-approve")
    context.log.info(f"Routed {len(manual_review_transactions)} transactions to manual review")
    return auto_approve_transactions, manual_review_transactions

@op(
    ins={"transactions": In()},
    required_resource_keys={"payment_processing_system"},
    retry_policy=RetryPolicy(max_retries=2),
)
def route_to_auto_approve(context, transactions):
    """Route transactions to auto-approve."""
    # Simulate auto-approval
    context.log.info(f"Auto-approved {len(transactions)} transactions")
    return transactions

@op(
    ins={"transactions": In()},
    required_resource_keys={"manual_review_queue"},
    retry_policy=RetryPolicy(max_retries=2),
)
def route_to_manual_review(context, transactions):
    """Route transactions to manual review."""
    # Simulate manual review queue
    context.log.info(f"Queued {len(transactions)} transactions for manual review")
    return transactions

@op(
    ins={"auto_approve_transactions": In(), "manual_review_transactions": In()},
    required_resource_keys={"notification_system"},
    retry_policy=RetryPolicy(max_retries=2),
)
def send_notification(context, auto_approve_transactions, manual_review_transactions):
    """Send notifications for auto-approved and manually reviewed transactions."""
    # Simulate sending notifications
    context.log.info(f"Sent notifications for {len(auto_approve_transactions)} auto-approved transactions")
    context.log.info(f"Sent notifications for {len(manual_review_transactions)} manually reviewed transactions")

# Job
@job(
    name="analyze_transactions_pipeline",
    description="No description provided.",
    executor_def=multiprocess_executor,
    resource_defs={
        "file_system": file_system,
        "payment_processing_system": payment_processing_system,
        "notification_system": notification_system,
        "manual_review_queue": manual_review_queue,
    },
    io_manager_def=fs_io_manager,
)
def analyze_transactions_pipeline():
    """Dagster job for analyzing transactions and routing them for processing."""
    transactions = analyze_transactions()
    auto_approve_transactions, manual_review_transactions = route_transaction(transactions)
    auto_approved = route_to_auto_approve(auto_approve_transactions)
    manual_reviewed = route_to_manual_review(manual_review_transactions)
    send_notification(auto_approve_transactions=auto_approved, manual_review_transactions=manual_reviewed)

# Schedule
@schedule(
    job=analyze_transactions_pipeline,
    cron_schedule="@daily",
    execution_timezone="UTC",
    name="analyze_transactions_pipeline_schedule",
    catchup=False,
)
def analyze_transactions_pipeline_schedule(_context):
    """Daily schedule for the analyze_transactions_pipeline job."""
    return {}