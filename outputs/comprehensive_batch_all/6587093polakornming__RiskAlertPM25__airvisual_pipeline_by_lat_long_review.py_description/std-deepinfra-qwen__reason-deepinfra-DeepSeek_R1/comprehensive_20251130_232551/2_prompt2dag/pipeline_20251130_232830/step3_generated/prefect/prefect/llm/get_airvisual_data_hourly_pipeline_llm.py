# Generated by Prefect 2.x Code Generator
# Date: 2023-10-05
# Prefect Version: 2.14.0

from prefect import flow, task, get_run_logger
from prefect.task_runners import SequentialTaskRunner
from prefect.blocks.system import Secret
from prefect.filesystems import LocalFileSystem
from prefect.blocks.database import Database
import requests
import pandas as pd
import psycopg2

# Load secrets and resources
airvisual_api = Secret.load("airvisual_api")
local_filesystem = LocalFileSystem.load("local_filesystem")
postgresql_db = Database.load("postgresql_db")

@task(retries=2, name="Fetch AirVisual Data")
def get_airvisual_data_hourly():
    logger = get_run_logger()
    api_key = airvisual_api.get()
    url = f"https://api.airvisual.com/v2/cities?key={api_key}"
    response = requests.get(url)
    response.raise_for_status()
    data = response.json()
    logger.info("Fetched AirVisual data successfully")
    return data

@task(retries=2, name="Read and Validate AirVisual Data")
def read_data_airvisual(data):
    logger = get_run_logger()
    df = pd.DataFrame(data['data'])
    if df.empty:
        logger.warning("No data to process")
        return None
    logger.info("Read and validated AirVisual data successfully")
    return df

@task(retries=2, name="Load AirVisual Data to PostgreSQL")
def load_data_airvisual_to_postgresql(df):
    logger = get_run_logger()
    if df is None:
        logger.warning("No data to load")
        return
    conn = psycopg2.connect(**postgresql_db.value)
    df.to_sql('airvisual_data', conn, if_exists='append', index=False)
    conn.close()
    logger.info("Loaded AirVisual data to PostgreSQL successfully")

@flow(name="get_airvisual_data_hourly_pipeline", task_runner=SequentialTaskRunner())
def get_airvisual_data_hourly_pipeline():
    logger = get_run_logger()
    logger.info("Starting get_airvisual_data_hourly_pipeline")

    # Fetch AirVisual Data
    data = get_airvisual_data_hourly()

    # Read and Validate AirVisual Data
    df = read_data_airvisual(data)

    # Load AirVisual Data to PostgreSQL
    load_data_airvisual_to_postgresql(df)

    logger.info("Completed get_airvisual_data_hourly_pipeline")

if __name__ == "__main__":
    get_airvisual_data_hourly_pipeline()