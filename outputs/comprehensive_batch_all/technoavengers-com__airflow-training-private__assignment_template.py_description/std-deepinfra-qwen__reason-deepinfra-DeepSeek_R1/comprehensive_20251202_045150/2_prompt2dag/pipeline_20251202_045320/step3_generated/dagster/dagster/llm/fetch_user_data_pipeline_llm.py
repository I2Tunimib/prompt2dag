# Generated by Dagster Code Generator
# Generation Metadata:
# - Job Name: fetch_user_data_pipeline
# - Description: No description provided.
# - Executor Type: in_process_executor
# - IO Manager: fs_io_manager
# - Dagster Version: 1.5.0
# - Use Assets: False
# - Required Resources: postgres, reqres

from dagster import job, op, Out, In, RetryPolicy, ResourceDefinition, fs_io_manager, in_process_executor

# Define the required resources
reqres_api = ResourceDefinition.mock_resource()
postgres_db = ResourceDefinition.mock_resource()

@op(required_resource_keys={"reqres_api"}, out=Out(dict))
def fetch_user_data(context):
    """
    Fetch user data from the Reqres API.
    """
    # Simulate API call
    response = context.resources.reqres_api.get('/api/users')
    return response.json()

@op(ins={"user_data": In(dict)}, out=Out(dict))
def process_user_data(context, user_data):
    """
    Process the fetched user data.
    """
    # Simulate data processing
    processed_data = {k: v for k, v in user_data.items() if k == 'data'}
    return processed_data

@op(ins={"processed_data": In(dict)}, out=Out(None))
def create_user_table(context, processed_data):
    """
    Create the user table in the PostgreSQL database.
    """
    # Simulate table creation
    context.resources.postgres_db.execute("CREATE TABLE IF NOT EXISTS users (id SERIAL PRIMARY KEY, name TEXT, email TEXT);")

@op(ins={"processed_data": In(dict)}, out=Out(None))
def insert_user_data(context, processed_data):
    """
    Insert the processed user data into the PostgreSQL database.
    """
    # Simulate data insertion
    for user in processed_data['data']:
        context.resources.postgres_db.execute(f"INSERT INTO users (name, email) VALUES ('{user['first_name']} {user['last_name']}', '{user['email']}');")

@job(
    resource_defs={"reqres_api": reqres_api, "postgres_db": postgres_db},
    executor_def=in_process_executor,
    description="No description provided.",
    io_manager_def=fs_io_manager,
)
def fetch_user_data_pipeline():
    """
    Dagster job to fetch, process, and store user data.
    """
    processed_data = process_user_data(fetch_user_data())
    create_user_table(processed_data)
    insert_user_data(create_user_table)