# Generated by Airflow DAG Code Generator
# Date: 2023-10-05
# Airflow Version: 2.x

from airflow import DAG
from airflow.operators.http_operator import SimpleHttpOperator
from airflow.operators.python import PythonOperator
from airflow.providers.postgres.operators.postgres import PostgresOperator
from airflow.utils.dates import days_ago
from airflow.exceptions import AirflowException
import requests
import json

# Default arguments for the DAG
default_args = {
    'owner': 'airflow',
    'start_date': days_ago(1),
    'retries': 0,
    'retry_delay': timedelta(minutes=5),
}

# Define the DAG
with DAG(
    dag_id='fetch_user_data_pipeline',
    default_args=default_args,
    schedule_interval='@daily',
    catchup=True,
    max_active_runs=1,
    tags=['example'],
) as dag:

    # Task: Fetch User Data
    fetch_user_data = SimpleHttpOperator(
        task_id='fetch_user_data',
        method='GET',
        endpoint='/api/users',
        http_conn_id='reqres_api',
        response_filter=lambda response: json.loads(response.text),
        log_response=True,
    )

    # Task: Process User Data
    def process_user_data(**kwargs):
        ti = kwargs['ti']
        user_data = ti.xcom_pull(task_ids='fetch_user_data')
        processed_data = []
        for user in user_data['data']:
            processed_data.append({
                'id': user['id'],
                'first_name': user['first_name'],
                'last_name': user['last_name'],
                'email': user['email'],
            })
        ti.xcom_push(key='processed_user_data', value=processed_data)

    process_user_data = PythonOperator(
        task_id='process_user_data',
        python_callable=process_user_data,
        provide_context=True,
    )

    # Task: Create User Table
    create_user_table = PostgresOperator(
        task_id='create_user_table',
        postgres_conn_id='postgres_db',
        sql="""
        CREATE TABLE IF NOT EXISTS users (
            id SERIAL PRIMARY KEY,
            first_name VARCHAR(255),
            last_name VARCHAR(255),
            email VARCHAR(255) UNIQUE
        );
        """,
    )

    # Task: Insert User Data
    def insert_user_data(**kwargs):
        ti = kwargs['ti']
        processed_data = ti.xcom_pull(task_ids='process_user_data', key='processed_user_data')
        if not processed_data:
            raise AirflowException("No user data to insert")

        insert_queries = []
        for user in processed_data:
            insert_query = f"""
            INSERT INTO users (id, first_name, last_name, email)
            VALUES ({user['id']}, '{user['first_name']}', '{user['last_name']}', '{user['email']}')
            ON CONFLICT (email) DO NOTHING;
            """
            insert_queries.append(insert_query)

        return insert_queries

    insert_user_data = PythonOperator(
        task_id='insert_user_data',
        python_callable=insert_user_data,
        provide_context=True,
    )

    # Set task dependencies
    fetch_user_data >> process_user_data >> create_user_table >> insert_user_data