# Generated by Prefect 2.x Code Generator
# Date: 2023-10-05
# Prefect Version: 2.14.0
# Flow Name: fetch_user_data_pipeline
# Deployment Name: fetch_user_data_pipeline_deployment
# Work Pool: default-agent-pool
# Task Runner: SequentialTaskRunner

from prefect import flow, task, get_run_logger
from prefect.blocks.system import Secret
from prefect.task_runners import SequentialTaskRunner
from prefect.deployments import Deployment
from prefect.orion.schemas.schedules import CronSchedule

# Load secrets
reqres_api = Secret.load("reqres_api").get()
postgres_db = Secret.load("postgres_db").get()

@task(retries=0, name="Fetch User Data")
def fetch_user_data():
    """
    Fetch user data from the Reqres API.
    """
    logger = get_run_logger()
    logger.info("Fetching user data from Reqres API...")
    # Example API call (replace with actual API call)
    import requests
    response = requests.get(f"{reqres_api}/api/users")
    response.raise_for_status()
    return response.json()

@task(retries=0, name="Process User Data")
def process_user_data(user_data):
    """
    Process the fetched user data.
    """
    logger = get_run_logger()
    logger.info("Processing user data...")
    # Example processing (replace with actual processing logic)
    processed_data = [user for user in user_data["data"]]
    return processed_data

@task(retries=0, name="Create User Table")
def create_user_table():
    """
    Create the user table in the PostgreSQL database.
    """
    logger = get_run_logger()
    logger.info("Creating user table in PostgreSQL...")
    # Example SQL execution (replace with actual SQL execution)
    import psycopg2
    conn = psycopg2.connect(postgres_db)
    cursor = conn.cursor()
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS users (
            id SERIAL PRIMARY KEY,
            first_name VARCHAR(255),
            last_name VARCHAR(255),
            email VARCHAR(255)
        )
    """)
    conn.commit()
    cursor.close()
    conn.close()

@task(retries=0, name="Insert User Data")
def insert_user_data(processed_data):
    """
    Insert the processed user data into the PostgreSQL database.
    """
    logger = get_run_logger()
    logger.info("Inserting user data into PostgreSQL...")
    # Example SQL execution (replace with actual SQL execution)
    import psycopg2
    conn = psycopg2.connect(postgres_db)
    cursor = conn.cursor()
    for user in processed_data:
        cursor.execute("""
            INSERT INTO users (first_name, last_name, email)
            VALUES (%s, %s, %s)
        """, (user["first_name"], user["last_name"], user["email"]))
    conn.commit()
    cursor.close()
    conn.close()

@flow(name="fetch_user_data_pipeline", task_runner=SequentialTaskRunner)
def fetch_user_data_pipeline():
    """
    Fetch user data from the Reqres API, process it, create a user table in PostgreSQL, and insert the data.
    """
    user_data = fetch_user_data()
    processed_data = process_user_data(user_data)
    create_user_table()
    insert_user_data(processed_data)

# Schedule the flow to run daily
schedule = CronSchedule(cron="0 0 * * *", timezone="UTC", catchup=False)

# Create a deployment for the flow
Deployment.build_from_flow(
    flow=fetch_user_data_pipeline,
    name="fetch_user_data_pipeline_deployment",
    work_pool_name="default-agent-pool",
    schedule=schedule,
)