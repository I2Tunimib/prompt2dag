# Generated by Dagster Code Generator
# Generation Metadata:
# - Job Name: etl_import_mondo
# - Description: No description provided.
# - Executor Type: k8s_job_executor
# - IO Manager: fs_io_manager
# - Dagster Version: 1.5.0
# - Use Assets: False
# - Required Resources: internal_parameter_validation_system, k8s_context, github_releases, s3_conn_id, internal_publishing_system, es_url, slack_webhook

from dagster import job, op, In, Out, RetryPolicy, ResourceDefinition, fs_io_manager, k8s_job_executor, in_process_executor

# Resources
github_mondo_releases = ResourceDefinition.hardcoded_resource("github_mondo_releases")
s3_datalake = ResourceDefinition.hardcoded_resource("s3_datalake")
elasticsearch = ResourceDefinition.hardcoded_resource("elasticsearch")
slack_webhook = ResourceDefinition.hardcoded_resource("slack_webhook")

@op(
    description="Validate Parameters",
    out={"validated_params": Out()},
    required_resource_keys={"internal_parameter_validation_system"},
    retry_policy=RetryPolicy(max_retries=0),
)
def params_validate(context):
    """Validate the parameters for the pipeline."""
    validated_params = context.resources.internal_parameter_validation_system.validate()
    return validated_params

@op(
    description="Download Mondo Terms",
    ins={"validated_params": In()},
    out={"mondo_terms": Out()},
    required_resource_keys={"github_releases"},
    retry_policy=RetryPolicy(max_retries=0),
)
def download_mondo_terms(context, validated_params):
    """Download Mondo terms from GitHub releases."""
    mondo_terms = context.resources.github_releases.download_terms(validated_params)
    return mondo_terms

@op(
    description="Normalize Mondo Terms",
    ins={"mondo_terms": In()},
    out={"normalized_terms": Out()},
    retry_policy=RetryPolicy(max_retries=0),
)
def normalized_mondo_terms(context, mondo_terms):
    """Normalize the downloaded Mondo terms."""
    normalized_terms = context.resources.internal_normalization_system.normalize(mondo_terms)
    return normalized_terms

@op(
    description="Index Mondo Terms",
    ins={"normalized_terms": In()},
    out={"indexed_terms": Out()},
    required_resource_keys={"elasticsearch"},
    retry_policy=RetryPolicy(max_retries=0),
)
def index_mondo_terms(context, normalized_terms):
    """Index the normalized Mondo terms in Elasticsearch."""
    indexed_terms = context.resources.elasticsearch.index_terms(normalized_terms)
    return indexed_terms

@op(
    description="Publish Mondo Data",
    ins={"indexed_terms": In()},
    out={"published_data": Out()},
    required_resource_keys={"internal_publishing_system"},
    retry_policy=RetryPolicy(max_retries=0),
)
def publish_mondo(context, indexed_terms):
    """Publish the indexed Mondo data."""
    published_data = context.resources.internal_publishing_system.publish(indexed_terms)
    return published_data

@op(
    description="Send Slack Notification",
    ins={"published_data": In()},
    required_resource_keys={"slack_webhook"},
    retry_policy=RetryPolicy(max_retries=0),
)
def slack(context, published_data):
    """Send a Slack notification about the pipeline completion."""
    context.resources.slack_webhook.send_notification(published_data)

@job(
    name="etl_import_mondo",
    description="No description provided.",
    executor_def=k8s_job_executor,
    resource_defs={
        "internal_parameter_validation_system": ResourceDefinition.hardcoded_resource("internal_parameter_validation_system"),
        "github_releases": github_mondo_releases,
        "s3_conn_id": s3_datalake,
        "elasticsearch": elasticsearch,
        "internal_publishing_system": ResourceDefinition.hardcoded_resource("internal_publishing_system"),
        "es_url": ResourceDefinition.hardcoded_resource("es_url"),
        "slack_webhook": slack_webhook,
        "io_manager": fs_io_manager,
    },
)
def etl_import_mondo():
    validated_params = params_validate()
    mondo_terms = download_mondo_terms(validated_params)
    normalized_terms = normalized_mondo_terms(mondo_terms)
    indexed_terms = index_mondo_terms(normalized_terms)
    published_data = publish_mondo(indexed_terms)
    slack(published_data)