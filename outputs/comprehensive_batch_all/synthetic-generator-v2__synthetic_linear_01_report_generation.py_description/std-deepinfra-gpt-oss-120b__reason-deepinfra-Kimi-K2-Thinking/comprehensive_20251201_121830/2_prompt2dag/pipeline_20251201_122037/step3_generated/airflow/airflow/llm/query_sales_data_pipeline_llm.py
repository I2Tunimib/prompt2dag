# Generated by Airflow DAG generator on 2024-06-13
"""
DAG: query_sales_data_pipeline
Description: Sequential linear pipeline that generates daily sales reports by querying PostgreSQL sales data,
converting it to CSV, creating a PDF chart, and emailing the report to management.
"""

from datetime import timedelta

from airflow import DAG
from airflow.exceptions import AirflowException
from airflow.models import Variable
from airflow.providers.common.sql.operators.sql import SQLExecuteQueryOperator
from airflow.operators.python import PythonOperator
from airflow.utils.dates import days_ago
from airflow.hooks.base import BaseHook

import pandas as pd
import matplotlib.pyplot as plt
import smtplib
from email.message import EmailMessage
import os


default_args = {
    "owner": "airflow",
    "depends_on_past": False,
    "email_on_failure": False,
    "email_on_retry": False,
    "retries": 0,
    "retry_delay": timedelta(minutes=5),
}


def transform_to_csv(**kwargs):
    """Transform query result to CSV and push file path to XCom."""
    ti = kwargs["ti"]
    rows = ti.xcom_pull(task_ids="query_sales_data")
    if not rows:
        raise AirflowException("No data fetched from PostgreSQL.")
    df = pd.DataFrame(rows)
    csv_path = "/tmp/sales_report.csv"
    df.to_csv(csv_path, index=False)
    ti.xcom_push(key="csv_path", value=csv_path)


def generate_pdf_chart(**kwargs):
    """Read CSV, generate a bar chart PDF and push file path to XCom."""
    ti = kwargs["ti"]
    csv_path = ti.xcom_pull(key="csv_path", task_ids="transform_to_csv")
    if not csv_path or not os.path.exists(csv_path):
        raise AirflowException("CSV file not found for PDF generation.")
    df = pd.read_csv(csv_path)

    # Expecting columns: sale_date, amount
    if "sale_date" not in df.columns or "amount" not in df.columns:
        raise AirflowException("CSV does not contain required columns.")

    plt.figure(figsize=(8, 6))
    df.groupby("sale_date")["amount"].sum().plot(kind="bar")
    plt.title("Daily Sales")
    plt.xlabel("Date")
    plt.ylabel("Amount")
    pdf_path = "/tmp/sales_report.pdf"
    plt.savefig(pdf_path, format="pdf")
    plt.close()
    ti.xcom_push(key="pdf_path", value=pdf_path)


def email_sales_report(**kwargs):
    """Email the CSV and PDF reports to management."""
    ti = kwargs["ti"]
    csv_path = ti.xcom_pull(key="csv_path", task_ids="transform_to_csv")
    pdf_path = ti.xcom_pull(key="pdf_path", task_ids="generate_pdf_chart")
    if not csv_path or not pdf_path:
        raise AirflowException("Report files missing for email attachment.")

    # Retrieve SMTP connection details
    conn = BaseHook.get_connection("email_smtp")
    if not conn.host:
        raise AirflowException("SMTP connection 'email_smtp' is not configured properly.")

    # Build email
    msg = EmailMessage()
    msg["Subject"] = "Daily Sales Report"
    msg["From"] = conn.login or "airflow@example.com"
    msg["To"] = Variable.get("management_email", default_var="management@example.com")
    msg.set_content("Please find attached the daily sales report (CSV and PDF).")

    for path in [csv_path, pdf_path]:
        with open(path, "rb") as f:
            data = f.read()
            filename = os.path.basename(path)
            maintype, subtype = ("application", "octet-stream")
            msg.add_attachment(data, maintype=maintype, subtype=subtype, filename=filename)

    try:
        with smtplib.SMTP(conn.host, conn.port) as server:
            if conn.password:
                server.starttls()
                server.login(conn.login, conn.password)
            server.send_message(msg)
    except Exception as exc:
        raise AirflowException(f"Failed to send email: {exc}")


with DAG(
    dag_id="query_sales_data_pipeline",
    description="Generate daily sales reports and email them to management.",
    schedule_interval="@daily",
    start_date=days_ago(1),
    catchup=False,
    default_args=default_args,
    tags=["sales", "report"],
    is_paused_upon_creation=True,
    render_template_as_native_obj=True,
) as dag:

    query_sales_data = SQLExecuteQueryOperator(
        task_id="query_sales_data",
        conn_id="postgres_sales_db",
        sql="""
            SELECT *
            FROM sales
            WHERE sale_date = CURRENT_DATE;
        """,
        do_xcom_push=True,
        retries=2,
        retry_delay=timedelta(minutes=5),
    )

    transform_to_csv_task = PythonOperator(
        task_id="transform_to_csv",
        python_callable=transform_to_csv,
        retries=0,
        provide_context=True,
    )

    generate_pdf_chart_task = PythonOperator(
        task_id="generate_pdf_chart",
        python_callable=generate_pdf_chart,
        retries=0,
        provide_context=True,
    )

    email_sales_report_task = PythonOperator(
        task_id="email_sales_report",
        python_callable=email_sales_report,
        retries=2,
        retry_delay=timedelta(minutes=5),
        provide_context=True,
    )

    # Set task dependencies
    query_sales_data >> transform_to_csv_task >> generate_pdf_chart_task >> email_sales_report_task