# Generated by Dagster Code Generator
# Date: 2023-10-05
# Dagster Version: 1.5.0

from dagster import (
    job,
    op,
    Out,
    In,
    RetryPolicy,
    resource,
    fs_io_manager,
    in_process_executor,
    ScheduleDefinition,
)

# Resources
@resource
def postgres_default():
    """Resource for connecting to the PostgreSQL database."""
    # Placeholder for actual database connection logic
    pass

@resource
def email_system():
    """Resource for sending emails."""
    # Placeholder for actual email system logic
    pass

# Ops
@op(
    required_resource_keys={"postgres_default"},
    out={"sales_data": Out()},
    retry_policy=RetryPolicy(max_retries=2),
)
def query_sales_data(context):
    """Query sales data from the PostgreSQL database."""
    # Placeholder for actual query logic
    sales_data = [{"date": "2023-10-01", "amount": 1000}, {"date": "2023-10-02", "amount": 1500}]
    context.log.info("Queried sales data successfully.")
    return sales_data

@op(
    ins={"sales_data": In()},
    out={"csv_file_path": Out()},
    retry_policy=RetryPolicy(max_retries=2),
)
def transform_to_csv(context, sales_data):
    """Transform sales data into CSV format and save to the local filesystem."""
    # Placeholder for actual transformation logic
    csv_file_path = "/path/to/sales_data.csv"
    with open(csv_file_path, "w") as f:
        f.write("date,amount\n")
        for row in sales_data:
            f.write(f"{row['date']},{row['amount']}\n")
    context.log.info("Transformed sales data to CSV and saved to file.")
    return csv_file_path

@op(
    ins={"csv_file_path": In()},
    out={"pdf_file_path": Out()},
    retry_policy=RetryPolicy(max_retries=2),
)
def generate_pdf_chart(context, csv_file_path):
    """Generate a PDF chart visualization from the CSV file."""
    # Placeholder for actual chart generation logic
    pdf_file_path = "/path/to/sales_data_chart.pdf"
    context.log.info("Generated PDF chart from CSV file.")
    return pdf_file_path

@op(
    ins={"pdf_file_path": In()},
    required_resource_keys={"email_system"},
    retry_policy=RetryPolicy(max_retries=2),
)
def email_sales_report(context, pdf_file_path):
    """Email the final sales report PDF to management."""
    # Placeholder for actual email sending logic
    context.log.info("Sent sales report PDF to management.")
    return

# Job
@job(
    name="query_sales_data_pipeline",
    description="Comprehensive pipeline that generates daily sales reports by querying PostgreSQL sales data, transforming it into CSV format, creating a PDF chart visualization, and emailing the final report to management.",
    executor_def=in_process_executor,
    resource_defs={
        "postgres_default": postgres_default,
        "email_system": email_system,
        "io_manager": fs_io_manager,
    },
)
def query_sales_data_pipeline():
    pdf_file_path = generate_pdf_chart(transform_to_csv(query_sales_data()))
    email_sales_report(pdf_file_path)

# Schedule
daily_schedule = ScheduleDefinition(
    job=query_sales_data_pipeline,
    cron_schedule="@daily",
    execution_timezone="UTC",
    name="daily_sales_report_schedule",
    description="Daily schedule for generating and emailing sales reports.",
    should_execute=lambda: True,
    tags={"dagster/priority": "1"},
    execution_time_window=None,
    default_status=ScheduleDefinition.DEFAULT_STATUS_RUNNING,
    job_name="query_sales_data_pipeline",
)