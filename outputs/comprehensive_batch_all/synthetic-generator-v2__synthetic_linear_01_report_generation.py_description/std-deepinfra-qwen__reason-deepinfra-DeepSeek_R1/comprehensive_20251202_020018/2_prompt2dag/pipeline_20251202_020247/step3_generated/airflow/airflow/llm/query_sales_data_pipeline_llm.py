# Generated by Airflow DAG Code Generator
# Date: 2023-10-05
# Author: Airflow Expert
# Description: Comprehensive pipeline that generates daily sales reports by querying PostgreSQL sales data, transforming it into CSV format, creating a PDF chart visualization, and emailing the final report to management.

from airflow import DAG
from airflow.operators.python import PythonOperator
from airflow.providers.postgres.operators.postgres import PostgresOperator
from airflow.utils.dates import days_ago
from airflow.operators.email import EmailOperator
from airflow.operators.dummy import DummyOperator
from airflow.utils.task_group import TaskGroup
from airflow.exceptions import AirflowException
import os
import pandas as pd
import matplotlib.pyplot as plt
from email.mime.text import MIMEText
from email.mime.application import MIMEApplication
from email.mime.multipart import MIMEMultipart
import smtplib

# Default arguments for the DAG
default_args = {
    'owner': 'airflow',
    'depends_on_past': False,
    'email_on_failure': True,
    'email_on_retry': False,
    'retries': 2,
    'retry_delay': timedelta(minutes=5),
}

# Define the DAG
with DAG(
    dag_id='query_sales_data_pipeline',
    default_args=default_args,
    schedule_interval='@daily',
    start_date=days_ago(1),
    catchup=False,
    tags=['sales', 'reporting'],
) as dag:

    # Task: Query Sales Data
    def query_sales_data():
        # Example SQL query to fetch sales data
        sql_query = """
        SELECT * FROM sales_data
        WHERE date >= CURRENT_DATE - INTERVAL '1 day';
        """
        # Execute the query and return the result
        return sql_query

    query_sales_data_task = PostgresOperator(
        task_id='query_sales_data',
        postgres_conn_id='postgres_default',
        sql=query_sales_data(),
        retries=2,
    )

    # Task: Transform to CSV
    def transform_to_csv(**kwargs):
        # Fetch the result of the SQL query
        ti = kwargs['ti']
        sales_data = ti.xcom_pull(task_ids='query_sales_data')
        
        # Convert the result to a DataFrame
        df = pd.DataFrame(sales_data)
        
        # Save the DataFrame to a CSV file
        csv_file_path = '/tmp/sales_data.csv'
        df.to_csv(csv_file_path, index=False)
        
        return csv_file_path

    transform_to_csv_task = PythonOperator(
        task_id='transform_to_csv',
        python_callable=transform_to_csv,
        retries=2,
    )

    # Task: Generate PDF Chart
    def generate_pdf_chart(**kwargs):
        # Fetch the CSV file path
        ti = kwargs['ti']
        csv_file_path = ti.xcom_pull(task_ids='transform_to_csv')
        
        # Read the CSV file into a DataFrame
        df = pd.read_csv(csv_file_path)
        
        # Generate a simple bar chart
        plt.figure(figsize=(10, 6))
        plt.bar(df['date'], df['sales'])
        plt.xlabel('Date')
        plt.ylabel('Sales')
        plt.title('Daily Sales Report')
        plt.savefig('/tmp/sales_report.pdf')
        
        return '/tmp/sales_report.pdf'

    generate_pdf_chart_task = PythonOperator(
        task_id='generate_pdf_chart',
        python_callable=generate_pdf_chart,
        retries=2,
    )

    # Task: Email Sales Report
    def email_sales_report(**kwargs):
        # Fetch the PDF file path
        ti = kwargs['ti']
        pdf_file_path = ti.xcom_pull(task_ids='generate_pdf_chart')
        
        # Email configuration
        sender = 'sender@example.com'
        receiver = 'receiver@example.com'
        subject = 'Daily Sales Report'
        body = 'Please find the attached daily sales report.'
        
        # Create the email message
        msg = MIMEMultipart()
        msg['From'] = sender
        msg['To'] = receiver
        msg['Subject'] = subject
        msg.attach(MIMEText(body))
        
        # Attach the PDF file
        with open(pdf_file_path, 'rb') as f:
            part = MIMEApplication(f.read(), Name=os.path.basename(pdf_file_path))
            part['Content-Disposition'] = f'attachment; filename="{os.path.basename(pdf_file_path)}"'
            msg.attach(part)
        
        # Send the email
        with smtplib.SMTP('smtp.example.com', 587) as server:
            server.starttls()
            server.login('username', 'password')
            server.sendmail(sender, receiver, msg.as_string())

    email_sales_report_task = PythonOperator(
        task_id='email_sales_report',
        python_callable=email_sales_report,
        retries=2,
    )

    # Set task dependencies
    query_sales_data_task >> transform_to_csv_task >> generate_pdf_chart_task >> email_sales_report_task