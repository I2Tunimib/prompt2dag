# Generated by Airflow DAG Generator
# Date: 2023-10-05
# Airflow Version: 2.x

import os
from datetime import timedelta
from airflow import DAG
from airflow.operators.python import PythonOperator
from airflow.providers.postgres.operators.postgres import PostgresOperator
from airflow.utils.dates import days_ago
from airflow.operators.email import EmailOperator
from airflow.operators.docker_operator import DockerOperator

# Default arguments for the DAG
default_args = {
    'owner': 'airflow',
    'depends_on_past': False,
    'email_on_failure': True,
    'email_on_retry': True,
    'retries': 2,
    'retry_delay': timedelta(minutes=5),
}

# Define the DAG
with DAG(
    dag_id='query_sales_data_pipeline',
    description='No description provided.',
    schedule_interval='@daily',
    start_date=days_ago(1),
    catchup=False,
    default_args=default_args,
    tags=['sales', 'data', 'reporting'],
) as dag:

    # Task: Query Sales Data
    def query_sales_data():
        # Example SQL query to fetch sales data
        sql_query = """
        SELECT * FROM sales_data
        WHERE date >= CURRENT_DATE - INTERVAL '1 day';
        """
        return sql_query

    query_sales_data_task = PostgresOperator(
        task_id='query_sales_data',
        postgres_conn_id='postgres_default',
        sql=query_sales_data(),
        retries=2,
    )

    # Task: Transform to CSV
    def transform_to_csv(**kwargs):
        # Example transformation logic to convert query result to CSV
        ti = kwargs['ti']
        sales_data = ti.xcom_pull(task_ids='query_sales_data')
        csv_file_path = '/tmp/sales_data.csv'
        with open(csv_file_path, 'w') as f:
            f.write(sales_data)
        return csv_file_path

    transform_to_csv_task = PythonOperator(
        task_id='transform_to_csv',
        python_callable=transform_to_csv,
        retries=2,
    )

    # Task: Generate PDF Chart
    def generate_pdf_chart(**kwargs):
        # Example logic to generate a PDF chart from the CSV file
        ti = kwargs['ti']
        csv_file_path = ti.xcom_pull(task_ids='transform_to_csv')
        pdf_file_path = '/tmp/sales_report.pdf'
        # Placeholder for actual chart generation logic
        with open(pdf_file_path, 'w') as f:
            f.write('PDF content generated from ' + csv_file_path)
        return pdf_file_path

    generate_pdf_chart_task = PythonOperator(
        task_id='generate_pdf_chart',
        python_callable=generate_pdf_chart,
        retries=2,
    )

    # Task: Email Sales Report
    def email_sales_report(**kwargs):
        # Example logic to send the PDF report via email
        ti = kwargs['ti']
        pdf_file_path = ti.xcom_pull(task_ids='generate_pdf_chart')
        # Placeholder for actual email sending logic
        email_subject = 'Daily Sales Report'
        email_body = 'Please find the attached sales report.'
        email_to = 'sales@company.com'
        # Using EmailOperator to send the email
        EmailOperator(
            task_id='email_sales_report',
            to=email_to,
            subject=email_subject,
            html_content=email_body,
            files=[pdf_file_path],
        ).execute(kwargs)

    email_sales_report_task = PythonOperator(
        task_id='email_sales_report',
        python_callable=email_sales_report,
        retries=2,
    )

    # Define task dependencies
    query_sales_data_task >> transform_to_csv_task >> generate_pdf_chart_task >> email_sales_report_task