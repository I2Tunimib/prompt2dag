# Generated by Dagster Code Generator
# Generation Date: 2023-10-06
# Dagster Version: 1.5.0

from dagster import (
    job,
    op,
    Out,
    In,
    RetryPolicy,
    ResourceDefinition,
    fs_io_manager,
    ScheduleDefinition,
    executor,
    in_process_executor,
)
from dagster.utils import file_relative_path
from dagster_postgres import postgres_resource
from dagster_email import email_resource


@op(
    required_resource_keys={"postgres_default"},
    out={"sales_data": Out()},
    retry_policy=RetryPolicy(max_retries=2),
)
def query_sales_data(context):
    """
    Query sales data from the PostgreSQL database.
    """
    query = "SELECT * FROM sales;"
    result = context.resources.postgres_default.execute_query(query)
    sales_data = [dict(row) for row in result.fetchall()]
    return sales_data


@op(
    ins={"sales_data": In()},
    out={"csv_file_path": Out()},
    retry_policy=RetryPolicy(max_retries=2),
)
def transform_to_csv(context, sales_data):
    """
    Transform the sales data into a CSV file and save it to the local filesystem.
    """
    import csv
    import os

    csv_file_path = file_relative_path(__file__, "sales_data.csv")
    with open(csv_file_path, mode="w", newline="") as file:
        writer = csv.DictWriter(file, fieldnames=sales_data[0].keys())
        writer.writeheader()
        writer.writerows(sales_data)
    return csv_file_path


@op(
    ins={"csv_file_path": In()},
    out={"pdf_file_path": Out()},
    retry_policy=RetryPolicy(max_retries=2),
)
def generate_pdf_chart(context, csv_file_path):
    """
    Generate a PDF chart from the CSV file and save it to the local filesystem.
    """
    import matplotlib.pyplot as plt
    import pandas as pd

    df = pd.read_csv(csv_file_path)
    plt.figure(figsize=(10, 5))
    plt.plot(df["date"], df["amount"])
    plt.title("Sales Data")
    plt.xlabel("Date")
    plt.ylabel("Amount")
    pdf_file_path = file_relative_path(__file__, "sales_chart.pdf")
    plt.savefig(pdf_file_path)
    return pdf_file_path


@op(
    ins={"pdf_file_path": In()},
    retry_policy=RetryPolicy(max_retries=2),
)
def email_sales_report(context, pdf_file_path):
    """
    Email the sales report PDF to the specified recipients.
    """
    recipients = ["sales@company.com"]
    subject = "Monthly Sales Report"
    body = "Please find the attached sales report."
    context.resources.email_system.send_email(
        recipients=recipients, subject=subject, body=body, attachments=[pdf_file_path]
    )


@job(
    resource_defs={
        "postgres_default": postgres_resource.configured(
            {"config": {"host": "localhost", "user": "user", "password": "password", "dbname": "sales"}}
        ),
        "io_manager": fs_io_manager,
        "email_system": email_resource,
    },
    executor_def=in_process_executor,
    description="No description provided.",
)
def query_sales_data_pipeline():
    pdf_file_path = generate_pdf_chart(transform_to_csv(query_sales_data()))
    email_sales_report(pdf_file_path)


query_sales_data_pipeline_schedule = ScheduleDefinition(
    job=query_sales_data_pipeline,
    cron_schedule="@daily",
    execution_timezone="UTC",
    should_execute=lambda: True,
    execution_time_window=None,
    name="query_sales_data_pipeline_schedule",
    tags=None,
    description="No description provided.",
    job_name="query_sales_data_pipeline",
    default_status="RUNNING",
    execution_timezone="UTC",
    execution_time_window=None,
)