# Generated by Prefect 2.x Code Generator
# Date: [Current Date]
# Prefect Version: 2.14.0

from prefect import flow, task, get_run_logger
from prefect_docker import DockerContainer
from prefect_docker.credentials import DockerHost
from prefect.infrastructure import DockerContainer as DockerContainerInfra
from prefect.blocks.system import Secret
from prefect.filesystems import LocalFileSystem
from prefect.task_runners import SequentialTaskRunner

# Define the task to load and modify data
@task(retries=1, name="Load and Modify Data")
def load_and_modify_data(data_dir: LocalFileSystem, load_and_modify_service: Secret):
    logger = get_run_logger()
    logger.info("Loading and modifying data...")
    container = DockerContainer(
        image="i2t-backendwithintertwino6-load-and-modify:latest",
        environment={
            "DATASET_ID": 2,
            "DATE_COLUMN": "installation_date",
            "TABLE_NAME_PREFIX": "JOT_"
        },
        docker_host=DockerHost(host="unix:///var/run/docker.sock"),
        volumes=[f"{data_dir.basepath}:/data"]
    )
    container.run()

# Define the task to reconcile geocoding
@task(retries=1, name="Reconcile Geocoding")
def reconcile_geocoding(reconciliation_service: Secret, here_api_token: Secret):
    logger = get_run_logger()
    logger.info("Reconciling geocoding...")
    container = DockerContainer(
        image="i2t-backendwithintertwino6-reconciliation:latest",
        environment={
            "PRIMARY_COLUMN": "location",
            "RECONCILIATOR_ID": "geocodingHere",
            "API_TOKEN": here_api_token.get(),
            "DATASET_ID": 2
        },
        docker_host=DockerHost(host="unix:///var/run/docker.sock")
    )
    container.run()

# Define the task to extend OpenMeteo data
@task(retries=1, name="Extend OpenMeteo Data")
def extend_openmeteo_data(openmeteo_service: Secret):
    logger = get_run_logger()
    logger.info("Extending OpenMeteo data...")
    container = DockerContainer(
        image="i2t-backendwithintertwino6-openmeteo-extension:latest",
        environment={
            "LAT_COLUMN": "latitude",
            "LON_COLUMN": "longitude",
            "DATE_COLUMN": "installation_date",
            "WEATHER_VARIABLES": "apparent_temperature_max,apparent_temperature_min,precipitation_sum,precipitation_hours",
            "DATE_SEPARATOR_FORMAT": "YYYYMMDD"
        },
        docker_host=DockerHost(host="unix:///var/run/docker.sock")
    )
    container.run()

# Define the task to extend land use data
@task(retries=1, name="Extend Land Use")
def extend_land_use(geoapify_land_use_api: Secret):
    logger = get_run_logger()
    logger.info("Extending land use data...")
    container = DockerContainer(
        image="geoapify-land-use:latest",
        environment={
            "LAT_COLUMN": "latitude",
            "LON_COLUMN": "longitude",
            "OUTPUT_COLUMN": "land_use_type",
            "API_KEY": geoapify_land_use_api.get()
        },
        docker_host=DockerHost(host="unix:///var/run/docker.sock")
    )
    container.run()

# Define the task to extend population density data
@task(retries=1, name="Extend Population Density")
def extend_population_density(worldpop_density_service: Secret):
    logger = get_run_logger()
    logger.info("Extending population density data...")
    container = DockerContainer(
        image="worldpop-density:latest",
        environment={
            "LAT_COLUMN": "latitude",
            "LON_COLUMN": "longitude",
            "OUTPUT_COLUMN": "population_density",
            "RADIUS": 5000
        },
        docker_host=DockerHost(host="unix:///var/run/docker.sock")
    )
    container.run()

# Define the task to extend environmental risk data
@task(retries=1, name="Extend Environmental Risk")
def extend_environmental_risk(column_extension_service: Secret):
    logger = get_run_logger()
    logger.info("Extending environmental risk data...")
    container = DockerContainer(
        image="i2t-backendwithintertwino6-column-extension:latest",
        environment={
            "EXTENDER_ID": "environmentalRiskCalculator",
            "INPUT_COLUMNS": "precipitation_sum,population_density,land_use_type",
            "OUTPUT_COLUMN": "risk_score",
            "CALCULATION_FORMULA": "[risk calculation parameters]"
        },
        docker_host=DockerHost(host="unix:///var/run/docker.sock")
    )
    container.run()

# Define the task to save final data
@task(retries=1, name="Save Final Data")
def save_final_data(save_service: Secret):
    logger = get_run_logger()
    logger.info("Saving final data...")
    container = DockerContainer(
        image="i2t-backendwithintertwino6-save:latest",
        environment={
            "DATASET_ID": 2
        },
        docker_host=DockerHost(host="unix:///var/run/docker.sock")
    )
    container.run()

# Define the flow
@flow(name="load_and_modify_data_pipeline", task_runner=SequentialTaskRunner)
def load_and_modify_data_pipeline(
    data_dir: LocalFileSystem,
    load_and_modify_service: Secret,
    reconciliation_service: Secret,
    here_api_token: Secret,
    openmeteo_service: Secret,
    geoapify_land_use_api: Secret,
    worldpop_density_service: Secret,
    column_extension_service: Secret,
    save_service: Secret
):
    load_and_modify_data(data_dir, load_and_modify_service)
    reconcile_geocoding(reconciliation_service, here_api_token)
    extend_openmeteo_data(openmeteo_service)
    extend_land_use(geoapify_land_use_api)
    extend_population_density(worldpop_density_service)
    extend_environmental_risk(column_extension_service)
    save_final_data(save_service)

# Example of how to run the flow
if __name__ == "__main__":
    data_dir = LocalFileSystem(basepath="/path/to/data")
    load_and_modify_service = Secret.load("load-and-modify-service")
    reconciliation_service = Secret.load("reconciliation-service")
    here_api_token = Secret.load("here-api-token")
    openmeteo_service = Secret.load("openmeteo-service")
    geoapify_land_use_api = Secret.load("geoapify-land-use-api")
    worldpop_density_service = Secret.load("worldpop-density-service")
    column_extension_service = Secret.load("column-extension-service")
    save_service = Secret.load("save-service")

    load_and_modify_data_pipeline(
        data_dir,
        load_and_modify_service,
        reconciliation_service,
        here_api_token,
        openmeteo_service,
        geoapify_land_use_api,
        worldpop_density_service,
        column_extension_service,
        save_service
    )