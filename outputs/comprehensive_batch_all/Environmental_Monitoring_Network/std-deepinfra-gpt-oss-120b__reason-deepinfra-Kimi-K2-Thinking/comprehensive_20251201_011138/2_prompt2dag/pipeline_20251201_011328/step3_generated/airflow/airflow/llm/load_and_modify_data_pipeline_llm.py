# Generated by Airflow DAG Generator on 2024-06-28
# DAG: load_and_modify_data_pipeline
# Description: Sequential pipeline that loads data, performs geocoding, enriches with weather,
# land use, population density, calculates environmental risk, and saves the final dataset.

import datetime
from datetime import timedelta

from airflow import DAG
from airflow.utils.dates import days_ago
from airflow.providers.docker.operators.docker import DockerOperator, Mount

# Default arguments applied to all tasks
default_args = {
    "owner": "airflow",
    "depends_on_past": False,
    "retries": 1,
    "retry_delay": timedelta(minutes=5),
    "email_on_failure": False,
    "email_on_retry": False,
}

# Common Docker configuration
DOCKER_CONN_ID = "docker_default"          # Airflow connection for Docker daemon
NETWORK_MODE = "app_network"               # Custom Docker network defined in resources
DATA_VOLUME = Mount(source="data_dir_volume", target="/data", type="volume")  # Shared data directory

with DAG(
    dag_id="load_and_modify_data_pipeline",
    default_args=default_args,
    description="Sequential pipeline that loads data, enriches it, calculates risk, and saves the result.",
    schedule_interval=None,                # Disabled schedule
    start_date=days_ago(1),
    catchup=False,
    tags=["sequential", "docker"],
    max_active_runs=1,
) as dag:

    # -------------------------------------------------------------------------
    # Task: Load and Modify Data
    # -------------------------------------------------------------------------
    load_and_modify_data = DockerOperator(
        task_id="load_and_modify_data",
        image="i2t-backendwithintertwino6-load-and-modify:latest",
        api_version="auto",
        auto_remove=True,
        docker_url="unix://var/run/docker.sock",
        network_mode=NETWORK_MODE,
        mounts=[DATA_VOLUME],
        environment={
            "DATASET_ID": "2",
            "DATE_COLUMN": "installation_date",
            "TABLE_NAME_PREFIX": "JOT_",
        },
        retries=1,
        retry_delay=timedelta(minutes=5),
        dag=dag,
    )

    # -------------------------------------------------------------------------
    # Task: Geocode Reconciliation
    # -------------------------------------------------------------------------
    geocode_reconciliation = DockerOperator(
        task_id="geocode_reconciliation",
        image="i2t-backendwithintertwino6-reconciliation:latest",
        api_version="auto",
        auto_remove=True,
        docker_url="unix://var/run/docker.sock",
        network_mode=NETWORK_MODE,
        mounts=[DATA_VOLUME],
        environment={
            "PRIMARY_COLUMN": "location",
            "RECONCILIATOR_ID": "geocodingHere",
            "API_TOKEN": "[HERE API token]",
            "DATASET_ID": "2",
        },
        retries=1,
        retry_delay=timedelta(minutes=5),
        dag=dag,
    )

    # -------------------------------------------------------------------------
    # Task: OpenMeteo Data Extension
    # -------------------------------------------------------------------------
    open_meteo_extension = DockerOperator(
        task_id="open_meteo_extension",
        image="i2t-backendwithintertwino6-openmeteo-extension:latest",
        api_version="auto",
        auto_remove=True,
        docker_url="unix://var/run/docker.sock",
        network_mode=NETWORK_MODE,
        mounts=[DATA_VOLUME],
        environment={
            "LAT_COLUMN": "latitude",
            "LON_COLUMN": "longitude",
            "DATE_COLUMN": "installation_date",
            "WEATHER_VARIABLES": "apparent_temperature_max,apparent_temperature_min,precipitation_sum,precipitation_hours",
            "DATE_SEPARATOR_FORMAT": "YYYYMMDD",
        },
        retries=1,
        retry_delay=timedelta(minutes=5),
        dag=dag,
    )

    # -------------------------------------------------------------------------
    # Task: Land Use Extension
    # -------------------------------------------------------------------------
    land_use_extension = DockerOperator(
        task_id="land_use_extension",
        image="geoapify-land-use:latest",
        api_version="auto",
        auto_remove=True,
        docker_url="unix://var/run/docker.sock",
        network_mode=NETWORK_MODE,
        mounts=[DATA_VOLUME],
        environment={
            "LAT_COLUMN": "latitude",
            "LON_COLUMN": "longitude",
            "OUTPUT_COLUMN": "land_use_type",
            "API_KEY": "[Geoapify API key]",
        },
        retries=1,
        retry_delay=timedelta(minutes=5),
        dag=dag,
    )

    # -------------------------------------------------------------------------
    # Task: Population Density Extension
    # -------------------------------------------------------------------------
    population_density_extension = DockerOperator(
        task_id="population_density_extension",
        image="worldpop-density:latest",
        api_version="auto",
        auto_remove=True,
        docker_url="unix://var/run/docker.sock",
        network_mode=NETWORK_MODE,
        mounts=[DATA_VOLUME],
        environment={
            "LAT_COLUMN": "latitude",
            "LON_COLUMN": "longitude",
            "OUTPUT_COLUMN": "population_density",
            "RADIUS": "5000",
        },
        retries=1,
        retry_delay=timedelta(minutes=5),
        dag=dag,
    )

    # -------------------------------------------------------------------------
    # Task: Environmental Risk Calculation
    # -------------------------------------------------------------------------
    environmental_risk_calculation = DockerOperator(
        task_id="environmental_risk_calculation",
        image="i2t-backendwithintertwino6-column-extension:latest",
        api_version="auto",
        auto_remove=True,
        docker_url="unix://var/run/docker.sock",
        network_mode=NETWORK_MODE,
        mounts=[DATA_VOLUME],
        environment={
            "EXTENDER_ID": "environmentalRiskCalculator",
            "INPUT_COLUMNS": "precipitation_sum,population_density,land_use_type",
            "OUTPUT_COLUMN": "risk_score",
            "CALCULATION_FORMULA": "[risk calculation parameters]",
        },
        retries=1,
        retry_delay=timedelta(minutes=5),
        dag=dag,
    )

    # -------------------------------------------------------------------------
    # Task: Save Final Data
    # -------------------------------------------------------------------------
    save_final_data = DockerOperator(
        task_id="save_final_data",
        image="i2t-backendwithintertwino6-save:latest",
        api_version="auto",
        auto_remove=True,
        docker_url="unix://var/run/docker.sock",
        network_mode=NETWORK_MODE,
        mounts=[DATA_VOLUME],
        environment={
            "DATASET_ID": "2",
        },
        retries=1,
        retry_delay=timedelta(minutes=5),
        dag=dag,
    )

    # -------------------------------------------------------------------------
    # Define task dependencies (sequential flow)
    # -------------------------------------------------------------------------
    load_and_modify_data >> geocode_reconciliation >> open_meteo_extension \
        >> land_use_extension >> population_density_extension \
        >> environmental_risk_calculation >> save_final_data

# End of DAG definition.