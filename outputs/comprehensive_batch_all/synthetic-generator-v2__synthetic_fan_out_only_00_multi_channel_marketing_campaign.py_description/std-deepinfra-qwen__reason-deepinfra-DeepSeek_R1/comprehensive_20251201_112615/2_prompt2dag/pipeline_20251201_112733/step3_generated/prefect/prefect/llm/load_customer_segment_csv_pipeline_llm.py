# Generated by Prefect 2.x Code Generator
# Date: 2023-10-05
# Prefect Version: 2.14.0

from prefect import flow, task, get_run_logger
from prefect.task_runners import ConcurrentTaskRunner
from prefect.deployments import Deployment
from prefect.filesystems import LocalFileSystem
from prefect.blocks.system import Secret
from prefect.infrastructure.docker import DockerContainer
from prefect.infrastructure.process import Process
import os

# Load connections/resources
local_filesystem = LocalFileSystem.load("local_filesystem")
email_delivery_system = Secret.load("email_delivery_system")
sms_gateway = Secret.load("sms_gateway")
push_notification_service = Secret.load("push_notification_service")

@task(retries=2, name="Load Customer Segment CSV")
def load_customer_segment_csv():
    logger = get_run_logger()
    logger.info("Loading customer segment CSV from local filesystem...")
    # Simulate loading CSV
    csv_path = os.path.join(local_filesystem.basepath, "customer_segment.csv")
    with open(csv_path, "r") as file:
        data = file.read()
    logger.info("CSV loaded successfully.")
    return data

@task(retries=2, name="Send Email Campaign")
def send_email_campaign(data):
    logger = get_run_logger()
    logger.info("Sending email campaign...")
    # Simulate sending email campaign
    email_delivery_system_value = email_delivery_system.get()
    logger.info(f"Email campaign sent using {email_delivery_system_value}.")
    return True

@task(retries=2, name="Send SMS Campaign")
def send_sms_campaign(data):
    logger = get_run_logger()
    logger.info("Sending SMS campaign...")
    # Simulate sending SMS campaign
    sms_gateway_value = sms_gateway.get()
    logger.info(f"SMS campaign sent using {sms_gateway_value}.")
    return True

@task(retries=2, name="Send Push Notification")
def send_push_notification(data):
    logger = get_run_logger()
    logger.info("Sending push notification...")
    # Simulate sending push notification
    push_notification_service_value = push_notification_service.get()
    logger.info(f"Push notification sent using {push_notification_service_value}.")
    return True

@flow(name="load_customer_segment_csv_pipeline", task_runner=ConcurrentTaskRunner(), schedule="0 0 * * *", timezone="UTC", catchup=False)
def load_customer_segment_csv_pipeline():
    logger = get_run_logger()
    logger.info("Starting load_customer_segment_csv_pipeline...")

    # Load customer segment CSV
    data = load_customer_segment_csv()

    # Fan out to send email, SMS, and push notification campaigns
    send_email_campaign.submit(data)
    send_sms_campaign.submit(data)
    send_push_notification.submit(data)

    logger.info("load_customer_segment_csv_pipeline completed successfully.")

# Create deployment
deployment = Deployment.build_from_flow(
    flow=load_customer_segment_csv_pipeline,
    name="load_customer_segment_csv_pipeline_deployment",
    work_pool_name="default-agent-pool",
    work_queue_name="default",
    parameters={},
    tags=[],
    version="1.0",
    description="No description provided.",
    schedule="0 0 * * *",
    timezone="UTC",
    catchup=False,
    infra_overrides={"env": {"PREFECT_LOGGING_LEVEL": "INFO"}},
)

if __name__ == "__main__":
    deployment.apply()