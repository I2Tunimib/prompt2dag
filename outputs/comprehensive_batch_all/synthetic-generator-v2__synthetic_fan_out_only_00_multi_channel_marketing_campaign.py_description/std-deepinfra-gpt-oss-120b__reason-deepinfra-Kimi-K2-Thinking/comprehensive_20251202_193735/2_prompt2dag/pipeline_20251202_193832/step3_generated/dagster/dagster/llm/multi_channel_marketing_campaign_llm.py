# Generated by Dagster code generator on 2024-06-28
# Pipeline: multi_channel_marketing_campaign
# Description: Executes a multi-channel marketing campaign by loading customer segment data and triggering parallel email, SMS, and push notification campaigns.

from __future__ import annotations

import csv
import logging
from pathlib import Path
from typing import List, Dict

from dagster import (
    op,
    job,
    In,
    Out,
    RetryPolicy,
    ConfigurableResource,
    ResourceDefinition,
    fs_io_manager,
    multiprocess_executor,
    ScheduleDefinition,
    Definitions,
)

logger = logging.getLogger(__name__)


class LocalCustomerSegmentFilesystem(ConfigurableResource):
    """Resource for accessing the local filesystem where customer segment CSV files are stored."""

    base_path: str = "./data"

    def get_path(self, filename: str) -> Path:
        """Return the absolute path to a file within the base directory."""
        return Path(self.base_path) / filename


class EmailDeliveryAPI(ConfigurableResource):
    """Placeholder resource for an email delivery service API."""

    api_key: str

    def send_email(self, recipient: str, subject: str, body: str) -> None:
        """Send an email to a single recipient."""
        logger.info(f"Sending email to {recipient}: {subject}")
        # Insert real API call here


class SmsGatewayAPI(ConfigurableResource):
    """Placeholder resource for an SMS gateway service API."""

    api_key: str

    def send_sms(self, phone_number: str, message: str) -> None:
        """Send an SMS to a single phone number."""
        logger.info(f"Sending SMS to {phone_number}")
        # Insert real API call here


class PushNotificationAPI(ConfigurableResource):
    """Placeholder resource for a push notification service API."""

    api_key: str

    def send_push(self, device_token: str, title: str, body: str) -> None:
        """Send a push notification to a single device."""
        logger.info(f"Sending push notification to {device_token}")
        # Insert real API call here


@op(
    name="load_customer_segment_csv",
    description="Load customer segment data from a CSV file.",
    out=Out(List[Dict[str, str]]),
    retry_policy=RetryPolicy(max_retries=2),
    required_resource_keys={"local_customer_segment_filesystem"},
)
def load_customer_segment_csv(context) -> List[Dict[str, str]]:
    """Read a CSV file containing customer segment information.

    Returns:
        A list of dictionaries where each dict represents a customer record.
    """
    fs: LocalCustomerSegmentFilesystem = context.resources.local_customer_segment_filesystem
    csv_path = fs.get_path("customer_segment.csv")

    if not csv_path.is_file():
        raise FileNotFoundError(f"Customer segment file not found at {csv_path}")

    with csv_path.open(newline="", encoding="utf-8") as csvfile:
        reader = csv.DictReader(csvfile)
        customers = [row for row in reader]

    logger.info(f"Loaded {len(customers)} customer records from {csv_path}")
    return customers


@op(
    name="send_email_campaign",
    description="Send email campaign to the loaded customer segment.",
    ins={"customers": In(List[Dict[str, str]])},
    retry_policy=RetryPolicy(max_retries=2),
    required_resource_keys={"email_delivery_api"},
)
def send_email_campaign(context, customers: List[Dict[str, str]]) -> None:
    """Iterate over customers and send an email using the EmailDeliveryAPI resource."""
    email_api: EmailDeliveryAPI = context.resources.email_delivery_api
    subject = "Our Latest Offer"
    body_template = "Hello {first_name}, check out our new products!"

    for customer in customers:
        recipient = customer.get("email")
        if not recipient:
            logger.warning(f"Skipping record without email: {customer}")
            continue
        body = body_template.format(first_name=customer.get("first_name", "Customer"))
        email_api.send_email(recipient=recipient, subject=subject, body=body)


@op(
    name="send_sms_campaign",
    description="Send SMS campaign to the loaded customer segment.",
    ins={"customers": In(List[Dict[str, str]])},
    retry_policy=RetryPolicy(max_retries=2),
    required_resource_keys={"sms_gateway_api"},
)
def send_sms_campaign(context, customers: List[Dict[str, str]]) -> None:
    """Iterate over customers and send an SMS using the SmsGatewayAPI resource."""
    sms_api: SmsGatewayAPI = context.resources.sms_gateway_api
    message_template = "Hi {first_name}, don't miss our latest deals!"

    for customer in customers:
        phone = customer.get("phone_number")
        if not phone:
            logger.warning(f"Skipping record without phone number: {customer}")
            continue
        message = message_template.format(first_name=customer.get("first_name", "Customer"))
        sms_api.send_sms(phone_number=phone, message=message)


@op(
    name="send_push_notification",
    description="Send push notification campaign to the loaded customer segment.",
    ins={"customers": In(List[Dict[str, str]])},
    retry_policy=RetryPolicy(max_retries=2),
    required_resource_keys={"push_notification_api"},
)
def send_push_notification(context, customers: List[Dict[str, str]]) -> None:
    """Iterate over customers and send a push notification using the PushNotificationAPI resource."""
    push_api: PushNotificationAPI = context.resources.push_notification_api
    title = "New Promotion"
    body_template = "Hey {first_name}, check out what's new!"

    for customer in customers:
        token = customer.get("device_token")
        if not token:
            logger.warning(f"Skipping record without device token: {customer}")
            continue
        body = body_template.format(first_name=customer.get("first_name", "Customer"))
        push_api.send_push(device_token=token, title=title, body=body)


@job(
    name="multi_channel_marketing_campaign",
    description="Executes a multi-channel marketing campaign by loading customer segment data and triggering parallel email, SMS, and push notification campaigns.",
    executor_def=multiprocess_executor,
    resource_defs={
        "local_customer_segment_filesystem": LocalCustomerSegmentFilesystem(),
        "email_delivery_api": EmailDeliveryAPI(api_key="YOUR_EMAIL_API_KEY"),
        "sms_gateway_api": SmsGatewayAPI(api_key="YOUR_SMS_API_KEY"),
        "push_notification_api": PushNotificationAPI(api_key="YOUR_PUSH_API_KEY"),
        "io_manager": fs_io_manager,
    },
    # The default retry policy is defined per op; no global retry needed.
)
def multi_channel_marketing_campaign():
    customers = load_customer_segment_csv()
    # Fan‑out to the three campaign ops in parallel
    send_email_campaign(customers)
    send_sms_campaign(customers)
    send_push_notification(customers)


daily_schedule = ScheduleDefinition(
    job=multi_channel_marketing_campaign,
    cron_schedule="@daily",
    execution_timezone="UTC",
    description="Daily execution of the multi‑channel marketing campaign.",
    default_status="RUNNING",  # Enabled
    catchup=False,
)


defs = Definitions(
    jobs=[multi_channel_marketing_campaign],
    schedules=[daily_schedule],
    resources={
        "local_customer_segment_filesystem": LocalCustomerSegmentFilesystem(),
        "email_delivery_api": EmailDeliveryAPI(api_key="YOUR_EMAIL_API_KEY"),
        "sms_gateway_api": SmsGatewayAPI(api_key="YOUR_SMS_API_KEY"),
        "push_notification_api": PushNotificationAPI(api_key="YOUR_PUSH_API_KEY"),
        "io_manager": fs_io_manager,
    },
)