# Generated by Dagster Pipeline Generator
# Date: 2024-06-13
# Pipeline: load_customer_segment_csv_pipeline
# Description: Comprehensive Pipeline Description

from typing import Any, List, Dict

import pandas as pd
from dagster import (
    op,
    job,
    In,
    Out,
    RetryPolicy,
    ResourceDefinition,
    fs_io_manager,
    ConfigurableResource,
    InitResourceContext,
    get_dagster_logger,
    ScheduleDefinition,
    ScheduleStatus,
    multiprocess_executor,
)


# ----------------------------------------------------------------------
# Resource Definitions
# ----------------------------------------------------------------------


class EmailDeliveryAPI(ConfigurableResource):
    """Placeholder resource for an email delivery service."""

    api_key: str

    def send_email(self, recipients: List[str], subject: str, body: str) -> None:
        logger = get_dagster_logger()
        logger.info(
            f"Sending email to {recipients} with subject '{subject}'. (API key: {self.api_key})"
        )
        # Insert real email sending logic here.


class SmsGatewayAPI(ConfigurableResource):
    """Placeholder resource for an SMS gateway service."""

    api_token: str

    def send_sms(self, phone_numbers: List[str], message: str) -> None:
        logger = get_dagster_logger()
        logger.info(
            f"Sending SMS to {phone_numbers}: '{message}'. (Token: {self.api_token})"
        )
        # Insert real SMS sending logic here.


class PushNotificationAPI(ConfigurableResource):
    """Placeholder resource for a push notification service."""

    endpoint: str

    def send_push(self, device_ids: List[str], title: str, body: str) -> None:
        logger = get_dagster_logger()
        logger.info(
            f"Sending push notification to {device_ids} with title '{title}'. (Endpoint: {self.endpoint})"
        )
        # Insert real push notification logic here.


# ----------------------------------------------------------------------
# Ops
# ----------------------------------------------------------------------


@op(
    name="load_customer_segment_csv",
    description="Load a customer segment CSV file from the local filesystem.",
    out=Out(dagster_type=List[Dict[str, Any]]),
    retry_policy=RetryPolicy(max_retries=2, delay=5),
)
def load_customer_segment_csv(context) -> List[Dict[str, Any]]:
    """
    Reads a CSV file containing customer segment data using the filesystem IO manager.
    Returns a list of dictionaries, each representing a row.
    """
    # The path can be parameterized via op config; here we use a static example.
    csv_path = "data/customer_segment.csv"
    logger = context.log
    logger.info(f"Loading customer segment CSV from {csv_path}")

    # Use pandas for simplicity; in a real job you might stream or use a custom loader.
    df = pd.read_csv(csv_path)
    records = df.to_dict(orient="records")
    logger.info(f"Loaded {len(records)} records from CSV.")
    return records


@op(
    name="send_email_campaign",
    description="Send an email campaign to the loaded customer segment.",
    ins={"customer_data": In(dagster_type=List[Dict[str, Any]])},
    retry_policy=RetryPolicy(max_retries=2, delay=5),
)
def send_email_campaign(context, customer_data: List[Dict[str, Any]]) -> None:
    """
    Sends an email to each customer in the segment using the EmailDeliveryAPI resource.
    """
    email_api: EmailDeliveryAPI = context.resources.email_delivery_api
    logger = context.log

    # Extract email addresses; adjust key name based on CSV schema.
    recipients = [row["email"] for row in customer_data if "email" in row]
    subject = "Special Offer Just for You!"
    body = "Dear customer, we have an exclusive offer..."

    logger.info(f"Preparing to send email to {len(recipients)} recipients.")
    email_api.send_email(recipients=recipients, subject=subject, body=body)


@op(
    name="send_push_notification",
    description="Send a push notification campaign to the loaded customer segment.",
    ins={"customer_data": In(dagster_type=List[Dict[str, Any]])},
    retry_policy=RetryPolicy(max_retries=2, delay=5),
)
def send_push_notification(context, customer_data: List[Dict[str, Any]]) -> None:
    """
    Sends a push notification to each device in the segment using the PushNotificationAPI resource.
    """
    push_api: PushNotificationAPI = context.resources.push_notification_api
    logger = context.log

    # Extract device IDs; adjust key name based on CSV schema.
    device_ids = [row["device_id"] for row in customer_data if "device_id" in row]
    title = "New Promotion!"
    body = "Check out our latest deals now."

    logger.info(f"Preparing to send push notifications to {len(device_ids)} devices.")
    push_api.send_push(device_ids=device_ids, title=title, body=body)


@op(
    name="send_sms_campaign",
    description="Send an SMS campaign to the loaded customer segment.",
    ins={"customer_data": In(dagster_type=List[Dict[str, Any]])},
    retry_policy=RetryPolicy(max_retries=2, delay=5),
)
def send_sms_campaign(context, customer_data: List[Dict[str, Any]]) -> None:
    """
    Sends an SMS message to each phone number in the segment using the SmsGatewayAPI resource.
    """
    sms_api: SmsGatewayAPI = context.resources.sms_gateway_api
    logger = context.log

    # Extract phone numbers; adjust key name based on CSV schema.
    phone_numbers = [row["phone"] for row in customer_data if "phone" in row]
    message = "Exclusive offer: Visit our store today and get 20% off!"

    logger.info(f"Preparing to send SMS to {len(phone_numbers)} phone numbers.")
    sms_api.send_sms(phone_numbers=phone_numbers, message=message)


# ----------------------------------------------------------------------
# Job Definition
# ----------------------------------------------------------------------


@job(
    name="load_customer_segment_csv_pipeline",
    description="Comprehensive Pipeline Description",
    executor_def=multiprocess_executor,
    resource_defs={
        "local_csv_filesystem": fs_io_manager,
        "email_delivery_api": EmailDeliveryAPI,
        "sms_gateway_api": SmsGatewayAPI,
        "push_notification_api": PushNotificationAPI,
    },
    # The default IO manager is set to the filesystem manager.
    # This aligns with the connection "local_csv_filesystem: fs_io_manager".
    # If you need a custom IO manager, replace `fs_io_manager` with your implementation.
)
def load_customer_segment_csv_pipeline():
    """
    Orchestrates loading a customer segment CSV and fanâ€‘out to three parallel
    campaign delivery ops: email, push notification, and SMS.
    """
    customer_data = load_customer_segment_csv()
    send_email_campaign(customer_data)
    send_push_notification(customer_data)
    send_sms_campaign(customer_data)


# ----------------------------------------------------------------------
# Schedule (disabled by default)
# ----------------------------------------------------------------------


def _disabled_schedule():
    """
    Returns a ScheduleDefinition that is disabled (STOPPED) by default.
    """
    return ScheduleDefinition(
        job=load_customer_segment_csv_pipeline,
        cron_schedule=None,  # No cron expression provided.
        execution_timezone="UTC",
        default_status=ScheduleStatus.STOPPED,
        name="load_customer_segment_csv_schedule",
    )


# Export the schedule so Dagster can discover it, even though it is disabled.
load_customer_segment_csv_schedule = _disabled_schedule()