# Generated by Dagster Pipeline Generator
# Date: 2024-06-12
# Pipeline: load_customer_segment_csv_pipeline

from __future__ import annotations

import os
from typing import Any, List

import pandas as pd
from dagster import (
    ConfigurableResource,
    In,
    Out,
    RetryPolicy,
    ResourceDefinition,
    ScheduleDefinition,
    asset,
    job,
    op,
    multiprocess_executor,
    fs_io_manager,
)


class LocalCsvFsResource(ConfigurableResource):
    """Resource providing access to a local CSV file system."""

    base_path: str = "./data"

    def get_path(self, filename: str) -> str:
        """Return the absolute path for a given CSV filename."""
        return os.path.abspath(os.path.join(self.base_path, filename))


class EmailServiceResource(ConfigurableResource):
    """Placeholder resource for an email delivery service API."""

    api_key: str

    def send_email(self, recipient: str, subject: str, body: str) -> None:
        """Send an email. In production this would call the real API."""
        # Replace with real implementation
        print(f"Sending email to {recipient}: {subject}")


class SmsGatewayResource(ConfigurableResource):
    """Placeholder resource for an SMS gateway API."""

    api_key: str

    def send_sms(self, phone_number: str, message: str) -> None:
        """Send an SMS. In production this would call the real API."""
        # Replace with real implementation
        print(f"Sending SMS to {phone_number}: {message}")


class PushNotificationResource(ConfigurableResource):
    """Placeholder resource for a push notification service API."""

    api_key: str

    def send_push(self, device_id: str, title: str, body: str) -> None:
        """Send a push notification. In production this would call the real API."""
        # Replace with real implementation
        print(f"Sending push to {device_id}: {title}")


@op(
    out=Out(pd.DataFrame),
    retry_policy=RetryPolicy(max_retries=2, delay=5),
    description="Load a customer segment CSV file from the local file system.",
)
def load_customer_segment_csv(context) -> pd.DataFrame:
    """Read the CSV file defined in the resource and return a pandas DataFrame."""
    csv_resource: LocalCsvFsResource = context.resources.local_csv_fs
    csv_path = csv_resource.get_path("customer_segment.csv")
    context.log.info(f"Loading CSV from {csv_path}")

    if not os.path.exists(csv_path):
        raise FileNotFoundError(f"CSV file not found at {csv_path}")

    df = pd.read_csv(csv_path)
    context.log.info(f"Loaded {len(df)} records")
    return df


@op(
    ins={"customer_df": In(pd.DataFrame)},
    retry_policy=RetryPolicy(max_retries=2, delay=5),
    description="Send an email campaign to each customer in the segment.",
)
def send_email_campaign(context, customer_df: pd.DataFrame) -> None:
    """Iterate over the DataFrame and send an email to each customer."""
    email_service: EmailServiceResource = context.resources.email_service_api

    required_columns = {"email", "first_name"}
    if not required_columns.issubset(customer_df.columns):
        missing = required_columns - set(customer_df.columns)
        raise ValueError(f"Missing required columns for email campaign: {missing}")

    for _, row in customer_df.iterrows():
        recipient = row["email"]
        subject = "Special Offer Just for You"
        body = f"Hi {row['first_name']},\n\nCheck out our latest offers..."
        email_service.send_email(recipient, subject, body)
        context.log.debug(f"Email sent to {recipient}")


@op(
    ins={"customer_df": In(pd.DataFrame)},
    retry_policy=RetryPolicy(max_retries=2, delay=5),
    description="Send a push notification campaign to each customer in the segment.",
)
def send_push_notification(context, customer_df: pd.DataFrame) -> None:
    """Iterate over the DataFrame and send a push notification to each customer."""
    push_service: PushNotificationResource = context.resources.push_notification_service_api

    required_columns = {"device_id", "first_name"}
    if not required_columns.issubset(customer_df.columns):
        missing = required_columns - set(customer_df.columns)
        raise ValueError(f"Missing required columns for push notification: {missing}")

    for _, row in customer_df.iterrows():
        device_id = row["device_id"]
        title = "Exclusive Deal"
        body = f"Hey {row['first_name']}, don't miss our new promotion!"
        push_service.send_push(device_id, title, body)
        context.log.debug(f"Push notification sent to device {device_id}")


@op(
    ins={"customer_df": In(pd.DataFrame)},
    retry_policy=RetryPolicy(max_retries=2, delay=5),
    description="Send an SMS campaign to each customer in the segment.",
)
def send_sms_campaign(context, customer_df: pd.DataFrame) -> None:
    """Iterate over the DataFrame and send an SMS to each customer."""
    sms_gateway: SmsGatewayResource = context.resources.sms_gateway_api

    required_columns = {"phone_number", "first_name"}
    if not required_columns.issubset(customer_df.columns):
        missing = required_columns - set(customer_df.columns)
        raise ValueError(f"Missing required columns for SMS campaign: {missing}")

    for _, row in customer_df.iterrows():
        phone = row["phone_number"]
        message = f"Hi {row['first_name']}, check out our latest offers!"
        sms_gateway.send_sms(phone, message)
        context.log.debug(f"SMS sent to {phone}")


@job(
    executor_def=multiprocess_executor,
    resource_defs={
        "local_csv_fs": LocalCsvFsResource(),
        "email_service_api": EmailServiceResource(api_key="YOUR_EMAIL_API_KEY"),
        "sms_gateway_api": SmsGatewayResource(api_key="YOUR_SMS_API_KEY"),
        "push_notification_service_api": PushNotificationResource(api_key="YOUR_PUSH_API_KEY"),
        "io_manager": fs_io_manager,
    },
    description="No description provided.",
)
def load_customer_segment_csv_pipeline():
    """Orchestrates loading a CSV and broadcasting campaigns via email, SMS, and push."""
    customer_df = load_customer_segment_csv()
    send_email_campaign(customer_df)
    send_sms_campaign(customer_df)
    send_push_notification(customer_df)


# Schedule definition (disabled by default)
daily_schedule = ScheduleDefinition(
    job=load_customer_segment_csv_pipeline,
    cron_schedule="@daily",
    execution_timezone="UTC",
    name="load_customer_segment_csv_daily_schedule",
    description="Daily schedule for the load_customer_segment_csv_pipeline (disabled).",
    default_status="inactive",  # Disabled
    tags={"catchup": "false"},
)