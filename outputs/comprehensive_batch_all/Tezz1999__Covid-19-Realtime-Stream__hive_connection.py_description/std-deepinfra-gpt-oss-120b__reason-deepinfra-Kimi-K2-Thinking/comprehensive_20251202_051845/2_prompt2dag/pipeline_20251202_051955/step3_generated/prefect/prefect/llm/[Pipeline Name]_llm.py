# Generated by Prefect pipeline generator on 2024-06-28
# Prefect version: 2.14.0
# Pipeline: [pipeline_name]
# Description: Simple linear data pipeline that executes Hive database operations for COVID-19 realtime streaming data.

import os
import subprocess
from datetime import datetime

from prefect import flow, task
from prefect.task_runners import SequentialTaskRunner
from prefect.deployments import DeploymentSpec
from prefect.deployments.schedules import CronSchedule
from prefect.blocks.system import Secret


@task(name="Run System Check", retries=0)
def run_system_check() -> str:
    """
    Execute a system health check using a shell command.

    Returns:
        The standard output of the health check command.

    Raises:
        RuntimeError: If the command exits with a non‑zero status.
    """
    try:
        # Example placeholder command; replace with actual health‑check logic.
        result = subprocess.run(
            ["bash", "-c", "echo System check OK"],
            capture_output=True,
            text=True,
            check=True,
        )
        return result.stdout.strip()
    except subprocess.CalledProcessError as exc:
        raise RuntimeError(f"System check failed: {exc.stderr}") from exc


@task(name="Run Hive Script", retries=0)
def run_hive_script() -> str:
    """
    Run a Hive script using the Hive connection stored in a Prefect Secret block.

    Returns:
        The standard output of the Hive command.

    Raises:
        RuntimeError: If the Hive command exits with a non‑zero status.
    """
    # Load Hive connection string from the secret block named ``hive_local``.
    hive_secret = Secret.load("hive_local")
    hive_connection = hive_secret.get()

    # Pass the connection string to the Hive process via an environment variable.
    env = os.environ.copy()
    env["HIVE_CONN"] = hive_connection

    try:
        # Example placeholder Hive command; replace with the actual script execution.
        result = subprocess.run(
            ["hive", "-e", "SELECT 1"],
            env=env,
            capture_output=True,
            text=True,
            check=True,
        )
        return result.stdout.strip()
    except subprocess.CalledProcessError as exc:
        raise RuntimeError(f"Hive script execution failed: {exc.stderr}") from exc


@flow(
    name="[pipeline_name]",
    task_runner=SequentialTaskRunner(),
)
def covid_hive_pipeline() -> None:
    """
    Sequential pipeline that first runs a system check and then executes a Hive script.

    The ``run_hive_script`` task depends on the successful completion of ``run_system_check``.
    """
    # Run system check.
    system_check_output = run_system_check()

    # The output of the system check can be logged or used downstream if needed.
    # For now we simply pass control to the next task.
    hive_output = run_hive_script()

    # Optional: log results (Prefect automatically captures task returns).
    print(f"[{datetime.utcnow().isoformat()}] System check output: {system_check_output}")
    print(f"[{datetime.utcnow().isoformat()}] Hive script output: {hive_output}")


# Deployment configuration
DeploymentSpec(
    name="[pipeline_name]_deployment",
    flow=covid_hive_pipeline,
    schedule=CronSchedule(
        cron="00 1 * * *",
        timezone="UTC",
        catchup=False,
    ),
    work_pool_name="default-agent-pool",
    task_runner=SequentialTaskRunner(),
    tags=[],
)