# Generated by Dagster code generator on 2024-06-28
# This file defines the `load_and_modify_data_pipeline` Dagster job with Docker execution.

from typing import Any, Dict

from dagster import (
    IOManager,
    In,
    Out,
    RetryPolicy,
    ResourceDefinition,
    asset,
    job,
    op,
    resource,
    fs_io_manager,
    docker_executor,
)


# ----------------------------------------------------------------------
# Resource definitions
# ----------------------------------------------------------------------


@resource(required_resource_keys=set())
def load_and_modify_service_resource(_):
    """Placeholder for the Load‑and‑Modify Service API client."""
    class ServiceClient:
        def process(self, data: Dict[str, Any]) -> Dict[str, Any]:
            # Insert real API call logic here.
            return data

    return ServiceClient()


@resource(required_resource_keys=set())
def reconciliation_service_resource(_):
    """Placeholder for the Reconciliation Service API client."""
    class ServiceClient:
        def reconcile(self, data: Dict[str, Any]) -> Dict[str, Any]:
            # Insert real API call logic here.
            return data

    return ServiceClient()


@resource(required_resource_keys=set())
def here_geocoding_service_resource(_):
    """Placeholder for the HERE Geocoding API client."""
    class ServiceClient:
        def geocode(self, city_name: str) -> Dict[str, Any]:
            # Insert real API call logic here.
            return {"lat": 0.0, "lon": 0.0}

    return ServiceClient()


@resource(required_resource_keys=set())
def openmeteo_api_resource(_):
    """Placeholder for the OpenMeteo Weather API client."""
    class ServiceClient:
        def fetch_weather(self, lat: float, lon: float) -> Dict[str, Any]:
            # Insert real API call logic here.
            return {"temperature": 0.0, "precipitation": 0.0}

    return ServiceClient()


@resource(required_resource_keys=set())
def mongodb_resource(_):
    """Placeholder for a MongoDB client."""
    class MongoClient:
        def insert_one(self, collection: str, document: Dict[str, Any]) -> None:
            # Insert real MongoDB insertion logic here.
            pass

    return MongoClient()


@resource(required_resource_keys=set())
def intertwino_api_resource(_):
    """Placeholder for the Intertwino API client."""
    class ServiceClient:
        def enrich(self, data: Dict[str, Any]) -> Dict[str, Any]:
            # Insert real API call logic here.
            return data

    return ServiceClient()


@resource(required_resource_keys=set())
def app_network_resource(_):
    """Placeholder for a custom Docker network configuration."""
    return {"network_name": "app_network"}


# ----------------------------------------------------------------------
# Op definitions
# ----------------------------------------------------------------------


@op(
    name="load_and_modify_data",
    description="Loads raw data and applies initial modifications using the Load‑and‑Modify Service.",
    out=Out(dagster_type=Dict[str, Any]),
    required_resource_keys={"load_and_modify_service"},
    retry_policy=RetryPolicy(max_retries=1),
)
def load_and_modify_data(context) -> Dict[str, Any]:
    """Load raw data and apply initial transformations."""
    client = context.resources.load_and_modify_service
    raw_data = {"raw": "data"}  # Replace with actual loading logic.
    processed = client.process(raw_data)
    context.log.info("Loaded and modified data.")
    return processed


@op(
    name="reconcile_city_names",
    description="Reconciles city names using the Reconciliation Service.",
    ins={"data": In(dagster_type=Dict[str, Any])},
    out=Out(dagster_type=Dict[str, Any]),
    required_resource_keys={"reconciliation_service"},
    retry_policy=RetryPolicy(max_retries=1),
)
def reconcile_city_names(context, data: Dict[str, Any]) -> Dict[str, Any]:
    """Reconcile city names in the dataset."""
    client = context.resources.reconciliation_service
    reconciled = client.reconcile(data)
    context.log.info("City names reconciled.")
    return reconciled


@op(
    name="enrich_with_openmeteo",
    description="Enriches data with weather information from OpenMeteo.",
    ins={"data": In(dagster_type=Dict[str, Any])},
    out=Out(dagster_type=Dict[str, Any]),
    required_resource_keys={"openmeteo_api", "here_geocoding_service"},
    retry_policy=RetryPolicy(max_retries=1),
)
def enrich_with_openmeteo(context, data: Dict[str, Any]) -> Dict[str, Any]:
    """Add weather data for each city using OpenMeteo."""
    geocoder = context.resources.here_geocoding_service
    weather_api = context.resources.openmeteo_api

    enriched = {}
    for city, record in data.items():
        geo = geocoder.geocode(city)
        weather = weather_api.fetch_weather(geo["lat"], geo["lon"])
        enriched[city] = {**record, **weather}
    context.log.info("Data enriched with OpenMeteo weather.")
    return enriched


@op(
    name="extend_columns",
    description="Extends the dataset with additional columns via the Intertwino API.",
    ins={"data": In(dagster_type=Dict[str, Any])},
    out=Out(dagster_type=Dict[str, Any]),
    required_resource_keys={"intertwino_api"},
    retry_policy=RetryPolicy(max_retries=1),
)
def extend_columns(context, data: Dict[str, Any]) -> Dict[str, Any]:
    """Add extra columns to the dataset."""
    client = context.resources.intertwino_api
    extended = client.enrich(data)
    context.log.info("Columns extended using Intertwino API.")
    return extended


@op(
    name="save_final_data",
    description="Persists the final dataset to MongoDB.",
    ins={"data": In(dagster_type=Dict[str, Any])},
    out=Out(dagster_type=None),
    required_resource_keys={"mongodb"},
    retry_policy=RetryPolicy(max_retries=1),
)
def save_final_data(context, data: Dict[str, Any]) -> None:
    """Save the final dataset to MongoDB."""
    client = context.resources.mongodb
    for city, record in data.items():
        client.insert_one(collection="final_data", document=record)
    context.log.info("Final data saved to MongoDB.")


# ----------------------------------------------------------------------
# Job definition
# ----------------------------------------------------------------------


@job(
    name="load_and_modify_data_pipeline",
    description="No description provided.",
    resource_defs={
        "data_dir": fs_io_manager,
        "load_and_modify_service": load_and_modify_service_resource,
        "reconciliation_service": reconciliation_service_resource,
        "here_geocoding_service": here_geocoding_service_resource,
        "openmeteo_api": openmeteo_api_resource,
        "mongodb": mongodb_resource,
        "intertwino_api": intertwino_api_resource,
        "app_network": app_network_resource,
    },
    executor_def=docker_executor,
)
def load_and_modify_data_pipeline():
    """Sequential pipeline that loads, reconciles, enriches, extends, and saves data."""
    raw = load_and_modify_data()
    reconciled = reconcile_city_names(raw)
    enriched = enrich_with_openmeteo(reconciled)
    extended = extend_columns(enriched)
    save_final_data(extended)


# ----------------------------------------------------------------------
# Schedule (disabled)
# ----------------------------------------------------------------------


# The schedule is intentionally disabled per specification.
# To enable, uncomment and adjust the cron schedule as needed.

# from dagster import schedule
#
# @schedule(
#     cron_schedule="* * * * *",  # placeholder
#     job=load_and_modify_data_pipeline,
#     execution_timezone="UTC",
#     description="Scheduled execution of load_and_modify_data_pipeline.",
#     default_status="disabled",
# )
# def load_and_modify_data_schedule(_):
#     return {}