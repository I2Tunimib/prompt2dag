# Generated by Prefect Pipeline Generator
# Date: 2024-06-28
# Prefect version: 2.14.0
# Flow name: unnamed_pipeline
# Deployment name: unnamed_pipeline_deployment
# Work pool: default-agent-pool
# Task runner: SequentialTaskRunner

"""Unnamed pipeline Prefect flow.

This flow demonstrates a minimal setup with a single task that interacts with a
local filesystem block named ``data_dir_volume``. The task lists the files
available in the configured shared data directory.

The flow is configured to run with a SequentialTaskRunner and includes basic
error handling with retries.
"""

from __future__ import annotations

import os
from typing import List

from prefect import flow, task, get_run_logger
from prefect.task_runners import SequentialTaskRunner
from prefect.filesystems import LocalFileSystem
from prefect.exceptions import PrefectException


@task(
    retries=3,
    retry_delay_seconds=10,
    timeout_seconds=300,
    description="List files in the shared data directory volume.",
)
def list_files_in_data_dir() -> List[str]:
    """List files in the shared data directory volume.

    Returns:
        List[str]: A list of file paths found in the data directory.

    Raises:
        PrefectException: If the filesystem block cannot be loaded or the
            directory does not exist.
    """
    logger = get_run_logger()
    try:
        # Load the pre-registered LocalFileSystem block
        data_dir_block: LocalFileSystem = LocalFileSystem.load("data_dir_volume")
        logger.info("Loaded LocalFileSystem block 'data_dir_volume'.")
    except Exception as exc:
        raise PrefectException(
            "Failed to load LocalFileSystem block 'data_dir_volume'."
        ) from exc

    # Resolve the base path from the block configuration
    base_path = data_dir_block.basepath
    if not base_path:
        raise PrefectException(
            "The 'basepath' attribute of the 'data_dir_volume' block is not set."
        )

    logger.info("Scanning directory: %s", base_path)

    if not os.path.isdir(base_path):
        raise PrefectException(f"The path '{base_path}' is not a valid directory.")

    # Walk the directory and collect file paths
    file_paths: List[str] = []
    for root, _, files in os.walk(base_path):
        for file_name in files:
            full_path = os.path.join(root, file_name)
            file_paths.append(full_path)

    logger.info("Found %d file(s) in the data directory.", len(file_paths))
    return file_paths


@flow(
    name="unnamed_pipeline",
    description="No description provided.",
    task_runner=SequentialTaskRunner(),
)
def unnamed_pipeline_flow() -> List[str]:
    """Main flow for the unnamed pipeline.

    Returns:
        List[str]: The list of files discovered in the shared data directory.
    """
    logger = get_run_logger()
    logger.info("Starting unnamed_pipeline flow.")
    files = list_files_in_data_dir()
    logger.info("Flow completed. %d file(s) listed.", len(files))
    return files


if __name__ == "__main__":
    # Execute the flow locally when the script is run directly.
    unnamed_pipeline_flow()