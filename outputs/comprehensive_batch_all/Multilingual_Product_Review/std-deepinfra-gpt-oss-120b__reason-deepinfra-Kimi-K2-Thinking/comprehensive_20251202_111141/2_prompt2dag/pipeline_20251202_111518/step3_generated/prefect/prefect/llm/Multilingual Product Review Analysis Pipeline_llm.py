# Generated by Prefect Pipeline Generator
# Date: 2024-06-13
# Prefect version: 2.14.0
# Pipeline: Multilingual Product Review Analysis Pipeline

from prefect import flow, task
from prefect.task_runners import SequentialTaskRunner
from prefect_docker import DockerContainer
from prefect.filesystems import LocalFileSystem
from prefect.blocks.system import Secret


# Load infrastructure blocks
DATA_DIR_BLOCK = LocalFileSystem.load("data_dir_volume")
APP_NETWORK_BLOCK = Secret.load("app_network")


def _docker_task(
    image: str,
    command: str | None = None,
    env: dict | None = None,
    volumes: list | None = None,
    network: str | None = None,
) -> DockerContainer:
    """
    Helper to create a DockerContainer task with common configuration.

    Args:
        image: Docker image to run.
        command: Optional command to execute inside the container.
        env: Environment variables for the container.
        volumes: List of volume bindings (host_path:container_path).
        network: Docker network name.

    Returns:
        Configured DockerContainer task.
    """
    return DockerContainer(
        image=image,
        command=command,
        env=env,
        volumes=volumes,
        network=network,
        # The container will be removed after execution to keep the host clean.
        remove_container=True,
    )


@task(retries=1, description="Load and modify raw product reviews.")
def load_and_modify_reviews() -> str:
    """
    Executes the Docker image that loads raw reviews and applies any required
    modifications. The container writes its output to the shared data directory.

    Returns:
        Path (as string) to the modified reviews file inside the shared volume.
    """
    container = _docker_task(
        image="i2t-backendwithintertwino6-load-and-modify:latest",
        command="python /app/main.py",
        env={"DATA_DIR": "/data"},
        volumes=[f"{DATA_DIR_BLOCK.basepath}:/data"],
        network=APP_NETWORK_BLOCK.get(),
    )
    # The DockerContainer task returns the container logs; we assume the
    # container writes a file to /data and we return its path.
    container()
    return f"{DATA_DIR_BLOCK.basepath}/modified_reviews.json"


@task(retries=1, description="Detect language of each review.")
def detect_review_language(modified_reviews_path: str) -> str:
    """
    Runs language detection on the modified reviews.

    Args:
        modified_reviews_path: Path to the JSON file produced by the previous step.

    Returns:
        Path to a JSON file containing language annotations.
    """
    container = _docker_task(
        image="jmockit/language-detection",
        command="python /app/detect.py --input /data/modified_reviews.json --output /data/language_detected.json",
        env={"DATA_DIR": "/data"},
        volumes=[f"{DATA_DIR_BLOCK.basepath}:/data"],
        network=APP_NETWORK_BLOCK.get(),
    )
    container()
    return f"{DATA_DIR_BLOCK.basepath}/language_detected.json"


@task(retries=1, description="Perform sentiment analysis on reviews.")
def analyze_sentiment(language_detected_path: str) -> str:
    """
    Executes sentiment analysis using a HuggingFace transformer model.

    Args:
        language_detected_path: Path to the language‑annotated reviews file.

    Returns:
        Path to a JSON file with sentiment scores.
    """
    container = _docker_task(
        image="huggingface/transformers-inference",
        command="python /app/sentiment.py --input /data/language_detected.json --output /data/sentiment.json",
        env={"DATA_DIR": "/data"},
        volumes=[f"{DATA_DIR_BLOCK.basepath}:/data"],
        network=APP_NETWORK_BLOCK.get(),
    )
    container()
    return f"{DATA_DIR_BLOCK.basepath}/sentiment.json"


@task(retries=1, description="Extract key product features from reviews.")
def extract_review_features(sentiment_path: str) -> str:
    """
    Runs a column‑extension model to pull out salient product features.

    Args:
        sentiment_path: Path to the sentiment‑enriched reviews file.

    Returns:
        Path to a JSON file containing extracted features.
    """
    container = _docker_task(
        image="i2t-backendwithintertwino6-column-extension:latest",
        command="python /app/extract_features.py --input /data/sentiment.json --output /data/features.json",
        env={"DATA_DIR": "/data"},
        volumes=[f"{DATA_DIR_BLOCK.basepath}:/data"],
        network=APP_NETWORK_BLOCK.get(),
    )
    container()
    return f"{DATA_DIR_BLOCK.basepath}/features.json"


@task(retries=1, description="Persist the enriched review dataset.")
def save_enriched_reviews(features_path: str) -> str:
    """
    Persists the final enriched review dataset to the destination storage.

    Args:
        features_path: Path to the JSON file with extracted features.

    Returns:
        Confirmation message with the location of the saved dataset.
    """
    container = _docker_task(
        image="i2t-backendwithintertwino6-save:latest",
        command="python /app/save.py --input /data/features.json --dest /data/enriched_reviews.json",
        env={"DATA_DIR": "/data"},
        volumes=[f"{DATA_DIR_BLOCK.basepath}:/data"],
        network=APP_NETWORK_BLOCK.get(),
    )
    container()
    return f"Enriched reviews saved to {DATA_DIR_BLOCK.basepath}/enriched_reviews.json"


@flow(
    name="multilingual_product_review_analysis_pipeline",
    task_runner=SequentialTaskRunner(),
)
def multilingual_product_review_analysis_pipeline() -> str:
    """
    Orchestrates the multilingual product review analysis pipeline.

    The flow runs a series of Docker‑based tasks sequentially:
    1. Load and modify raw reviews.
    2. Detect the language of each review.
    3. Perform sentiment analysis.
    4. Extract key product features.
    5. Save the enriched review dataset.

    Returns:
        Path to the final enriched reviews file.
    """
    modified_path = load_and_modify_reviews()
    language_path = detect_review_language(modified_path)
    sentiment_path = analyze_sentiment(language_path)
    features_path = extract_review_features(sentiment_path)
    result = save_enriched_reviews(features_path)
    return result


if __name__ == "__main__":
    # Execute the flow locally for testing/debugging.
    final_output = multilingual_product_review_analysis_pipeline()
    print(final_output)