# Generated by Airflow DAG generator on 2024-06-28
# Multilingual Product Review Analysis Pipeline
# Description: Enriches product reviews with language verification, sentiment, and key feature extraction using LLM capabilities for deeper customer insight.

from datetime import datetime, timedelta

from airflow import DAG
from airflow.providers.docker.operators.docker import DockerOperator
from airflow.utils.trigger_rule import TriggerRule
from airflow.utils.email import send_email

# ----------------------------------------------------------------------
# Helper callbacks
# ----------------------------------------------------------------------
def task_failure_callback(context):
    """Send email on task failure."""
    dag_id = context.get("dag").dag_id
    task_id = context.get("task_instance").task_id
    execution_date = context.get("execution_date")
    log_url = context.get("task_instance").log_url

    subject = f"[Airflow] DAG {dag_id} - Task {task_id} Failed"
    html_content = f"""
    <p>Task <strong>{task_id}</strong> in DAG <strong>{dag_id}</strong> failed.</p>
    <p><strong>Execution date:</strong> {execution_date}</p>
    <p><strong>Log URL:</strong> <a href="{log_url}">{log_url}</a></p>
    """
    # Adjust the recipient list as needed
    send_email(to=["airflow-alerts@example.com"], subject=subject, html_content=html_content)


# ----------------------------------------------------------------------
# Default arguments
# ----------------------------------------------------------------------
default_args = {
    "owner": "airflow",
    "depends_on_past": False,
    "retries": 1,
    "retry_delay": timedelta(minutes=5),
    "on_failure_callback": task_failure_callback,
    "email_on_failure": False,
    "email_on_retry": False,
}

# ----------------------------------------------------------------------
# DAG definition
# ----------------------------------------------------------------------
with DAG(
    dag_id="multilingual_product_review_analysis",
    description="Enriches product reviews with language verification, sentiment, and key feature extraction using LLM capabilities for deeper customer insight.",
    default_args=default_args,
    schedule_interval=None,          # Disabled schedule
    start_date=datetime(2024, 1, 1),
    catchup=False,
    tags=["product_review", "nlp", "llm"],
    max_active_runs=1,
) as dag:

    # Common DockerOperator parameters
    docker_common_kwargs = {
        "auto_remove": True,
        "network_mode": "app_network",          # Custom Docker network
        "volumes": ["data_dir_volume:/data"],   # Shared data directory volume
        "docker_url": "unix://var/run/docker.sock",
        "api_version": "auto",
        "tty": True,
        "environment": {"PYTHONUNBUFFERED": "1"},
    }

    # ------------------------------------------------------------------
    # Task: Load and Modify Reviews
    # ------------------------------------------------------------------
    load_and_modify_reviews = DockerOperator(
        task_id="load_and_modify_reviews",
        image="i2t-backendwithintertwino6-load-and-modify:latest",
        command="python main.py /data/input /data/intermediate",
        **docker_common_kwargs,
    )

    # ------------------------------------------------------------------
    # Task: Detect Review Language
    # ------------------------------------------------------------------
    detect_review_language = DockerOperator(
        task_id="detect_review_language",
        image="jmockit/language-detection",
        command="python detect.py /data/intermediate /data/language_detected",
        **docker_common_kwargs,
    )

    # ------------------------------------------------------------------
    # Task: Sentiment Analysis
    # ------------------------------------------------------------------
    analyze_sentiment = DockerOperator(
        task_id="analyze_sentiment",
        image="huggingface/transformers-inference",
        command="python sentiment.py /data/language_detected /data/sentiment",
        **docker_common_kwargs,
    )

    # ------------------------------------------------------------------
    # Task: Extract Review Features
    # ------------------------------------------------------------------
    extract_review_features = DockerOperator(
        task_id="extract_review_features",
        image="i2t-backendwithintertwino6-column-extension:latest",
        command="python extract_features.py /data/sentiment /data/features",
        **docker_common_kwargs,
    )

    # ------------------------------------------------------------------
    # Task: Save Enriched Reviews
    # ------------------------------------------------------------------
    save_enriched_reviews = DockerOperator(
        task_id="save_enriched_reviews",
        image="i2t-backendwithintertwino6-save:latest",
        command="python save.py /data/features /data/output",
        **docker_common_kwargs,
    )

    # ------------------------------------------------------------------
    # Set task dependencies (sequential pipeline)
    # ------------------------------------------------------------------
    load_and_modify_reviews >> detect_review_language >> analyze_sentiment >> extract_review_features >> save_enriched_reviews

# End of DAG definition.