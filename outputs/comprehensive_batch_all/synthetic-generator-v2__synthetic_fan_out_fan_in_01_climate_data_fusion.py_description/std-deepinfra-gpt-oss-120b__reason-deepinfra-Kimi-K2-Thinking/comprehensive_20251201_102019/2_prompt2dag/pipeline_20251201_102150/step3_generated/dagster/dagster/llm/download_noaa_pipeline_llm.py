# Generated by Dagster Code Generator
# Date: 2024-06-28
# Pipeline: download_noaa_pipeline
# Description: No description provided.
# Executor: multiprocess_executor
# Resources: ftp_noaa, https_ecmwf, https_jma, https_metoffice, https_bom, local_filesystem (fs_io_manager)

from __future__ import annotations

from typing import Any, Dict, List

from dagster import (
    op,
    job,
    In,
    Out,
    RetryPolicy,
    ConfigurableResource,
    ResourceDefinition,
    fs_io_manager,
    multiprocess_executor,
    ScheduleDefinition,
    Definitions,
    get_dagster_logger,
)


# ----------------------------------------------------------------------
# Resource definitions
# ----------------------------------------------------------------------


class FTPNoaaResource(ConfigurableResource):
    """Placeholder resource for connecting to the NOAA FTP server."""

    host: str = "ftp.noaa.gov"
    username: str | None = None
    password: str | None = None

    def download(self, remote_path: str, local_path: str) -> str:
        logger = get_dagster_logger()
        logger.info(f"Downloading from NOAA FTP {remote_path} to {local_path}")
        # Insert real FTP download logic here.
        return local_path


class HTTPSResource(ConfigurableResource):
    """Generic HTTPS resource used for ECMWF, JMA, MetOffice and BOM endpoints."""

    base_url: str

    def download(self, endpoint: str, local_path: str) -> str:
        logger = get_dagster_logger()
        logger.info(f"Downloading from {self.base_url}{endpoint} to {local_path}")
        # Insert real HTTPS download logic here.
        return local_path


# ----------------------------------------------------------------------
# Ops
# ----------------------------------------------------------------------


@op(
    out=Out(str),
    retry_policy=RetryPolicy(max_retries=3, delay=5),
    description="Download BOM data via HTTPS.",
    required_resource_keys={"bom_https"},
)
def download_bom(context) -> str:
    """Download raw BOM data and return the local file path."""
    bom_resource: HTTPSResource = context.resources.bom_https
    local_path = "/tmp/bom_raw.dat"
    return bom_resource.download("/bom/data", local_path)


@op(
    out=Out(str),
    retry_policy=RetryPolicy(max_retries=3, delay=5),
    description="Download ECMWF data via HTTPS.",
    required_resource_keys={"ecmwf_https"},
)
def download_ecmwf(context) -> str:
    """Download raw ECMWF data and return the local file path."""
    ecmwf_resource: HTTPSResource = context.resources.ecmwf_https
    local_path = "/tmp/ecmwf_raw.dat"
    return ecmwf_resource.download("/ecmwf/data", local_path)


@op(
    out=Out(str),
    retry_policy=RetryPolicy(max_retries=3, delay=5),
    description="Download JMA data via HTTPS.",
    required_resource_keys={"jma_https"},
)
def download_jma(context) -> str:
    """Download raw JMA data and return the local file path."""
    jma_resource: HTTPSResource = context.resources.jma_https
    local_path = "/tmp/jma_raw.dat"
    return jma_resource.download("/jma/data", local_path)


@op(
    out=Out(str),
    retry_policy=RetryPolicy(max_retries=3, delay=5),
    description="Download MetOffice data via HTTPS.",
    required_resource_keys={"metoffice_https"},
)
def download_metoffice(context) -> str:
    """Download raw MetOffice data and return the local file path."""
    metoffice_resource: HTTPSResource = context.resources.metoffice_https
    local_path = "/tmp/metoffice_raw.dat"
    return metoffice_resource.download("/metoffice/data", local_path)


@op(
    out=Out(str),
    retry_policy=RetryPolicy(max_retries=3, delay=5),
    description="Download NOAA data via FTP.",
    required_resource_keys={"ftp_noaa"},
)
def download_noaa(context) -> str:
    """Download raw NOAA data and return the local file path."""
    ftp_resource: FTPNoaaResource = context.resources.ftp_noaa
    local_path = "/tmp/noaa_raw.dat"
    return ftp_resource.download("/noaa/data", local_path)


@op(
    ins={"raw_path": In(str)},
    out=Out(str),
    retry_policy=RetryPolicy(max_retries=3, delay=5),
    description="Normalize BOM raw data.",
)
def normalize_bom(context, raw_path: str) -> str:
    """Transform raw BOM data into a normalized format."""
    normalized_path = "/tmp/bom_normalized.parquet"
    logger = get_dagster_logger()
    logger.info(f"Normalizing BOM data from {raw_path} to {normalized_path}")
    # Insert real normalization logic here.
    return normalized_path


@op(
    ins={"raw_path": In(str)},
    out=Out(str),
    retry_policy=RetryPolicy(max_retries=3, delay=5),
    description="Normalize ECMWF raw data.",
)
def normalize_ecmwf(context, raw_path: str) -> str:
    """Transform raw ECMWF data into a normalized format."""
    normalized_path = "/tmp/ecmwf_normalized.parquet"
    logger = get_dagster_logger()
    logger.info(f"Normalizing ECMWF data from {raw_path} to {normalized_path}")
    # Insert real normalization logic here.
    return normalized_path


@op(
    ins={"raw_path": In(str)},
    out=Out(str),
    retry_policy=RetryPolicy(max_retries=3, delay=5),
    description="Normalize JMA raw data.",
)
def normalize_jma(context, raw_path: str) -> str:
    """Transform raw JMA data into a normalized format."""
    normalized_path = "/tmp/jma_normalized.parquet"
    logger = get_dagster_logger()
    logger.info(f"Normalizing JMA data from {raw_path} to {normalized_path}")
    # Insert real normalization logic here.
    return normalized_path


@op(
    ins={"raw_path": In(str)},
    out=Out(str),
    retry_policy=RetryPolicy(max_retries=3, delay=5),
    description="Normalize MetOffice raw data.",
)
def normalize_metoffice(context, raw_path: str) -> str:
    """Transform raw MetOffice data into a normalized format."""
    normalized_path = "/tmp/metoffice_normalized.parquet"
    logger = get_dagster_logger()
    logger.info(f"Normalizing MetOffice data from {raw_path} to {normalized_path}")
    # Insert real normalization logic here.
    return normalized_path


@op(
    ins={"raw_path": In(str)},
    out=Out(str),
    retry_policy=RetryPolicy(max_retries=3, delay=5),
    description="Normalize NOAA raw data.",
)
def normalize_noaa(context, raw_path: str) -> str:
    """Transform raw NOAA data into a normalized format."""
    normalized_path = "/tmp/noaa_normalized.parquet"
    logger = get_dagster_logger()
    logger.info(f"Normalizing NOAA data from {raw_path} to {normalized_path}")
    # Insert real normalization logic here.
    return normalized_path


@op(
    ins={
        "bom": In(str),
        "ecmwf": In(str),
        "jma": In(str),
        "metoffice": In(str),
        "noaa": In(str),
    },
    out=Out(str),
    retry_policy=RetryPolicy(max_retries=3, delay=5),
    description="Merge all normalized climate datasets into a single file.",
)
def merge_climate_data(
    context,
    bom: str,
    ecmwf: str,
    jma: str,
    metoffice: str,
    noaa: str,
) -> str:
    """Combine normalized climate data from all sources."""
    merged_path = "/tmp/merged_climate_data.parquet"
    logger = get_dagster_logger()
    logger.info(
        f"Merging datasets:\n"
        f"  BOM: {bom}\n"
        f"  ECMWF: {ecmwf}\n"
        f"  JMA: {jma}\n"
        f"  MetOffice: {metoffice}\n"
        f"  NOAA: {noaa}\n"
        f"into {merged_path}"
    )
    # Insert real merging logic here.
    return merged_path


# ----------------------------------------------------------------------
# Job definition
# ----------------------------------------------------------------------


@job(
    executor_def=multiprocess_executor,
    resource_defs={
        "ftp_noaa": FTPNoaaResource(),
        "ecmwf_https": HTTPSResource(base_url="https://ecmwf.int"),
        "jma_https": HTTPSResource(base_url="https://jma.go.jp"),
        "metoffice_https": HTTPSResource(base_url="https://metoffice.gov.uk"),
        "bom_https": HTTPSResource(base_url="https://bom.gov.au"),
        "io_manager": fs_io_manager,
    },
    description="No description provided.",
)
def download_noaa_pipeline():
    """Orchestrates downloading, normalizing, and merging climate data from multiple providers."""
    # Download steps
    bom_raw = download_bom()
    ecmwf_raw = download_ecmwf()
    jma_raw = download_jma()
    metoffice_raw = download_metoffice()
    noaa_raw = download_noaa()

    # Normalization steps (fanâ€‘in)
    bom_norm = normalize_bom(bom_raw)
    ecmwf_norm = normalize_ecmwf(ecmwf_raw)
    jma_norm = normalize_jma(jma_raw)
    metoffice_norm = normalize_metoffice(metoffice_raw)
    noaa_norm = normalize_noaa(noaa_raw)

    # Merge step
    merge_climate_data(
        bom=bom_norm,
        ecmwf=ecmwf_norm,
        jma=jma_norm,
        metoffice=metoffice_norm,
        noaa=noaa_norm,
    )


# ----------------------------------------------------------------------
# Schedule definition
# ----------------------------------------------------------------------


daily_download_schedule = ScheduleDefinition(
    job=download_noaa_pipeline,
    cron_schedule="@daily",
    execution_timezone="UTC",
    name="download_noaa_daily_schedule",
    description="Runs the download_noaa_pipeline once per day at midnight UTC.",
    default_status="RUNNING",  # Enabled
    tags={"catchup": "false"},
)


# ----------------------------------------------------------------------
# Definitions (for Dagster UI / CLI)
# ----------------------------------------------------------------------


defs = Definitions(
    jobs=[download_noaa_pipeline],
    schedules=[daily_download_schedule],
    resources={
        "ftp_noaa": FTPNoaaResource(),
        "ecmwf_https": HTTPSResource(base_url="https://ecmwf.int"),
        "jma_https": HTTPSResource(base_url="https://jma.go.jp"),
        "metoffice_https": HTTPSResource(base_url="https://metoffice.gov.uk"),
        "bom_https": HTTPSResource(base_url="https://bom.gov.au"),
        "io_manager": fs_io_manager,
    },
)