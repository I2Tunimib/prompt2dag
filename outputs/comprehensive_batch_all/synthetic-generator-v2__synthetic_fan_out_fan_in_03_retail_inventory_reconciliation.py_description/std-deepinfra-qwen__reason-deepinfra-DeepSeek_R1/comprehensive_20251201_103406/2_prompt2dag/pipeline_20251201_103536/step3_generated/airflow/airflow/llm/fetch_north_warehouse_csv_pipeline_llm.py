# Generated by Airflow DAG Generator
# Date: 2023-10-05
# Pipeline: fetch_north_warehouse_csv_pipeline
# Description: No description provided.
# Pattern: fanin

from airflow import DAG
from airflow.operators.python import PythonOperator
from airflow.utils.dates import days_ago
from airflow.models import XCom
from datetime import timedelta
import requests

# Default arguments for the DAG
default_args = {
    'owner': 'airflow',
    'depends_on_past': False,
    'email_on_failure': False,
    'email_on_retry': False,
    'retries': 2,
    'retry_delay': timedelta(minutes=5),
}

# Define the DAG
with DAG(
    'fetch_north_warehouse_csv_pipeline',
    default_args=default_args,
    description='Fetch and reconcile warehouse CSVs',
    schedule_interval='@daily',
    start_date=days_ago(1),
    catchup=False,
    tags=['warehouse', 'csv', 'reconciliation'],
) as dag:

    # Task to fetch CSV from East Warehouse
    def fetch_east_warehouse_csv(**kwargs):
        response = requests.get('http://east_warehouse_api/csv')
        if response.status_code == 200:
            return response.text
        else:
            raise Exception(f"Failed to fetch CSV from East Warehouse: {response.status_code}")

    fetch_east_warehouse_csv_task = PythonOperator(
        task_id='fetch_east_warehouse_csv',
        python_callable=fetch_east_warehouse_csv,
        provide_context=True,
    )

    # Task to fetch CSV from North Warehouse
    def fetch_north_warehouse_csv(**kwargs):
        response = requests.get('http://north_warehouse_api/csv')
        if response.status_code == 200:
            return response.text
        else:
            raise Exception(f"Failed to fetch CSV from North Warehouse: {response.status_code}")

    fetch_north_warehouse_csv_task = PythonOperator(
        task_id='fetch_north_warehouse_csv',
        python_callable=fetch_north_warehouse_csv,
        provide_context=True,
    )

    # Task to fetch CSV from South Warehouse
    def fetch_south_warehouse_csv(**kwargs):
        response = requests.get('http://south_warehouse_api/csv')
        if response.status_code == 200:
            return response.text
        else:
            raise Exception(f"Failed to fetch CSV from South Warehouse: {response.status_code}")

    fetch_south_warehouse_csv_task = PythonOperator(
        task_id='fetch_south_warehouse_csv',
        python_callable=fetch_south_warehouse_csv,
        provide_context=True,
    )

    # Task to fetch CSV from West Warehouse
    def fetch_west_warehouse_csv(**kwargs):
        response = requests.get('http://west_warehouse_api/csv')
        if response.status_code == 200:
            return response.text
        else:
            raise Exception(f"Failed to fetch CSV from West Warehouse: {response.status_code}")

    fetch_west_warehouse_csv_task = PythonOperator(
        task_id='fetch_west_warehouse_csv',
        python_callable=fetch_west_warehouse_csv,
        provide_context=True,
    )

    # Task to normalize East SKUs
    def normalize_east_skus(**kwargs):
        ti = kwargs['ti']
        csv_data = ti.xcom_pull(task_ids='fetch_east_warehouse_csv')
        # Normalize the CSV data
        normalized_data = csv_data.upper()  # Example normalization
        return normalized_data

    normalize_east_skus_task = PythonOperator(
        task_id='normalize_east_skus',
        python_callable=normalize_east_skus,
        provide_context=True,
    )

    # Task to normalize North SKUs
    def normalize_north_skus(**kwargs):
        ti = kwargs['ti']
        csv_data = ti.xcom_pull(task_ids='fetch_north_warehouse_csv')
        # Normalize the CSV data
        normalized_data = csv_data.upper()  # Example normalization
        return normalized_data

    normalize_north_skus_task = PythonOperator(
        task_id='normalize_north_skus',
        python_callable=normalize_north_skus,
        provide_context=True,
    )

    # Task to normalize South SKUs
    def normalize_south_skus(**kwargs):
        ti = kwargs['ti']
        csv_data = ti.xcom_pull(task_ids='fetch_south_warehouse_csv')
        # Normalize the CSV data
        normalized_data = csv_data.upper()  # Example normalization
        return normalized_data

    normalize_south_skus_task = PythonOperator(
        task_id='normalize_south_skus',
        python_callable=normalize_south_skus,
        provide_context=True,
    )

    # Task to normalize West SKUs
    def normalize_west_skus(**kwargs):
        ti = kwargs['ti']
        csv_data = ti.xcom_pull(task_ids='fetch_west_warehouse_csv')
        # Normalize the CSV data
        normalized_data = csv_data.upper()  # Example normalization
        return normalized_data

    normalize_west_skus_task = PythonOperator(
        task_id='normalize_west_skus',
        python_callable=normalize_west_skus,
        provide_context=True,
    )

    # Task to reconcile all inventories
    def reconcile_all_inventories(**kwargs):
        ti = kwargs['ti']
        north_data = ti.xcom_pull(task_ids='normalize_north_skus')
        south_data = ti.xcom_pull(task_ids='normalize_south_skus')
        east_data = ti.xcom_pull(task_ids='normalize_east_skus')
        west_data = ti.xcom_pull(task_ids='normalize_west_skus')
        # Reconcile the data
        reconciled_data = f"{north_data}\n{south_data}\n{east_data}\n{west_data}"
        return reconciled_data

    reconcile_all_inventories_task = PythonOperator(
        task_id='reconcile_all_inventories',
        python_callable=reconcile_all_inventories,
        provide_context=True,
    )

    # Task to generate final report
    def generate_final_report(**kwargs):
        ti = kwargs['ti']
        reconciled_data = ti.xcom_pull(task_ids='reconcile_all_inventories')
        # Generate the final report
        report = f"Final Report:\n{reconciled_data}"
        return report

    generate_final_report_task = PythonOperator(
        task_id='generate_final_report',
        python_callable=generate_final_report,
        provide_context=True,
    )

    # Set task dependencies
    fetch_east_warehouse_csv_task >> normalize_east_skus_task
    fetch_north_warehouse_csv_task >> normalize_north_skus_task
    fetch_south_warehouse_csv_task >> normalize_south_skus_task
    fetch_west_warehouse_csv_task >> normalize_west_skus_task

    [normalize_north_skus_task, normalize_south_skus_task, normalize_east_skus_task, normalize_west_skus_task] >> reconcile_all_inventories_task
    reconcile_all_inventories_task >> generate_final_report_task