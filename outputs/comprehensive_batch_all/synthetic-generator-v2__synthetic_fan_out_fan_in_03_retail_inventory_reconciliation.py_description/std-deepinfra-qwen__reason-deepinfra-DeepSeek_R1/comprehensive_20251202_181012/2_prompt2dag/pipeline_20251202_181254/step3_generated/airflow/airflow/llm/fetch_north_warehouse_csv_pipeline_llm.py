# Generated by Airflow DAG Generator
# Date: 2023-10-05
# Airflow Version: 2.x
# Description: fetch_north_warehouse_csv_pipeline
# Pattern: fanin

from airflow import DAG
from airflow.operators.python import PythonOperator
from airflow.utils.dates import days_ago
from airflow.providers.amazon.aws.hooks.s3 import S3Hook
import requests
import pandas as pd

# Define default arguments for the DAG
default_args = {
    'owner': 'airflow',
    'start_date': days_ago(1),
    'retries': 2,
    'retry_delay': timedelta(minutes=5),
}

# Define the DAG
with DAG(
    dag_id='fetch_north_warehouse_csv_pipeline',
    default_args=default_args,
    schedule_interval='@daily',
    catchup=False,
    tags=['warehouse', 'csv', 'reconciliation'],
) as dag:

    # Define the Python functions for each task
    def fetch_warehouse_csv(warehouse_api, **kwargs):
        response = requests.get(warehouse_api)
        response.raise_for_status()
        csv_data = response.text
        s3_hook = S3Hook(aws_conn_id='xcom_storage')
        s3_key = f'warehouse_csv/{warehouse_api.split("/")[-1]}.csv'
        s3_hook.load_string(string_data=csv_data, key=s3_key, replace=True)
        return s3_key

    def normalize_skus(s3_key, **kwargs):
        s3_hook = S3Hook(aws_conn_id='xcom_storage')
        csv_data = s3_hook.read_key(s3_key)
        df = pd.read_csv(pd.compat.StringIO(csv_data))
        df['sku'] = df['sku'].str.upper()
        normalized_csv = df.to_csv(index=False)
        s3_hook.load_string(string_data=normalized_csv, key=s3_key, replace=True)
        return s3_key

    def reconcile_inventories(s3_keys, **kwargs):
        s3_hook = S3Hook(aws_conn_id='xcom_storage')
        dfs = []
        for s3_key in s3_keys:
            csv_data = s3_hook.read_key(s3_key)
            df = pd.read_csv(pd.compat.StringIO(csv_data))
            dfs.append(df)
        combined_df = pd.concat(dfs)
        combined_df = combined_df.groupby('sku').sum().reset_index()
        reconciled_csv = combined_df.to_csv(index=False)
        s3_key = 'reconciled_inventories.csv'
        s3_hook.load_string(string_data=reconciled_csv, key=s3_key, replace=True)
        return s3_key

    def generate_final_report(s3_key, **kwargs):
        s3_hook = S3Hook(aws_conn_id='xcom_storage')
        csv_data = s3_hook.read_key(s3_key)
        df = pd.read_csv(pd.compat.StringIO(csv_data))
        report = df.to_html(index=False)
        s3_key = 'final_report.html'
        s3_hook.load_string(string_data=report, key=s3_key, replace=True)
        return s3_key

    # Define the tasks
    fetch_east_warehouse_csv = PythonOperator(
        task_id='fetch_east_warehouse_csv',
        python_callable=fetch_warehouse_csv,
        op_kwargs={'warehouse_api': 'http://east_warehouse_api'},
    )

    fetch_north_warehouse_csv = PythonOperator(
        task_id='fetch_north_warehouse_csv',
        python_callable=fetch_warehouse_csv,
        op_kwargs={'warehouse_api': 'http://north_warehouse_api'},
    )

    fetch_south_warehouse_csv = PythonOperator(
        task_id='fetch_south_warehouse_csv',
        python_callable=fetch_warehouse_csv,
        op_kwargs={'warehouse_api': 'http://south_warehouse_api'},
    )

    fetch_west_warehouse_csv = PythonOperator(
        task_id='fetch_west_warehouse_csv',
        python_callable=fetch_warehouse_csv,
        op_kwargs={'warehouse_api': 'http://west_warehouse_api'},
    )

    normalize_east_skus = PythonOperator(
        task_id='normalize_east_skus',
        python_callable=normalize_skus,
        op_kwargs={'s3_key': '{{ ti.xcom_pull(task_ids="fetch_east_warehouse_csv") }}'},
    )

    normalize_north_skus = PythonOperator(
        task_id='normalize_north_skus',
        python_callable=normalize_skus,
        op_kwargs={'s3_key': '{{ ti.xcom_pull(task_ids="fetch_north_warehouse_csv") }}'},
    )

    normalize_south_skus = PythonOperator(
        task_id='normalize_south_skus',
        python_callable=normalize_skus,
        op_kwargs={'s3_key': '{{ ti.xcom_pull(task_ids="fetch_south_warehouse_csv") }}'},
    )

    normalize_west_skus = PythonOperator(
        task_id='normalize_west_skus',
        python_callable=normalize_skus,
        op_kwargs={'s3_key': '{{ ti.xcom_pull(task_ids="fetch_west_warehouse_csv") }}'},
    )

    reconcile_all_inventories = PythonOperator(
        task_id='reconcile_all_inventories',
        python_callable=reconcile_inventories,
        op_kwargs={
            's3_keys': [
                '{{ ti.xcom_pull(task_ids="normalize_east_skus") }}',
                '{{ ti.xcom_pull(task_ids="normalize_north_skus") }}',
                '{{ ti.xcom_pull(task_ids="normalize_south_skus") }}',
                '{{ ti.xcom_pull(task_ids="normalize_west_skus") }}',
            ]
        },
    )

    generate_final_report = PythonOperator(
        task_id='generate_final_report',
        python_callable=generate_final_report,
        op_kwargs={'s3_key': '{{ ti.xcom_pull(task_ids="reconcile_all_inventories") }}'},
    )

    # Define the task dependencies
    fetch_east_warehouse_csv >> normalize_east_skus
    fetch_north_warehouse_csv >> normalize_north_skus
    fetch_south_warehouse_csv >> normalize_south_skus
    fetch_west_warehouse_csv >> normalize_west_skus

    reconcile_all_inventories << [normalize_east_skus, normalize_north_skus, normalize_south_skus, normalize_west_skus]
    generate_final_report << reconcile_all_inventories