# Generated by Prefect 2.x Code Generator
# Date: 2023-10-05
# Prefect Version: 2.14.0

from prefect import flow, task, get_run_logger
from prefect.deployments import Deployment
from prefect.orion.schemas.schedules import CronSchedule
from prefect.filesystems import LocalFileSystem
from prefect.blocks.system import Secret
from prefect.task_runners import ConcurrentTaskRunner

# Secrets
north_warehouse_api = Secret.load("north-warehouse-api")
south_warehouse_api = Secret.load("south-warehouse-api")
east_warehouse_api = Secret.load("east-warehouse-api")
west_warehouse_api = Secret.load("west-warehouse-api")

# Local Filesystem
local_filesystem = LocalFileSystem.load("local-filesystem")

@task(retries=2, name="Fetch East Warehouse CSV")
def fetch_east_warehouse_csv():
    logger = get_run_logger()
    logger.info("Fetching East Warehouse CSV")
    # Fetch CSV from East Warehouse API
    # Example: response = requests.get(east_warehouse_api.get())
    # Example: with open("east_warehouse.csv", "w") as f:
    # Example:     f.write(response.text)
    return "east_warehouse.csv"

@task(retries=2, name="Fetch North Warehouse CSV")
def fetch_north_warehouse_csv():
    logger = get_run_logger()
    logger.info("Fetching North Warehouse CSV")
    # Fetch CSV from North Warehouse API
    # Example: response = requests.get(north_warehouse_api.get())
    # Example: with open("north_warehouse.csv", "w") as f:
    # Example:     f.write(response.text)
    return "north_warehouse.csv"

@task(retries=2, name="Fetch South Warehouse CSV")
def fetch_south_warehouse_csv():
    logger = get_run_logger()
    logger.info("Fetching South Warehouse CSV")
    # Fetch CSV from South Warehouse API
    # Example: response = requests.get(south_warehouse_api.get())
    # Example: with open("south_warehouse.csv", "w") as f:
    # Example:     f.write(response.text)
    return "south_warehouse.csv"

@task(retries=2, name="Fetch West Warehouse CSV")
def fetch_west_warehouse_csv():
    logger = get_run_logger()
    logger.info("Fetching West Warehouse CSV")
    # Fetch CSV from West Warehouse API
    # Example: response = requests.get(west_warehouse_api.get())
    # Example: with open("west_warehouse.csv", "w") as f:
    # Example:     f.write(response.text)
    return "west_warehouse.csv"

@task(retries=2, name="Normalize East SKUs")
def normalize_east_skus(east_csv):
    logger = get_run_logger()
    logger.info("Normalizing East SKUs")
    # Normalize SKUs in East CSV
    # Example: normalized_east_csv = normalize_csv(east_csv)
    return "normalized_east.csv"

@task(retries=2, name="Normalize North SKUs")
def normalize_north_skus(north_csv):
    logger = get_run_logger()
    logger.info("Normalizing North SKUs")
    # Normalize SKUs in North CSV
    # Example: normalized_north_csv = normalize_csv(north_csv)
    return "normalized_north.csv"

@task(retries=2, name="Normalize South SKUs")
def normalize_south_skus(south_csv):
    logger = get_run_logger()
    logger.info("Normalizing South SKUs")
    # Normalize SKUs in South CSV
    # Example: normalized_south_csv = normalize_csv(south_csv)
    return "normalized_south.csv"

@task(retries=2, name="Normalize West SKUs")
def normalize_west_skus(west_csv):
    logger = get_run_logger()
    logger.info("Normalizing West SKUs")
    # Normalize SKUs in West CSV
    # Example: normalized_west_csv = normalize_csv(west_csv)
    return "normalized_west.csv"

@task(retries=2, name="Reconcile All Inventories")
def reconcile_all_inventories(north_csv, south_csv, east_csv, west_csv):
    logger = get_run_logger()
    logger.info("Reconciling All Inventories")
    # Reconcile all normalized CSVs
    # Example: final_inventory = reconcile_inventories(north_csv, south_csv, east_csv, west_csv)
    return "final_inventory.csv"

@task(retries=2, name="Generate Final Report")
def generate_final_report(final_inventory):
    logger = get_run_logger()
    logger.info("Generating Final Report")
    # Generate final report from final inventory
    # Example: final_report = generate_report(final_inventory)
    return "final_report.csv"

@flow(name="fetch_north_warehouse_csv_pipeline", task_runner=ConcurrentTaskRunner())
def fetch_north_warehouse_csv_pipeline():
    logger = get_run_logger()
    logger.info("Starting fetch_north_warehouse_csv_pipeline")

    east_csv = fetch_east_warehouse_csv()
    north_csv = fetch_north_warehouse_csv()
    south_csv = fetch_south_warehouse_csv()
    west_csv = fetch_west_warehouse_csv()

    normalized_east_csv = normalize_east_skus(east_csv)
    normalized_north_csv = normalize_north_skus(north_csv)
    normalized_south_csv = normalize_south_skus(south_csv)
    normalized_west_csv = normalize_west_skus(west_csv)

    final_inventory = reconcile_all_inventories(
        north_csv=normalized_north_csv,
        south_csv=normalized_south_csv,
        east_csv=normalized_east_csv,
        west_csv=normalized_west_csv
    )

    final_report = generate_final_report(final_inventory)

    logger.info("Pipeline completed successfully")

# Deployment configuration
deployment = Deployment.build_from_flow(
    flow=fetch_north_warehouse_csv_pipeline,
    name="fetch_north_warehouse_csv_pipeline_deployment",
    work_pool_name="default-agent-pool",
    schedule=CronSchedule(cron="0 0 * * *", timezone="UTC", catchup=False),
)

if __name__ == "__main__":
    deployment.apply()