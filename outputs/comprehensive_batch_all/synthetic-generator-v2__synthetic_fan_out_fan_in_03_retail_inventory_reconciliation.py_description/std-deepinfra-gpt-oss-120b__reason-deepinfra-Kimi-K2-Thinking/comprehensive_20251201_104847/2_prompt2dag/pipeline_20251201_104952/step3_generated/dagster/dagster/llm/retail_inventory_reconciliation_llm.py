# Generated by Dagster code generator on 2024-06-28
# Pipeline: retail_inventory_reconciliation
# Description: No description provided.
# Executor: multiprocess_executor
# Resources: north_warehouse_api, south_warehouse_api, east_warehouse_api, west_warehouse_api

from typing import Any, Dict, List

import pandas as pd
from dagster import (
    In,
    Out,
    RetryPolicy,
    ResourceDefinition,
    String,
    asset,
    job,
    op,
    fs_io_manager,
    multiprocess_executor,
    schedule,
)


# -------------------------------------------------------------------------
# Resource definitions (placeholders – replace with real implementations)
# -------------------------------------------------------------------------

class WarehouseAPI:
    """Simple placeholder for a warehouse management system client."""

    def __init__(self, name: str):
        self.name = name

    def fetch_inventory_csv(self) -> str:
        """
        Simulate fetching a CSV file from the warehouse system.
        Returns the path to a temporary CSV file.
        """
        # In a real implementation, this would download a file or return raw CSV content.
        return f"/tmp/{self.name.lower()}_inventory.csv"


def warehouse_resource(name: str) -> ResourceDefinition:
    """Factory that creates a WarehouseAPI resource."""
    return ResourceDefinition.resource(
        lambda _: WarehouseAPI(name=name),
        description=f"Resource for {name} Warehouse Management System",
    )


# -------------------------------------------------------------------------
# Ops
# -------------------------------------------------------------------------

@op(
    name="fetch_east_warehouse_csv",
    description="Fetch inventory CSV from the East warehouse.",
    out=Out(String),
    retry_policy=RetryPolicy(max_retries=2),
)
def fetch_east_warehouse_csv(context) -> str:
    api: WarehouseAPI = context.resources.east_warehouse_api
    csv_path = api.fetch_inventory_csv()
    context.log.info(f"Fetched East warehouse CSV at {csv_path}")
    return csv_path


@op(
    name="fetch_north_warehouse_csv",
    description="Fetch inventory CSV from the North warehouse.",
    out=Out(String),
    retry_policy=RetryPolicy(max_retries=2),
)
def fetch_north_warehouse_csv(context) -> str:
    api: WarehouseAPI = context.resources.north_warehouse_api
    csv_path = api.fetch_inventory_csv()
    context.log.info(f"Fetched North warehouse CSV at {csv_path}")
    return csv_path


@op(
    name="fetch_south_warehouse_csv",
    description="Fetch inventory CSV from the South warehouse.",
    out=Out(String),
    retry_policy=RetryPolicy(max_retries=2),
)
def fetch_south_warehouse_csv(context) -> str:
    api: WarehouseAPI = context.resources.south_warehouse_api
    csv_path = api.fetch_inventory_csv()
    context.log.info(f"Fetched South warehouse CSV at {csv_path}")
    return csv_path


@op(
    name="fetch_west_warehouse_csv",
    description="Fetch inventory CSV from the West warehouse.",
    out=Out(String),
    retry_policy=RetryPolicy(max_retries=2),
)
def fetch_west_warehouse_csv(context) -> str:
    api: WarehouseAPI = context.resources.west_warehouse_api
    csv_path = api.fetch_inventory_csv()
    context.log.info(f"Fetched West warehouse CSV at {csv_path}")
    return csv_path


def _load_and_normalize(csv_path: str, warehouse_name: str) -> pd.DataFrame:
    """
    Helper that loads a CSV file into a DataFrame and performs basic normalization.
    """
    # In a real implementation, you would read the CSV from storage.
    # Here we simulate with an empty DataFrame for illustration.
    df = pd.DataFrame()  # placeholder
    # Example normalization steps (rename columns, trim whitespace, etc.)
    df.columns = [col.strip().lower() for col in df.columns]
    df["warehouse"] = warehouse_name
    return df


@op(
    name="normalize_east_skus",
    description="Normalize SKU data from the East warehouse.",
    ins={"csv_path": In(String)},
    out=Out(pd.DataFrame),
    retry_policy=RetryPolicy(max_retries=2),
)
def normalize_east_skus(csv_path: str) -> pd.DataFrame:
    return _load_and_normalize(csv_path, "East")


@op(
    name="normalize_north_skus",
    description="Normalize SKU data from the North warehouse.",
    ins={"csv_path": In(String)},
    out=Out(pd.DataFrame),
    retry_policy=RetryPolicy(max_retries=2),
)
def normalize_north_skus(csv_path: str) -> pd.DataFrame:
    return _load_and_normalize(csv_path, "North")


@op(
    name="normalize_south_skus",
    description="Normalize SKU data from the South warehouse.",
    ins={"csv_path": In(String)},
    out=Out(pd.DataFrame),
    retry_policy=RetryPolicy(max_retries=2),
)
def normalize_south_skus(csv_path: str) -> pd.DataFrame:
    return _load_and_normalize(csv_path, "South")


@op(
    name="normalize_west_skus",
    description="Normalize SKU data from the West warehouse.",
    ins={"csv_path": In(String)},
    out=Out(pd.DataFrame),
    retry_policy=RetryPolicy(max_retries=2),
)
def normalize_west_skus(csv_path: str) -> pd.DataFrame:
    return _load_and_normalize(csv_path, "West")


@op(
    name="reconcile_all_inventories",
    description="Reconcile SKU inventories across all warehouses.",
    ins={
        "north": In(pd.DataFrame),
        "south": In(pd.DataFrame),
        "east": In(pd.DataFrame),
        "west": In(pd.DataFrame),
    },
    out=Out(pd.DataFrame),
    retry_policy=RetryPolicy(max_retries=2),
)
def reconcile_all_inventories(
    north: pd.DataFrame,
    south: pd.DataFrame,
    east: pd.DataFrame,
    west: pd.DataFrame,
) -> pd.DataFrame:
    """
    Perform a simple full outer join on SKU identifiers across warehouses.
    """
    # Placeholder reconciliation logic – replace with real business rules.
    combined = pd.concat([north, south, east, west], ignore_index=True)
    # Example: group by SKU and sum quantities (assuming a 'quantity' column exists)
    if "sku" in combined.columns and "quantity" in combined.columns:
        reconciled = combined.groupby("sku", as_index=False)["quantity"].sum()
    else:
        reconciled = combined
    return reconciled


@op(
    name="generate_final_report",
    description="Generate the final inventory reconciliation report.",
    ins={"reconciled": In(pd.DataFrame)},
    out=Out(String),
    retry_policy=RetryPolicy(max_retries=2),
)
def generate_final_report(reconciled: pd.DataFrame) -> str:
    """
    Serialize the reconciled DataFrame to a CSV report and return the file path.
    """
    report_path = "/tmp/final_inventory_report.csv"
    reconciled.to_csv(report_path, index=False)
    return report_path


# -------------------------------------------------------------------------
# Job definition
# -------------------------------------------------------------------------

@job(
    name="retail_inventory_reconciliation",
    description="No description provided.",
    executor_def=multiprocess_executor,
    resource_defs={
        "north_warehouse_api": warehouse_resource("North"),
        "south_warehouse_api": warehouse_resource("South"),
        "east_warehouse_api": warehouse_resource("East"),
        "west_warehouse_api": warehouse_resource("West"),
        "io_manager": fs_io_manager,
    },
)
def retail_inventory_reconciliation():
    # Fetch CSVs
    east_csv = fetch_east_warehouse_csv()
    north_csv = fetch_north_warehouse_csv()
    south_csv = fetch_south_warehouse_csv()
    west_csv = fetch_west_warehouse_csv()

    # Normalize SKUs
    east_norm = normalize_east_skus(east_csv)
    north_norm = normalize_north_skus(north_csv)
    south_norm = normalize_south_skus(south_csv)
    west_norm = normalize_west_skus(west_csv)

    # Reconcile
    reconciled = reconcile_all_inventories(
        north=north_norm,
        south=south_norm,
        east=east_norm,
        west=west_norm,
    )

    # Generate final report
    generate_final_report(reconciled)


# -------------------------------------------------------------------------
# Schedule (disabled)
# -------------------------------------------------------------------------

@schedule(
    cron_schedule="@daily",
    job=retail_inventory_reconciliation,
    execution_timezone="UTC",
    description="Daily schedule for retail inventory reconciliation (disabled).",
    default_status="inactive",  # ensures the schedule is not enabled by default
)
def retail_inventory_reconciliation_schedule():
    return {}


# -------------------------------------------------------------------------
# End of file
# -------------------------------------------------------------------------