# Generated by Airflow DAG generator on 2024-06-13
"""
DAG: fetch_north_warehouse_csv_pipeline
Description: No description provided.
Pattern: fanin
"""

import logging
from datetime import datetime, timedelta

import pandas as pd
import requests
from airflow import DAG
from airflow.exceptions import AirflowException
from airflow.decorators import task
from airflow.utils.dates import days_ago
from airflow.hooks.base import BaseHook

# Default arguments applied to all tasks
DEFAULT_ARGS = {
    "owner": "airflow",
    "depends_on_past": False,
    "retries": 2,
    "retry_delay": timedelta(minutes=5),
    "email_on_failure": False,
    "email_on_retry": False,
}


def _get_api_endpoint(conn_id: str) -> str:
    """
    Retrieve the base URL for a given HTTP connection.
    """
    try:
        conn = BaseHook.get_connection(conn_id)
        return conn.host.rstrip("/")
    except Exception as exc:
        raise AirflowException(f"Failed to retrieve connection {conn_id}: {exc}") from exc


def _download_csv(url: str) -> pd.DataFrame:
    """
    Helper to download a CSV file from a URL and return a DataFrame.
    """
    try:
        response = requests.get(url, timeout=30)
        response.raise_for_status()
        return pd.read_csv(pd.compat.StringIO(response.text))
    except Exception as exc:
        raise AirflowException(f"Error downloading CSV from {url}: {exc}") from exc


with DAG(
    dag_id="fetch_north_warehouse_csv_pipeline",
    description="No description provided.",
    schedule="@daily",
    start_date=days_ago(1),
    catchup=False,
    default_args=DEFAULT_ARGS,
    tags=["warehouse", "reconciliation"],
    is_paused_upon_creation=True,  # Disabled by default
    max_active_runs=1,
) as dag:

    @task(retries=2, retry_delay=timedelta(minutes=5))
    def fetch_east_warehouse_csv() -> pd.DataFrame:
        """Fetch CSV from East Warehouse API."""
        base_url = _get_api_endpoint("east_warehouse_api")
        csv_url = f"{base_url}/inventory.csv"
        logging.info("Fetching East Warehouse CSV from %s", csv_url)
        return _download_csv(csv_url)

    @task(retries=2, retry_delay=timedelta(minutes=5))
    def fetch_north_warehouse_csv() -> pd.DataFrame:
        """Fetch CSV from North Warehouse API."""
        base_url = _get_api_endpoint("north_warehouse_api")
        csv_url = f"{base_url}/inventory.csv"
        logging.info("Fetching North Warehouse CSV from %s", csv_url)
        return _download_csv(csv_url)

    @task(retries=2, retry_delay=timedelta(minutes=5))
    def fetch_south_warehouse_csv() -> pd.DataFrame:
        """Fetch CSV from South Warehouse API."""
        base_url = _get_api_endpoint("south_warehouse_api")
        csv_url = f"{base_url}/inventory.csv"
        logging.info("Fetching South Warehouse CSV from %s", csv_url)
        return _download_csv(csv_url)

    @task(retries=2, retry_delay=timedelta(minutes=5))
    def fetch_west_warehouse_csv() -> pd.DataFrame:
        """Fetch CSV from West Warehouse API."""
        base_url = _get_api_endpoint("west_warehouse_api")
        csv_url = f"{base_url}/inventory.csv"
        logging.info("Fetching West Warehouse CSV from %s", csv_url)
        return _download_csv(csv_url)

    @task(retries=2, retry_delay=timedelta(minutes=5))
    def normalize_east_skus(df: pd.DataFrame) -> pd.DataFrame:
        """Normalize SKU data for East Warehouse."""
        logging.info("Normalizing East Warehouse SKUs")
        df = df.copy()
        df["sku"] = df["sku"].str.upper().str.strip()
        df["quantity"] = pd.to_numeric(df["quantity"], errors="coerce").fillna(0).astype(int)
        return df

    @task(retries=2, retry_delay=timedelta(minutes=5))
    def normalize_north_skus(df: pd.DataFrame) -> pd.DataFrame:
        """Normalize SKU data for North Warehouse."""
        logging.info("Normalizing North Warehouse SKUs")
        df = df.copy()
        df["sku"] = df["sku"].str.upper().str.strip()
        df["quantity"] = pd.to_numeric(df["quantity"], errors="coerce").fillna(0).astype(int)
        return df

    @task(retries=2, retry_delay=timedelta(minutes=5))
    def normalize_south_skus(df: pd.DataFrame) -> pd.DataFrame:
        """Normalize SKU data for South Warehouse."""
        logging.info("Normalizing South Warehouse SKUs")
        df = df.copy()
        df["sku"] = df["sku"].str.upper().str.strip()
        df["quantity"] = pd.to_numeric(df["quantity"], errors="coerce").fillna(0).astype(int)
        return df

    @task(retries=2, retry_delay=timedelta(minutes=5))
    def normalize_west_skus(df: pd.DataFrame) -> pd.DataFrame:
        """Normalize SKU data for West Warehouse."""
        logging.info("Normalizing West Warehouse SKUs")
        df = df.copy()
        df["sku"] = df["sku"].str.upper().str.strip()
        df["quantity"] = pd.to_numeric(df["quantity"], errors="coerce").fillna(0).astype(int)
        return df

    @task(retries=2, retry_delay=timedelta(minutes=5))
    def reconcile_all_inventories(
        north_df: pd.DataFrame,
        south_df: pd.DataFrame,
        east_df: pd.DataFrame,
        west_df: pd.DataFrame,
    ) -> pd.DataFrame:
        """Combine normalized inventories from all warehouses."""
        logging.info("Reconciling inventories from all warehouses")
        combined = pd.concat([north_df, south_df, east_df, west_df], ignore_index=True)
        # Aggregate quantities per SKU
        reconciled = (
            combined.groupby("sku", as_index=False)["quantity"]
            .sum()
            .rename(columns={"quantity": "total_quantity"})
        )
        return reconciled

    @task(retries=2, retry_delay=timedelta(minutes=5))
    def generate_final_report(reconciled_df: pd.DataFrame) -> str:
        """Generate a CSV report from the reconciled inventory."""
        report_path = f"/tmp/inventory_report_{datetime.utcnow().strftime('%Y%m%d%H%M%S')}.csv"
        logging.info("Generating final report at %s", report_path)
        reconciled_df.to_csv(report_path, index=False)
        return report_path

    # Task execution graph
    east_raw = fetch_east_warehouse_csv()
    north_raw = fetch_north_warehouse_csv()
    south_raw = fetch_south_warehouse_csv()
    west_raw = fetch_west_warehouse_csv()

    east_norm = normalize_east_skus(east_raw)
    north_norm = normalize_north_skus(north_raw)
    south_norm = normalize_south_skus(south_raw)
    west_norm = normalize_west_skus(west_raw)

    reconciled = reconcile_all_inventories(
        north_norm, south_norm, east_norm, west_norm
    )

    final_report = generate_final_report(reconciled)

    # Explicit dependencies (optional, as TaskFlow handles them)
    east_raw >> east_norm
    north_raw >> north_norm
    south_raw >> south_norm
    west_raw >> west_norm
    [north_norm, south_norm, east_norm, west_norm] >> reconciled
    reconciled >> final_report