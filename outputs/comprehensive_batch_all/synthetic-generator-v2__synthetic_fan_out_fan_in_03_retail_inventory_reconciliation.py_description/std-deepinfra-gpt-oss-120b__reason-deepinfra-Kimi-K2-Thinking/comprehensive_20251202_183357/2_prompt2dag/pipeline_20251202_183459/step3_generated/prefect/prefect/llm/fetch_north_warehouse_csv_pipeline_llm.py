# Generated by AI on 2024-06-28
# Prefect pipeline: fetch_north_warehouse_csv_pipeline
# Description: No description provided.
# Pattern: fanin
# Prefect version: 2.14.0

import pandas as pd
from prefect import flow, task, get_run_logger
from prefect.task_runners import ConcurrentTaskRunner
from prefect.blocks.system import Secret
from prefect.deployments import Deployment
from prefect.orion.schemas.schedules import CronSchedule


@task(retries=2, retry_delay_seconds=60)
def fetch_north_warehouse_csv() -> pd.DataFrame:
    """
    Fetch CSV data from the North Warehouse Management System.

    Returns:
        pd.DataFrame: Raw inventory data.
    """
    logger = get_run_logger()
    secret = Secret.load("north_warehouse_api")
    api_key = secret.get()
    logger.info("Fetching North Warehouse CSV using secret.")
    # Placeholder for real API call; replace with actual request logic.
    data = pd.DataFrame({"sku": ["N1", "N2"], "quantity": [200, 300]})
    return data


@task(retries=2, retry_delay_seconds=60)
def fetch_south_warehouse_csv() -> pd.DataFrame:
    """
    Fetch CSV data from the South Warehouse Management System.

    Returns:
        pd.DataFrame: Raw inventory data.
    """
    logger = get_run_logger()
    secret = Secret.load("south_warehouse_api")
    api_key = secret.get()
    logger.info("Fetching South Warehouse CSV using secret.")
    data = pd.DataFrame({"sku": ["S1", "S2"], "quantity": [150, 250]})
    return data


@task(retries=2, retry_delay_seconds=60)
def fetch_east_warehouse_csv() -> pd.DataFrame:
    """
    Fetch CSV data from the East Warehouse Management System.

    Returns:
        pd.DataFrame: Raw inventory data.
    """
    logger = get_run_logger()
    secret = Secret.load("east_warehouse_api")
    api_key = secret.get()
    logger.info("Fetching East Warehouse CSV using secret.")
    data = pd.DataFrame({"sku": ["E1", "E2"], "quantity": [100, 150]})
    return data


@task(retries=2, retry_delay_seconds=60)
def fetch_west_warehouse_csv() -> pd.DataFrame:
    """
    Fetch CSV data from the West Warehouse Management System.

    Returns:
        pd.DataFrame: Raw inventory data.
    """
    logger = get_run_logger()
    secret = Secret.load("west_warehouse_api")
    api_key = secret.get()
    logger.info("Fetching West Warehouse CSV using secret.")
    data = pd.DataFrame({"sku": ["W1", "W2"], "quantity": [120, 180]})
    return data


@task(retries=2, retry_delay_seconds=60)
def normalize_north_skus(raw_df: pd.DataFrame) -> pd.DataFrame:
    """
    Normalize SKU format for North Warehouse data.

    Args:
        raw_df (pd.DataFrame): Raw North Warehouse data.

    Returns:
        pd.DataFrame: Normalized data.
    """
    logger = get_run_logger()
    logger.info("Normalizing North SKUs.")
    df = raw_df.copy()
    df["sku"] = df["sku"].str.upper()
    return df


@task(retries=2, retry_delay_seconds=60)
def normalize_south_skus(raw_df: pd.DataFrame) -> pd.DataFrame:
    """
    Normalize SKU format for South Warehouse data.

    Args:
        raw_df (pd.DataFrame): Raw South Warehouse data.

    Returns:
        pd.DataFrame: Normalized data.
    """
    logger = get_run_logger()
    logger.info("Normalizing South SKUs.")
    df = raw_df.copy()
    df["sku"] = df["sku"].str.upper()
    return df


@task(retries=2, retry_delay_seconds=60)
def normalize_east_skus(raw_df: pd.DataFrame) -> pd.DataFrame:
    """
    Normalize SKU format for East Warehouse data.

    Args:
        raw_df (pd.DataFrame): Raw East Warehouse data.

    Returns:
        pd.DataFrame: Normalized data.
    """
    logger = get_run_logger()
    logger.info("Normalizing East SKUs.")
    df = raw_df.copy()
    df["sku"] = df["sku"].str.upper()
    return df


@task(retries=2, retry_delay_seconds=60)
def normalize_west_skus(raw_df: pd.DataFrame) -> pd.DataFrame:
    """
    Normalize SKU format for West Warehouse data.

    Args:
        raw_df (pd.DataFrame): Raw West Warehouse data.

    Returns:
        pd.DataFrame: Normalized data.
    """
    logger = get_run_logger()
    logger.info("Normalizing West SKUs.")
    df = raw_df.copy()
    df["sku"] = df["sku"].str.upper()
    return df


@task(retries=2, retry_delay_seconds=60)
def reconcile_all_inventories(
    north_df: pd.DataFrame,
    south_df: pd.DataFrame,
    east_df: pd.DataFrame,
    west_df: pd.DataFrame,
) -> pd.DataFrame:
    """
    Combine normalized inventories from all warehouses and aggregate quantities.

    Args:
        north_df (pd.DataFrame): Normalized North data.
        south_df (pd.DataFrame): Normalized South data.
        east_df (pd.DataFrame): Normalized East data.
        west_df (pd.DataFrame): Normalized West data.

    Returns:
        pd.DataFrame: Aggregated inventory across all warehouses.
    """
    logger = get_run_logger()
    logger.info("Reconciling inventories from all warehouses.")
    combined = pd.concat([north_df, south_df, east_df, west_df], ignore_index=True)
    aggregated = combined.groupby("sku", as_index=False).agg({"quantity": "sum"})
    return aggregated


@task(retries=2, retry_delay_seconds=60)
def generate_final_report(inventory_df: pd.DataFrame) -> str:
    """
    Generate the final inventory report as a CSV file.

    Args:
        inventory_df (pd.DataFrame): Aggregated inventory data.

    Returns:
        str: Path to the generated CSV report.
    """
    logger = get_run_logger()
    report_path = "final_inventory_report.csv"
    inventory_df.to_csv(report_path, index=False)
    logger.info(f"Final report generated at {report_path}")
    return report_path


@flow(
    name="fetch_north_warehouse_csv_pipeline",
    task_runner=ConcurrentTaskRunner(),
)
def fetch_north_warehouse_csv_pipeline() -> str:
    """
    Orchestrates fetching, normalizing, reconciling, and reporting inventory data
    from North, South, East, and West warehouses.
    """
    # Fetch raw CSVs
    north_raw = fetch_north_warehouse_csv()
    south_raw = fetch_south_warehouse_csv()
    east_raw = fetch_east_warehouse_csv()
    west_raw = fetch_west_warehouse_csv()

    # Normalize SKUs
    north_norm = normalize_north_skus(north_raw)
    south_norm = normalize_south_skus(south_raw)
    east_norm = normalize_east_skus(east_raw)
    west_norm = normalize_west_skus(west_raw)

    # Reconcile inventories
    reconciled = reconcile_all_inventories(
        north_norm, south_norm, east_norm, west_norm
    )

    # Generate final report
    report_path = generate_final_report(reconciled)
    return report_path


# Deployment configuration (disabled by default)
deployment = Deployment.build_from_flow(
    flow=fetch_north_warehouse_csv_pipeline,
    name="fetch_north_warehouse_csv_pipeline_deployment",
    schedule=CronSchedule(cron="0 0 * * *", timezone="UTC"),
    work_pool_name="default-agent-pool",
    paused=True,  # Disabled schedule
)

if __name__ == "__main__":
    # Apply the deployment to Prefect Orion
    deployment.apply()