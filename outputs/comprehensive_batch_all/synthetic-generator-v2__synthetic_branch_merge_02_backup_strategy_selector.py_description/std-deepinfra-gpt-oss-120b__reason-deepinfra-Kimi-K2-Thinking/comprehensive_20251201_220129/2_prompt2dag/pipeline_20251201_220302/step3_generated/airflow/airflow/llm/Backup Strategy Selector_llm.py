# Generated by Airflow DAG Generator on 2024-06-28
"""
Backup Strategy Selector DAG

This DAG selects a backup strategy (full or incremental) based on the day of the week.
It follows a fan‑out/fan‑in (branch‑merge) pattern:
    start -> determine strategy -> (full | incremental) -> verify -> finalize
"""

from __future__ import annotations

import logging
from datetime import timedelta

import pendulum
from airflow import DAG
from airflow.exceptions import AirflowException
from airflow.operators.bash import BashOperator
from airflow.operators.python import PythonOperator, BranchPythonOperator
from airflow.utils.trigger_rule import TriggerRule

# ----------------------------------------------------------------------
# Default arguments and helper functions
# ----------------------------------------------------------------------
DEFAULT_ARGS = {
    "owner": "airflow",
    "depends_on_past": False,
    "email_on_failure": False,
    "email_on_retry": False,
    "retries": 0,
    "retry_delay": timedelta(minutes=5),
}


def _on_failure(context: dict) -> None:
    """Generic failure callback that logs the exception."""
    dag_id = context.get("dag_id")
    task_id = context.get("task_instance").task_id
    exception = context.get("exception")
    logging.error(
        "Task failed: dag=%s, task=%s, exception=%s", dag_id, task_id, exception
    )
    # Extend with notifications (e.g., Slack, email) if required.


def start_backup_process(**kwargs):
    """Placeholder start task."""
    logging.info("Starting backup process...")


def finalize_backup(**kwargs):
    """Placeholder finalization task."""
    logging.info("Finalizing backup process...")


def decide_backup_strategy(**kwargs) -> str:
    """
    Branching function that decides which backup strategy to run.

    Returns:
        str: task_id of the chosen downstream task.
    """
    execution_date = kwargs["execution_date"]
    # Monday (0) -> full backup, other days -> incremental
    if execution_date.weekday() == 0:
        chosen = "perform_full_backup"
    else:
        chosen = "perform_incremental_backup"
    logging.info(
        "Execution date %s is weekday %s; selected %s",
        execution_date,
        execution_date.weekday(),
        chosen,
    )
    return chosen


# ----------------------------------------------------------------------
# DAG definition
# ----------------------------------------------------------------------
with DAG(
    dag_id="backup_strategy_selector",
    description="Comprehensive pipeline that selects a backup strategy (full or incremental) based on the day of week.",
    schedule_interval="@daily",
    start_date=pendulum.datetime(2024, 1, 1, tz="UTC"),
    catchup=False,
    default_args=DEFAULT_ARGS,
    tags=["backup", "strategy", "fanout_fanin"],
    max_active_runs=1,
    default_view="graph",
    timezone=pendulum.timezone("UTC"),
) as dag:

    # ------------------------------------------------------------------
    # Tasks
    # ------------------------------------------------------------------
    start = PythonOperator(
        task_id="start_backup_process",
        python_callable=start_backup_process,
        retries=0,
        on_failure_callback=_on_failure,
    )

    determine_strategy = BranchPythonOperator(
        task_id="determine_backup_strategy",
        python_callable=decide_backup_strategy,
        retries=2,
        retry_delay=timedelta(minutes=5),
        on_failure_callback=_on_failure,
    )

    perform_full_backup = BashOperator(
        task_id="perform_full_backup",
        bash_command="echo 'Running full backup...'; sleep 5",
        retries=2,
        retry_delay=timedelta(minutes=5),
        on_failure_callback=_on_failure,
    )

    perform_incremental_backup = BashOperator(
        task_id="perform_incremental_backup",
        bash_command="echo 'Running incremental backup...'; sleep 5",
        retries=2,
        retry_delay=timedelta(minutes=5),
        on_failure_callback=_on_failure,
    )

    verify = BashOperator(
        task_id="verify_backup",
        bash_command="echo 'Verifying backup...'; sleep 3",
        retries=2,
        retry_delay=timedelta(minutes=5),
        trigger_rule=TriggerRule.NONE_FAILED_MIN_ONE_SUCCESS,
        on_failure_callback=_on_failure,
    )

    finalize = PythonOperator(
        task_id="finalize_backup",
        python_callable=finalize_backup,
        retries=2,
        retry_delay=timedelta(minutes=5),
        on_failure_callback=_on_failure,
    )

    # ------------------------------------------------------------------
    # Dependencies (fan‑out / fan‑in)
    # ------------------------------------------------------------------
    start >> determine_strategy
    determine_strategy >> [perform_full_backup, perform_incremental_backup]
    [perform_full_backup, perform_incremental_backup] >> verify
    verify >> finalize

# End of DAG definition.