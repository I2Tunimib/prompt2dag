# Generated by Dagster code generator
# Date: 2024-06-13
# Pipeline: start_backup_process_pipeline
# Description: No description provided.

from dagster import (
    op,
    job,
    In,
    Out,
    RetryPolicy,
    InMemoryIOManager,
    fs_io_manager,
    in_process_executor,
    ScheduleDefinition,
    ScheduleStatus,
    Definitions,
)

# ----------------------------------------------------------------------
# Ops
# ----------------------------------------------------------------------


@op(
    name="start_backup_process",
    description="Initial step to kick off the backup workflow.",
    out=Out(str),
    retry_policy=RetryPolicy(max_retries=2),
)
def start_backup_process() -> str:
    """Simulate starting the backup process."""
    # Placeholder logic – replace with real implementation.
    return "backup_started"


@op(
    name="determine_backup_strategy",
    description="Decide whether to run a full or incremental backup.",
    ins={"start_status": In(str)},
    out=Out(str),
    retry_policy=RetryPolicy(max_retries=2),
)
def determine_backup_strategy(start_status: str) -> str:
    """Determine backup strategy based on the start status."""
    # Placeholder decision logic.
    if start_status == "backup_started":
        return "full"
    return "incremental"


@op(
    name="perform_full_backup",
    description="Execute a full backup of the data.",
    ins={"strategy": In(str)},
    out=Out(str),
    retry_policy=RetryPolicy(max_retries=2),
)
def perform_full_backup(strategy: str) -> str:
    """Run a full backup if the strategy indicates so."""
    if strategy != "full":
        # In a real pipeline you might skip or raise; here we just return a no‑op result.
        return "full_backup_skipped"
    # Placeholder full backup logic.
    return "full_backup_completed"


@op(
    name="perform_incremental_backup",
    description="Execute an incremental backup of the data.",
    ins={"strategy": In(str)},
    out=Out(str),
    retry_policy=RetryPolicy(max_retries=2),
)
def perform_incremental_backup(strategy: str) -> str:
    """Run an incremental backup if the strategy indicates so."""
    if strategy != "incremental":
        return "incremental_backup_skipped"
    # Placeholder incremental backup logic.
    return "incremental_backup_completed"


@op(
    name="validate_backup_integrity",
    description="Validate the integrity of the performed backups.",
    ins={
        "full_result": In(str),
        "incremental_result": In(str),
    },
    out=Out(str),
    retry_policy=RetryPolicy(max_retries=2),
)
def validate_backup_integrity(full_result: str, incremental_result: str) -> str:
    """Validate that at least one backup succeeded and is consistent."""
    # Simple validation placeholder.
    if "completed" in full_result or "completed" in incremental_result:
        return "validation_successful"
    return "validation_failed"


@op(
    name="finalize_backup_workflow",
    description="Finalize the backup workflow after validation.",
    ins={"validation_status": In(str)},
    out=Out(str),
    retry_policy=RetryPolicy(max_retries=2),
)
def finalize_backup_workflow(validation_status: str) -> str:
    """Wrap up the backup process, performing any cleanup."""
    if validation_status != "validation_successful":
        return "finalization_failed"
    # Placeholder finalization logic.
    return "finalization_complete"


# ----------------------------------------------------------------------
# Job definition
# ----------------------------------------------------------------------


@job(
    name="start_backup_process_pipeline",
    description="No description provided.",
    executor_def=in_process_executor,
    resource_defs={"io_manager": fs_io_manager},
)
def start_backup_process_pipeline():
    """Orchestrates the full backup workflow using a fan‑out/fan‑in pattern."""
    # Step 1: start the backup process
    start_status = start_backup_process()

    # Step 2: decide which backup strategy to use
    strategy = determine_backup_strategy(start_status)

    # Step 3: fan‑out – run both backup types (each will internally decide to act or skip)
    full_backup_result = perform_full_backup(strategy)
    incremental_backup_result = perform_incremental_backup(strategy)

    # Step 4: fan‑in – validate the results of both backup attempts
    validation = validate_backup_integrity(full_backup_result, incremental_backup_result)

    # Step 5: finalize the workflow
    finalize_backup_workflow(validation)


# ----------------------------------------------------------------------
# Schedule (disabled by default)
# ----------------------------------------------------------------------


daily_backup_schedule = ScheduleDefinition(
    job=start_backup_process_pipeline,
    cron_schedule="@daily",
    execution_timezone="UTC",
    default_status=ScheduleStatus.STOPPED,  # Disabled by default
    description="Daily schedule for the backup pipeline (currently disabled).",
)


# ----------------------------------------------------------------------
# Definitions (entry point for Dagster UI / CLI)
# ----------------------------------------------------------------------


defs = Definitions(
    jobs=[start_backup_process_pipeline],
    schedules=[daily_backup_schedule],
    resources={"io_manager": fs_io_manager},
)