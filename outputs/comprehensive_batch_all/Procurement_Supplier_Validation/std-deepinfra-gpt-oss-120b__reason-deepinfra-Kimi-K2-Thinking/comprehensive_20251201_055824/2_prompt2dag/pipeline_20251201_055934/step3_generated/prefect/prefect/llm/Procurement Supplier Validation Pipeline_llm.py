# Generated by Prefect Pipeline Generator
# Date: 2024-06-28
# Pipeline: Procurement Supplier Validation Pipeline
# Description: Validates and standardizes supplier data by reconciling names against Wikidata.
# Prefect version: 2.14.0

from prefect import flow, task
from prefect.task_runners import SequentialTaskRunner
from prefect.exceptions import FAIL
from prefect_docker import DockerContainer
from prefect.filesystems import LocalFileSystem
from prefect.blocks.system import Secret

# ----------------------------------------------------------------------
# Helper functions to load configuration blocks
# ----------------------------------------------------------------------


def get_data_dir() -> str:
    """
    Retrieve the shared data directory path from the LocalFileSystem block.

    Returns
    -------
    str
        Absolute path to the data directory.
    """
    fs_block = LocalFileSystem.load("filesystem_data_dir")
    return fs_block.basepath


def get_secret(secret_name: str) -> str:
    """
    Load a secret value from a Prefect Secret block.

    Parameters
    ----------
    secret_name : str
        Name of the secret block to load.

    Returns
    -------
    str
        The secret value.
    """
    secret_block = Secret.load(secret_name)
    return secret_block.get()


# ----------------------------------------------------------------------
# Task definitions
# ----------------------------------------------------------------------


@task(retries=1, retry_delay_seconds=10, name="Load and Modify Data")
def load_and_modify_data(data_dir: str) -> None:
    """
    Execute the Docker container that loads and modifies the raw supplier CSV.

    Parameters
    ----------
    data_dir : str
        Path to the shared data directory.
    """
    env = {
        "DATASET_ID": "2",
        "TABLE_NAME_PREFIX": "JOT_",
        "DATA_DIR": data_dir,
    }

    docker_task = DockerContainer(
        image="i2t-backendwithintertwino6-load-and-modify:latest",
        env=env,
        network=get_secret("docker_network_app"),
        stream_output=True,
    )
    docker_task.run()


@task(retries=1, retry_delay_seconds=10, name="Entity Reconciliation (Wikidata)")
def reconcile_supplier_names(data_dir: str) -> None:
    """
    Run the Docker container that reconciles supplier names against Wikidata.

    Parameters
    ----------
    data_dir : str
        Path to the shared data directory.
    """
    env = {
        "PRIMARY_COLUMN": "supplier_name",
        "RECONCILIATOR_ID": "wikidataEntity",
        "DATASET_ID": "2",
        "DATA_DIR": data_dir,
    }

    docker_task = DockerContainer(
        image="i2t-backendwithintertwino6-reconciliation:latest",
        env=env,
        network=get_secret("docker_network_app"),
        stream_output=True,
    )
    docker_task.run()


@task(retries=1, retry_delay_seconds=10, name="Save Final Data")
def save_final_data(data_dir: str) -> None:
    """
    Execute the Docker container that saves the enriched supplier data back to CSV.

    Parameters
    ----------
    data_dir : str
        Path to the shared data directory.
    """
    env = {
        "DATASET_ID": "2",
        "DATA_DIR": data_dir,
    }

    docker_task = DockerContainer(
        image="i2t-backendwithintertwino6-save:latest",
        env=env,
        network=get_secret("docker_network_app"),
        stream_output=True,
    )
    docker_task.run()


# ----------------------------------------------------------------------
# Flow definition
# ----------------------------------------------------------------------


@flow(
    name="procurement_supplier_validation_pipeline",
    task_runner=SequentialTaskRunner(),
)
def procurement_supplier_validation_pipeline() -> None:
    """
    Orchestrates the supplier validation pipeline:
    1. Load and modify raw data.
    2. Reconcile supplier names using Wikidata.
    3. Save the enriched data.
    """
    data_dir = get_data_dir()

    # Step 1: Load and modify data
    load_and_modify_data.submit(data_dir)

    # Step 2: Reconcile supplier names (depends on step 1)
    reconcile_supplier_names.submit(data_dir)

    # Step 3: Save final data (depends on step 2)
    save_final_data.submit(data_dir)


# ----------------------------------------------------------------------
# Entry point
# ----------------------------------------------------------------------


if __name__ == "__main__":
    procurement_supplier_validation_pipeline()