# Generated by Airflow DAG Generator on 2024-06-12 10:45:00 UTC
"""
DAG: create_customer_pipeline
Description: Comprehensive Pipeline Description
Pattern: sequential
"""

from datetime import datetime, timedelta

from airflow import DAG
from airflow.decorators import task
from airflow.exceptions import AirflowException
from airflow.utils.trigger_rule import TriggerRule
from airflow.utils.helpers import chain
from airflow.hooks.base import BaseHook

# Default arguments applied to all tasks
default_args = {
    "owner": "airflow",
    "depends_on_past": False,
    "retries": 1,
    "retry_delay": timedelta(minutes=5),
    "email_on_failure": False,
    "email_on_retry": False,
}


def get_magento_connection():
    """
    Retrieve Magento GraphQL API connection details from Airflow connections.
    """
    try:
        conn = BaseHook.get_connection("magento_graphql_api")
        return {
            "host": conn.host,
            "login": conn.login,
            "password": conn.password,
            "schema": conn.schema,
            "extra": conn.extra_dejson,
        }
    except Exception as exc:
        raise AirflowException(f"Failed to retrieve Magento connection: {exc}") from exc


with DAG(
    dag_id="create_customer_pipeline",
    description="Comprehensive Pipeline Description",
    schedule_interval=None,  # Disabled schedule
    start_date=datetime(2024, 1, 1),
    catchup=False,
    default_args=default_args,
    tags=["magento", "customer"],
    max_active_runs=1,
    render_template_as_native_obj=True,
) as dag:

    @task(
        task_id="create_customer",
        retries=1,
        retry_delay=timedelta(minutes=5),
        trigger_rule=TriggerRule.ALL_SUCCESS,
    )
    def create_customer():
        """
        Create a new customer via Magento GraphQL API.
        """
        conn_info = get_magento_connection()
        # Placeholder for actual API call
        try:
            # Example: response = requests.post(..., json=payload, auth=(conn_info['login'], conn_info['password']))
            # Simulate successful creation
            customer_id = "cust_12345"
            return {"customer_id": customer_id}
        except Exception as exc:
            raise AirflowException(f"Error creating customer: {exc}") from exc

    @task(
        task_id="generate_customer_token",
        retries=1,
        retry_delay=timedelta(minutes=5),
        trigger_rule=TriggerRule.ALL_SUCCESS,
    )
    def generate_customer_token(create_customer_output: dict):
        """
        Generate a token for the newly created customer.
        """
        conn_info = get_magento_connection()
        customer_id = create_customer_output.get("customer_id")
        if not customer_id:
            raise AirflowException("Missing customer_id from create_customer task.")
        try:
            # Placeholder for token generation API call
            token = f"token_{customer_id}"
            return {"customer_id": customer_id, "token": token}
        except Exception as exc:
            raise AirflowException(f"Error generating token: {exc}") from exc

    @task(
        task_id="get_customer_info",
        retries=1,
        retry_delay=timedelta(minutes=5),
        trigger_rule=TriggerRule.ALL_SUCCESS,
    )
    def get_customer_info(token_output: dict):
        """
        Retrieve detailed information about the customer using the token.
        """
        conn_info = get_magento_connection()
        token = token_output.get("token")
        if not token:
            raise AirflowException("Missing token from generate_customer_token task.")
        try:
            # Placeholder for customer info API call
            customer_info = {
                "customer_id": token_output["customer_id"],
                "email": "customer@example.com",
                "first_name": "John",
                "last_name": "Doe",
            }
            return customer_info
        except Exception as exc:
            raise AirflowException(f"Error fetching customer info: {exc}") from exc

    # Define task pipeline
    create_customer_task = create_customer()
    generate_token_task = generate_customer_token(create_customer_task)
    get_info_task = get_customer_info(generate_token_task)

    # Set explicit dependencies (sequential pattern)
    chain(create_customer_task, generate_token_task, get_info_task)