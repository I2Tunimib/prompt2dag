# Generated by Prefect Pipeline Generator
# Date: 2024-06-13
# Prefect version: 2.14.0
# Pipeline: create_customer_pipeline

import json
import os
from typing import Any, Dict

import requests
from prefect import flow, task
from prefect.task_runners import SequentialTaskRunner
from prefect.blocks.system import Secret
from prefect.utilities.logging import get_logger

logger = get_logger(__name__)

# -------------------------------------------------------------------------
# Helper Functions
# -------------------------------------------------------------------------

def get_magento_secret() -> Dict[str, str]:
    """
    Retrieve Magento GraphQL API credentials from a Prefect Secret block.

    Returns:
        dict: Dictionary containing at least ``endpoint`` and ``auth_token``.
    """
    secret_block = Secret.load("magento_graphql_api")
    secret_json = secret_block.get()
    try:
        credentials = json.loads(secret_json)
    except json.JSONDecodeError as exc:
        logger.error("Failed to decode Magento secret JSON: %s", exc)
        raise
    required_keys = {"endpoint", "auth_token"}
    if not required_keys.issubset(credentials):
        missing = required_keys - credentials.keys()
        raise ValueError(f"Magento secret missing required keys: {missing}")
    return credentials


def graphql_request(endpoint: str, query: str, variables: Dict[str, Any] = None, token: str = None) -> Dict[str, Any]:
    """
    Perform a GraphQL request against the Magento endpoint.

    Args:
        endpoint: Full URL to the Magento GraphQL endpoint.
        query: GraphQL query string.
        variables: Optional variables for the query.
        token: Optional bearer token for authentication.

    Returns:
        Parsed JSON response from the server.

    Raises:
        requests.HTTPError: If the HTTP request fails.
    """
    headers = {"Content-Type": "application/json"}
    if token:
        headers["Authorization"] = f"Bearer {token}"

    payload = {"query": query, "variables": variables or {}}
    response = requests.post(endpoint, json=payload, headers=headers, timeout=30)
    response.raise_for_status()
    return response.json()


# -------------------------------------------------------------------------
# Tasks
# -------------------------------------------------------------------------

@task(retries=1, retry_delay_seconds=5)
def create_customer(customer_data: Dict[str, Any]) -> str:
    """
    Create a new Magento customer via GraphQL mutation.

    Args:
        customer_data: Dictionary containing customer fields required by Magento.

    Returns:
        The newly created customer's ID.

    Raises:
        RuntimeError: If the GraphQL response contains errors.
    """
    creds = get_magento_secret()
    endpoint = creds["endpoint"]
    token = creds["auth_token"]

    mutation = """
    mutation createCustomer($input: CustomerCreateInput!) {
      createCustomer(input: $input) {
        customer {
          id
        }
        user_errors {
          message
          code
        }
      }
    }
    """
    variables = {"input": customer_data}
    logger.info("Creating Magento customer...")
    result = graphql_request(endpoint, mutation, variables, token)

    errors = result.get("errors")
    if errors:
        logger.error("GraphQL errors while creating customer: %s", errors)
        raise RuntimeError(f"GraphQL errors: {errors}")

    data = result.get("data", {})
    create_info = data.get("createCustomer", {})
    user_errors = create_info.get("user_errors", [])
    if user_errors:
        logger.error("User errors while creating customer: %s", user_errors)
        raise RuntimeError(f"User errors: {user_errors}")

    customer_id = create_info.get("customer", {}).get("id")
    if not customer_id:
        raise RuntimeError("Customer ID not returned from Magento.")
    logger.info("Customer created with ID: %s", customer_id)
    return customer_id


@task(retries=1, retry_delay_seconds=5)
def generate_customer_token(customer_id: str) -> str:
    """
    Generate an authentication token for the newly created customer.

    Args:
        customer_id: The Magento customer ID.

    Returns:
        A JWT token string for the customer.

    Raises:
        RuntimeError: If token generation fails.
    """
    creds = get_magento_secret()
    endpoint = creds["endpoint"]
    admin_token = creds["auth_token"]

    mutation = """
    mutation generateToken($email: String!, $password: String!) {
      generateCustomerToken(email: $email, password: $password) {
        token
        user_errors {
          message
          code
        }
      }
    }
    """
    # In a real scenario, email/password would be retrieved from the original payload.
    # Here we assume they are part of the customer data stored elsewhere.
    # For demonstration, we fetch them via a placeholder function.
    email, password = _lookup_credentials_for_customer(customer_id)

    variables = {"email": email, "password": password}
    logger.info("Generating token for customer ID %s...", customer_id)
    result = graphql_request(endpoint, mutation, variables, admin_token)

    errors = result.get("errors")
    if errors:
        logger.error("GraphQL errors while generating token: %s", errors)
        raise RuntimeError(f"GraphQL errors: {errors}")

    token_data = result.get("data", {}).get("generateCustomerToken", {})
    user_errors = token_data.get("user_errors", [])
    if user_errors:
        logger.error("User errors while generating token: %s", user_errors)
        raise RuntimeError(f"User errors: {user_errors}")

    token = token_data.get("token")
    if not token:
        raise RuntimeError("Token not returned from Magento.")
    logger.info("Token generated for customer ID %s.", customer_id)
    return token


@task(retries=1, retry_delay_seconds=5)
def get_customer_info(customer_token: str) -> Dict[str, Any]:
    """
    Retrieve detailed information about the customer using their token.

    Args:
        customer_token: Authentication token for the customer.

    Returns:
        Dictionary containing customer information.

    Raises:
        RuntimeError: If the query fails.
    """
    creds = get_magento_secret()
    endpoint = creds["endpoint"]

    query = """
    query {
      customer {
        id
        email
        firstname
        lastname
        created_at
      }
    }
    """
    logger.info("Fetching customer info using token...")
    result = graphql_request(endpoint, query, token=customer_token)

    errors = result.get("errors")
    if errors:
        logger.error("GraphQL errors while fetching customer info: %s", errors)
        raise RuntimeError(f"GraphQL errors: {errors}")

    customer_info = result.get("data", {}).get("customer")
    if not customer_info:
        raise RuntimeError("Customer information not returned.")
    logger.info("Customer info retrieved: %s", customer_info)
    return customer_info


def _lookup_credentials_for_customer(customer_id: str) -> tuple:
    """
    Placeholder helper to retrieve email and password for a given customer ID.
    In production, replace this with a secure lookup (e.g., database query).

    Args:
        customer_id: Magento customer ID.

    Returns:
        Tuple of (email, password).
    """
    # For demonstration purposes only.
    # WARNING: Storing plain passwords is insecure.
    raise NotImplementedError(
        "Credential lookup for customer ID %s must be implemented." % customer_id
    )


# -------------------------------------------------------------------------
# Flow Definition
# -------------------------------------------------------------------------

@flow(
    name="create_customer_pipeline",
    description="Comprehensive Pipeline Description",
    task_runner=SequentialTaskRunner(),
)
def create_customer_pipeline(customer_payload: Dict[str, Any]) -> Dict[str, Any]:
    """
    Orchestrates the creation of a Magento customer, token generation,
    and retrieval of customer information.

    Args:
        customer_payload: Dictionary containing the fields required to create
                          a customer (e.g., email, password, firstname, lastname).

    Returns:
        The final customer information dictionary.
    """
    # Step 1: Create the customer
    customer_id = create_customer(customer_payload)

    # Step 2: Generate a token for the newly created customer
    token = generate_customer_token(customer_id)

    # Step 3: Retrieve detailed customer information
    info = get_customer_info(token)

    return info


# -------------------------------------------------------------------------
# Entry Point
# -------------------------------------------------------------------------

if __name__ == "__main__":
    # Example payload; replace with real data when executing.
    example_payload = {
        "email": "john.doe@example.com",
        "password": "SecurePass123!",
        "firstname": "John",
        "lastname": "Doe"
    }

    try:
        result = create_customer_pipeline(example_payload)
        logger.info("Pipeline completed successfully. Result: %s", result)
    except Exception as exc:
        logger.exception("Pipeline execution failed: %s", exc)
        raise

# -------------------------------------------------------------------------
# Deployment Configuration (for reference)
# -------------------------------------------------------------------------
# Flow name: create_customer_pipeline
# Deployment name: create_customer_pipeline_deployment
# Work pool: default-agent-pool
# Schedule: Disabled (no schedule)
# Task runner: SequentialTaskRunner
# Prefect version: 2.14.0
# -------------------------------------------------------------------------