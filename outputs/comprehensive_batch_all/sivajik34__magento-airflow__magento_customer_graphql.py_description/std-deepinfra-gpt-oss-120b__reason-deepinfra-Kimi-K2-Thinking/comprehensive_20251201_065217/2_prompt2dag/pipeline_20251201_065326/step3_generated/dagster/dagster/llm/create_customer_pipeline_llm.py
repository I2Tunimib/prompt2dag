# Generated by Dagster Code Generator
# Date: 2024-06-28
# Dagster version: 1.5.0

from typing import Dict, Any

from dagster import (
    op,
    job,
    In,
    Out,
    RetryPolicy,
    ResourceDefinition,
    resource,
    fs_io_manager,
    InProcessExecutor,
    ConfigurableResource,
    InitResourceContext,
)


class MagentoGraphQLAPI(ConfigurableResource):
    """Placeholder for Magento GraphQL API client.

    In a real implementation, this would encapsulate authentication,
    endpoint configuration, and query execution utilities.
    """

    endpoint: str = "https://example.com/graphql"
    api_key: str = "YOUR_API_KEY"

    def execute_query(self, query: str, variables: Dict[str, Any] = None) -> Dict[str, Any]:
        """Execute a GraphQL query against the Magento endpoint.

        This stub returns a mocked response; replace with actual HTTP logic.
        """
        # TODO: Implement real HTTP request logic.
        return {"data": "mocked_response"}


magento_graphql_api_resource: ResourceDefinition = MagentoGraphQLAPI.to_resource()


@op(
    name="Create Customer",
    description="Creates a new customer in Magento via GraphQL.",
    out=Out(dict, description="Dictionary containing the newly created customer's ID."),
    retry_policy=RetryPolicy(max_retries=1),
    required_resource_keys={"magento_graphql_api"},
)
def create_customer(context: InitResourceContext) -> Dict[str, Any]:
    """Create a customer using the Magento GraphQL API.

    Returns:
        dict: A payload containing at least the ``customer_id`` key.
    """
    api: MagentoGraphQLAPI = context.resources.magento_graphql_api
    query = """
    mutation CreateCustomer($input: CustomerInput!) {
        createCustomer(input: $input) {
            customer {
                id
            }
        }
    }
    """
    variables = {
        "input": {
            "email": "new_customer@example.com",
            "firstname": "John",
            "lastname": "Doe",
            "password": "SecurePass123!",
        }
    }
    response = api.execute_query(query, variables)
    # Mocked extraction logic â€“ replace with real response handling.
    customer_id = response.get("data", {}).get("createCustomer", {}).get("customer", {}).get("id", 1)
    context.log.info(f"Created customer with ID: {customer_id}")
    return {"customer_id": customer_id}


@op(
    name="Generate Customer Token",
    description="Generates an authentication token for the newly created customer.",
    ins={"customer": In(dict)},
    out=Out(str, description="Authentication token for the customer."),
    retry_policy=RetryPolicy(max_retries=1),
    required_resource_keys={"magento_graphql_api"},
)
def generate_customer_token(context: InitResourceContext, customer: Dict[str, Any]) -> str:
    """Generate a JWT token for a customer using Magento's GraphQL API.

    Args:
        customer (dict): Payload from ``create_customer`` containing ``customer_id``.

    Returns:
        str: Authentication token.
    """
    api: MagentoGraphQLAPI = context.resources.magento_graphql_api
    query = """
    mutation GenerateToken($email: String!, $password: String!) {
        generateCustomerToken(email: $email, password: $password) {
            token
        }
    }
    """
    variables = {
        "email": "new_customer@example.com",
        "password": "SecurePass123!",
    }
    response = api.execute_query(query, variables)
    token = response.get("data", {}).get("generateCustomerToken", {}).get("token", "mocked_token")
    context.log.info(f"Generated token for customer ID {customer.get('customer_id')}")
    return token


@op(
    name="Get Customer Info",
    description="Retrieves detailed information for the authenticated customer.",
    ins={"token": In(str)},
    out=Out(dict, description="Dictionary with customer details."),
    retry_policy=RetryPolicy(max_retries=1),
    required_resource_keys={"magento_graphql_api"},
)
def get_customer_info(context: InitResourceContext, token: str) -> Dict[str, Any]:
    """Fetch customer details using the provided authentication token.

    Args:
        token (str): Customer authentication token.

    Returns:
        dict: Customer information payload.
    """
    api: MagentoGraphQLAPI = context.resources.magento_graphql_api
    query = """
    query {
        customer {
            id
            email
            firstname
            lastname
        }
    }
    """
    # In a real implementation, the token would be sent in HTTP headers.
    response = api.execute_query(query)
    customer_info = response.get("data", {}).get("customer", {})
    context.log.info(f"Retrieved info for customer ID {customer_info.get('id')}")
    return customer_info


@job(
    name="create_customer_pipeline",
    description="Comprehensive Pipeline Description",
    resource_defs={
        "magento_graphql_api": magento_graphql_api_resource,
        "io_manager": fs_io_manager,
    },
    executor_def=InProcessExecutor(),
)
def create_customer_pipeline():
    """Dagster job orchestrating customer creation, token generation, and info retrieval.

    Execution order:
        1. ``create_customer``
        2. ``generate_customer_token`` (depends on ``create_customer``)
        3. ``get_customer_info`` (depends on ``generate_customer_token``)
    """
    customer = create_customer()
    token = generate_customer_token(customer)
    get_customer_info(token)