# Generated by AI on 2024-06-28
# Airflow DAG: create_customer_pipeline
# Description: Sequential pipeline to create a Magento customer, generate a token, and retrieve customer info.

import logging
from datetime import datetime, timedelta

from airflow import DAG
from airflow.decorators import task
from airflow.utils.dates import days_ago
from airflow.hooks.base import BaseHook
from airflow.exceptions import AirflowException

# Default arguments applied to all tasks
default_args = {
    "owner": "airflow",
    "retries": 1,
    "retry_delay": timedelta(minutes=5),
    "depends_on_past": False,
    "email_on_failure": False,
    "email_on_retry": False,
}

# Define the DAG
with DAG(
    dag_id="create_customer_pipeline",
    description="Sequential pipeline to create a Magento customer, generate a token, and retrieve customer info.",
    default_args=default_args,
    schedule_interval=None,          # Disabled schedule
    start_date=days_ago(1),
    catchup=False,
    tags=["magento", "customer"],
    max_active_runs=1,
) as dag:

    @task(task_id="create_customer")
    def create_customer():
        """
        Create a new customer in Magento via GraphQL API.
        Returns the newly created customer's ID.
        """
        try:
            conn = BaseHook.get_connection("magento_graphql_api")
            endpoint = f"{conn.host.rstrip('/')}/graphql"
            headers = {"Content-Type": "application/json"}
            # Example payload – replace with actual mutation
            payload = {
                "query": """
                mutation {
                  createCustomer(input: {
                    email: "new_customer@example.com",
                    firstname: "John",
                    lastname: "Doe",
                    password: "SecurePass123"
                  }) {
                    customer {
                      id
                    }
                  }
                }
                """
            }
            import requests
            response = requests.post(endpoint, json=payload, headers=headers, auth=(conn.login, conn.password))
            response.raise_for_status()
            data = response.json()
            customer_id = data["data"]["createCustomer"]["customer"]["id"]
            logging.info("Customer created with ID: %s", customer_id)
            return customer_id
        except Exception as exc:
            logging.error("Failed to create customer: %s", exc)
            raise AirflowException(f"create_customer task failed: {exc}")

    @task(task_id="generate_customer_token")
    def generate_customer_token(customer_id: str):
        """
        Generate an authentication token for the newly created customer.
        Returns the token string.
        """
        try:
            conn = BaseHook.get_connection("magento_graphql_api")
            endpoint = f"{conn.host.rstrip('/')}/graphql"
            headers = {"Content-Type": "application/json"}
            # Example payload – replace with actual mutation
            payload = {
                "query": """
                mutation {
                  generateCustomerToken(email: "new_customer@example.com", password: "SecurePass123") {
                    token
                  }
                }
                """
            }
            import requests
            response = requests.post(endpoint, json=payload, headers=headers, auth=(conn.login, conn.password))
            response.raise_for_status()
            data = response.json()
            token = data["data"]["generateCustomerToken"]["token"]
            logging.info("Generated token for customer %s", customer_id)
            return token
        except Exception as exc:
            logging.error("Failed to generate token: %s", exc)
            raise AirflowException(f"generate_customer_token task failed: {exc}")

    @task(task_id="get_customer_info")
    def get_customer_info(token: str):
        """
        Retrieve detailed information about the customer using the token.
        """
        try:
            conn = BaseHook.get_connection("magento_graphql_api")
            endpoint = f"{conn.host.rstrip('/')}/graphql"
            headers = {
                "Content-Type": "application/json",
                "Authorization": f"Bearer {token}",
            }
            # Example payload – replace with actual query
            payload = {
                "query": """
                {
                  customer {
                    email
                    firstname
                    lastname
                  }
                }
                """
            }
            import requests
            response = requests.post(endpoint, json=payload, headers=headers)
            response.raise_for_status()
            data = response.json()
            customer_info = data["data"]["customer"]
            logging.info("Retrieved customer info: %s", customer_info)
            return customer_info
        except Exception as exc:
            logging.error("Failed to retrieve customer info: %s", exc)
            raise AirflowException(f"get_customer_info task failed: {exc}")

    # Define task dependencies (sequential flow)
    customer_id = create_customer()
    token = generate_customer_token(customer_id)
    get_customer_info(token)

    # Explicitly set dependencies (optional, for clarity)
    # create_customer >> generate_customer_token >> get_customer_info
    # The above chaining is already handled by passing XCom values.