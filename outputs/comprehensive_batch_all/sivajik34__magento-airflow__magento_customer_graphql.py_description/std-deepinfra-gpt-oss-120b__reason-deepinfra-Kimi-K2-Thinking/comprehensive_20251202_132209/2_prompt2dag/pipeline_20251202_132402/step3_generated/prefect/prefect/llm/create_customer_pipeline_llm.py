# Generated by Prefect Pipeline Generator
# Date: 2024-06-28
# Prefect version: 2.14.0
# Flow: create_customer_pipeline
# Deployment: create_customer_pipeline_deployment
# Work pool: default-agent-pool
# Task runner: SequentialTaskRunner

import json
from typing import Dict, Any

import requests
from prefect import flow, task
from prefect.task_runners import SequentialTaskRunner
from prefect.blocks.system import Secret
from prefect.exceptions import PrefectException


@task(retries=1, retry_delay_seconds=5)
def create_customer(api_endpoint: str, api_token: str, customer_data: Dict[str, Any]) -> Dict[str, Any]:
    """
    Create a new customer in Magento via GraphQL mutation.

    Args:
        api_endpoint: The Magento GraphQL endpoint URL.
        api_token: Authentication token for the Magento API.
        customer_data: Dictionary containing customer fields (e.g., email, firstname, lastname).

    Returns:
        A dictionary with the created customer's details, typically including ``id`` and ``email``.

    Raises:
        PrefectException: If the API response contains errors or an unexpected status code.
    """
    mutation = """
    mutation createCustomer($input: CustomerCreateInput!) {
      createCustomer(input: $input) {
        customer {
          id
          email
        }
      }
    }
    """
    variables = {"input": customer_data}
    headers = {
        "Authorization": f"Bearer {api_token}",
        "Content-Type": "application/json",
    }

    response = requests.post(
        api_endpoint,
        json={"query": mutation, "variables": variables},
        headers=headers,
        timeout=30,
    )

    if response.status_code != 200:
        raise PrefectException(f"Failed to create customer: HTTP {response.status_code}")

    payload = response.json()
    if "errors" in payload:
        raise PrefectException(f"GraphQL errors: {payload['errors']}")

    customer = payload["data"]["createCustomer"]["customer"]
    return {"id": customer["id"], "email": customer["email"]}


@task(retries=1, retry_delay_seconds=5)
def generate_customer_token(
    api_endpoint: str, api_token: str, customer_credentials: Dict[str, str]
) -> str:
    """
    Generate a JWT token for a Magento customer.

    Args:
        api_endpoint: The Magento GraphQL endpoint URL.
        api_token: Authentication token for the Magento API.
        customer_credentials: Dictionary with ``email`` and ``password`` keys.

    Returns:
        A JWT token string for the authenticated customer.

    Raises:
        PrefectException: If token generation fails.
    """
    mutation = """
    mutation generateToken($email: String!, $password: String!) {
      generateCustomerToken(email: $email, password: $password) {
        token
      }
    }
    """
    variables = {
        "email": customer_credentials["email"],
        "password": customer_credentials["password"],
    }
    headers = {
        "Authorization": f"Bearer {api_token}",
        "Content-Type": "application/json",
    }

    response = requests.post(
        api_endpoint,
        json={"query": mutation, "variables": variables},
        headers=headers,
        timeout=30,
    )

    if response.status_code != 200:
        raise PrefectException(f"Failed to generate token: HTTP {response.status_code}")

    payload = response.json()
    if "errors" in payload:
        raise PrefectException(f"GraphQL errors: {payload['errors']}")

    token = payload["data"]["generateCustomerToken"]["token"]
    return token


@task(retries=1, retry_delay_seconds=5)
def get_customer_info(api_endpoint: str, customer_token: str) -> Dict[str, Any]:
    """
    Retrieve detailed information about a Magento customer using their JWT token.

    Args:
        api_endpoint: The Magento GraphQL endpoint URL.
        customer_token: JWT token obtained from ``generate_customer_token``.

    Returns:
        A dictionary containing customer information (e.g., id, email, firstname, lastname).

    Raises:
        PrefectException: If the query fails or returns errors.
    """
    query = """
    query {
      customer {
        id
        email
        firstname
        lastname
      }
    }
    """
    headers = {
        "Authorization": f"Bearer {customer_token}",
        "Content-Type": "application/json",
    }

    response = requests.post(
        api_endpoint,
        json={"query": query},
        headers=headers,
        timeout=30,
    )

    if response.status_code != 200:
        raise PrefectException(f"Failed to fetch customer info: HTTP {response.status_code}")

    payload = response.json()
    if "errors" in payload:
        raise PrefectException(f"GraphQL errors: {payload['errors']}")

    customer = payload["data"]["customer"]
    return customer


@flow(name="create_customer_pipeline", task_runner=SequentialTaskRunner())
def create_customer_pipeline():
    """
    Orchestrates the creation of a Magento customer, token generation,
    and retrieval of customer information in a sequential manner.
    """
    # Load Magento GraphQL API secret block
    magento_secret: Secret = Secret.load("magento_graphql_api")
    secret_dict = json.loads(magento_secret.get())
    api_endpoint = secret_dict["endpoint"]
    api_token = secret_dict["access_token"]

    # Example payload for creating a customer; replace with real data as needed
    new_customer_data = {
        "email": "new.customer@example.com",
        "firstname": "New",
        "lastname": "Customer",
        "password": "StrongPassword123!",
    }

    # Step 1: Create the customer
    created_customer = create_customer(
        api_endpoint=api_endpoint,
        api_token=api_token,
        customer_data=new_customer_data,
    )

    # Step 2: Generate a token for the newly created customer
    token = generate_customer_token(
        api_endpoint=api_endpoint,
        api_token=api_token,
        customer_credentials={
            "email": created_customer["email"],
            "password": new_customer_data["password"],
        },
    )

    # Step 3: Retrieve detailed customer information using the token
    customer_info = get_customer_info(
        api_endpoint=api_endpoint,
        customer_token=token,
    )

    # For demonstration purposes, we simply log the final result
    # In a real pipeline you might store this data or trigger downstream processes
    print("Customer creation pipeline completed successfully.")
    print("Created Customer ID:", created_customer["id"])
    print("Customer Info:", json.dumps(customer_info, indent=2))


if __name__ == "__main__":
    # Execute the flow locally; in production this flow would be deployed via Prefect UI/CLI
    create_customer_pipeline()