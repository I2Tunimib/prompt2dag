# Generated by Prefect 2.14.0
# Flow Name: create_customer_pipeline
# Deployment Name: create_customer_pipeline_deployment
# Work Pool: default-agent-pool
# Task Runner: SequentialTaskRunner

from prefect import flow, task, get_run_logger
from prefect.tasks import task_input_hash
from prefect.blocks.secrets import Secret
from prefect_docker import DockerContainer
from prefect_docker.containers import run_container
from prefect_docker.images import pull_image
from prefect_docker.credentials import DockerHost
from prefect import flow, task, get_run_logger
from prefect.task_runners import SequentialTaskRunner

# Load the Magento GraphQL API secret
magento_api_secret = Secret.load("magento_default")

@task(retries=1, cache_key_fn=task_input_hash)
def create_customer():
    """
    Task to create a customer using the Magento GraphQL API.
    """
    logger = get_run_logger()
    logger.info("Creating customer...")
    # Example API call (replace with actual implementation)
    # response = requests.post(magento_api_secret.get(), json={"query": "mutation { createCustomer(...) { ... } }"})
    # logger.info(f"Customer created: {response.json()}")
    logger.info("Customer created successfully.")

@task(retries=1, cache_key_fn=task_input_hash)
def generate_customer_token():
    """
    Task to generate a customer token using the Magento GraphQL API.
    """
    logger = get_run_logger()
    logger.info("Generating customer token...")
    # Example API call (replace with actual implementation)
    # response = requests.post(magento_api_secret.get(), json={"query": "mutation { generateCustomerToken(...) { ... } }"})
    # logger.info(f"Customer token generated: {response.json()}")
    logger.info("Customer token generated successfully.")

@task(retries=1, cache_key_fn=task_input_hash)
def get_customer_info():
    """
    Task to get customer information using the Magento GraphQL API.
    """
    logger = get_run_logger()
    logger.info("Getting customer information...")
    # Example API call (replace with actual implementation)
    # response = requests.post(magento_api_secret.get(), json={"query": "query { customer { ... } }"})
    # logger.info(f"Customer information: {response.json()}")
    logger.info("Customer information retrieved successfully.")

@flow(name="create_customer_pipeline", task_runner=SequentialTaskRunner)
def create_customer_pipeline():
    """
    Flow to create a customer, generate a customer token, and get customer information.
    """
    logger = get_run_logger()
    logger.info("Starting create_customer_pipeline...")

    # Task dependencies
    create_customer_result = create_customer()
    generate_customer_token_result = generate_customer_token(wait_for=[create_customer_result])
    get_customer_info_result = get_customer_info(wait_for=[generate_customer_token_result])

    logger.info("create_customer_pipeline completed successfully.")

if __name__ == "__main__":
    create_customer_pipeline()