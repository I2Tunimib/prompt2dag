# Generated by Airflow DAG Generator
# Date: 2023-10-04
# Airflow Version: 2.x
# Description: create_customer_pipeline

from airflow import DAG
from airflow.operators.python import PythonOperator
from airflow.utils.dates import days_ago
from airflow.providers.http.operators.http import SimpleHttpOperator
from airflow.exceptions import AirflowException
import requests

# Default arguments for the DAG
default_args = {
    'owner': 'airflow',
    'retries': 1,
    'retry_delay': timedelta(minutes=5),
}

# Define the DAG
with DAG(
    dag_id='create_customer_pipeline',
    default_args=default_args,
    schedule_interval=None,
    start_date=days_ago(1),
    catchup=False,
    tags=['customer', 'magento'],
) as dag:

    # Task: Create Customer
    def create_customer(**kwargs):
        try:
            # Example GraphQL query to create a customer
            query = """
            mutation {
                createCustomer(
                    input: {
                        email: "example@example.com"
                        firstname: "John"
                        lastname: "Doe"
                        password: "password123"
                    }
                ) {
                    customer {
                        id
                        email
                        firstname
                        lastname
                    }
                }
            }
            """
            response = requests.post(
                'http://magento_default/graphql',
                json={'query': query},
                headers={'Content-Type': 'application/json'}
            )
            response.raise_for_status()
            return response.json()
        except requests.exceptions.RequestException as e:
            raise AirflowException(f"Failed to create customer: {e}")

    create_customer_task = PythonOperator(
        task_id='create_customer',
        python_callable=create_customer,
        provide_context=True,
        retries=1,
    )

    # Task: Generate Customer Token
    def generate_customer_token(**kwargs):
        ti = kwargs['ti']
        customer_data = ti.xcom_pull(task_ids='create_customer')
        customer_email = customer_data['data']['createCustomer']['customer']['email']

        try:
            # Example GraphQL query to generate a customer token
            query = f"""
            mutation {{
                generateCustomerToken(email: "{customer_email}", password: "password123") {{
                    token
                }}
            }}
            """
            response = requests.post(
                'http://magento_default/graphql',
                json={'query': query},
                headers={'Content-Type': 'application/json'}
            )
            response.raise_for_status()
            return response.json()
        except requests.exceptions.RequestException as e:
            raise AirflowException(f"Failed to generate customer token: {e}")

    generate_customer_token_task = PythonOperator(
        task_id='generate_customer_token',
        python_callable=generate_customer_token,
        provide_context=True,
        retries=1,
    )

    # Task: Get Customer Info
    def get_customer_info(**kwargs):
        ti = kwargs['ti']
        token_data = ti.xcom_pull(task_ids='generate_customer_token')
        customer_token = token_data['data']['generateCustomerToken']['token']

        try:
            # Example GraphQL query to get customer info
            query = """
            query {
                customer {
                    id
                    email
                    firstname
                    lastname
                }
            }
            """
            headers = {
                'Content-Type': 'application/json',
                'Authorization': f'Bearer {customer_token}'
            }
            response = requests.post(
                'http://magento_default/graphql',
                json={'query': query},
                headers=headers
            )
            response.raise_for_status()
            return response.json()
        except requests.exceptions.RequestException as e:
            raise AirflowException(f"Failed to get customer info: {e}")

    get_customer_info_task = PythonOperator(
        task_id='get_customer_info',
        python_callable=get_customer_info,
        provide_context=True,
        retries=1,
    )

    # Set task dependencies
    create_customer_task >> generate_customer_token_task >> get_customer_info_task