# Generated by Prefect Pipeline Generator
# Date: 2024-06-28
# Description: Prefect 2.x flow for the "check_pcd_sftp_folder_pipeline" ETL pipeline.

import json
import logging
import smtplib
import ssl
from typing import Any, Dict

from prefect import flow, task, get_run_logger
from prefect.task_runners import ConcurrentTaskRunner
from prefect_kubernetes import KubernetesJob
from prefect.blocks.system import Secret

# ----------------------------------------------------------------------
# Helper functions
# ----------------------------------------------------------------------


def _run_kubernetes_job(block_name: str, job_name: str) -> Dict[str, Any]:
    """
    Load a ``KubernetesJob`` block and execute the job.

    Args:
        block_name: Name of the Prefect block that stores the KubernetesJob definition.
        job_name: Human‑readable name for logging purposes.

    Returns:
        The job's result payload as a dictionary.

    Raises:
        RuntimeError: If the job fails to start or complete successfully.
    """
    logger = get_run_logger()
    logger.info("Loading KubernetesJob block '%s' for %s", block_name, job_name)

    try:
        k8s_job: KubernetesJob = KubernetesJob.load(block_name)
    except Exception as exc:
        logger.error("Failed to load KubernetesJob block '%s': %s", block_name, exc)
        raise RuntimeError(f"Unable to load KubernetesJob block '{block_name}'") from exc

    logger.info("Submitting Kubernetes job for %s", job_name)
    try:
        result = k8s_job.run()
        logger.info("Kubernetes job for %s completed successfully", job_name)
        return result
    except Exception as exc:
        logger.error("Kubernetes job for %s failed: %s", job_name, exc)
        raise RuntimeError(f"Kubernetes job '{job_name}' failed") from exc


def _send_email(
    smtp_secret_name: str,
    subject: str,
    body: str,
    recipients: list[str],
) -> None:
    """
    Send an email using SMTP credentials stored in a Prefect ``Secret`` block.

    Args:
        smtp_secret_name: Name of the Prefect Secret block containing SMTP JSON config.
        subject: Email subject line.
        body: Plain‑text email body.
        recipients: List of email addresses to send to.

    Raises:
        RuntimeError: If sending the email fails.
    """
    logger = get_run_logger()
    logger.info("Loading SMTP credentials from secret block '%s'", smtp_secret_name)

    try:
        secret: Secret = Secret.load(smtp_secret_name)
        smtp_config = json.loads(secret.get())
        host = smtp_config["host"]
        port = smtp_config.get("port", 587)
        username = smtp_config["username"]
        password = smtp_config["password"]
        use_tls = smtp_config.get("use_tls", True)
    except Exception as exc:
        logger.error("Failed to load SMTP secret '%s': %s", smtp_secret_name, exc)
        raise RuntimeError(f"Unable to load SMTP secret '{smtp_secret_name}'") from exc

    message = f"""From: {username}
To: {", ".join(recipients)}
Subject: {subject}

{body}
"""

    context = ssl.create_default_context()
    try:
        with smtplib.SMTP(host, port) as server:
            if use_tls:
                server.starttls(context=context)
            server.login(username, password)
            server.sendmail(username, recipients, message)
        logger.info("ETL notification email sent to %s", ", ".join(recipients))
    except Exception as exc:
        logger.error("Failed to send email: %s", exc)
        raise RuntimeError("Email notification failed") from exc


# ----------------------------------------------------------------------
# Prefect tasks
# ----------------------------------------------------------------------


@task(name="Check PCD SFTP Folder", retries=0)
def check_pcd_sftp_folder() -> Dict[str, Any]:
    """
    Validate the presence and integrity of the PCD SFTP folder using a
    Kubernetes job.

    Returns:
        The result payload from the Kubernetes job.
    """
    return _run_kubernetes_job(
        block_name="k8s_check_pcd_sftp_folder",
        job_name="Check PCD SFTP Folder",
    )


@task(name="Check PCD Shared Folder", retries=0)
def check_pcd_shared_folder() -> Dict[str, Any]:
    """
    Validate the presence and integrity of the PCD shared network folder
    using a Kubernetes job.

    Returns:
        The result payload from the Kubernetes job.
    """
    return _run_kubernetes_job(
        block_name="k8s_check_pcd_shared_folder",
        job_name="Check PCD Shared Folder",
    )


@task(name="Extract PCD API Data", retries=3, retry_delay_seconds=60)
def extract_pcd_api() -> Dict[str, Any]:
    """
    Extract data from the various PCD‑related HTTP APIs.
    The actual API calls are represented as placeholders; in a real
    implementation each secret would be used to authenticate and fetch data.

    Returns:
        A dictionary aggregating the extracted data.
    """
    logger = get_run_logger()
    logger.info("Starting extraction of PCD API data")

    # Placeholder for API extraction logic.
    # In production, replace with actual HTTP client calls using the secrets.
    extracted_data = {
        "financial_expense": {},
        "upcc_financial_reporting": {},
        "chc_financial_reporting": {},
        "pcn_financial_reporting": {},
        "nppcc_financial_reporting": {},
        "fiscal_year_reporting_dates": {},
        "upcc_primary_care_patient_services": {},
        "chc_primary_care_patient_services": {},
        "practitioner_role_mapping": {},
        "status_tracker": {},
        "hr_records": {},
        "provincial_risk_tracking": {},
        "decision_log": {},
        "ha_hierarchy": {},
        "uppc_budget": {},
        "chc_budget": {},
        "pcn_budget": {},
        "nppcc_budget": {},
    }

    logger.info("Completed extraction of PCD API data")
    return extracted_data


@task(name="Process and Load PCD Data", retries=2)
def process_and_load_pcd_data() -> Dict[str, Any]:
    """
    Process the extracted API data and load it into the target system using
    a Kubernetes job.

    Returns:
        The result payload from the Kubernetes job.
    """
    return _run_kubernetes_job(
        block_name="k8s_process_and_load_pcd_data",
        job_name="Process and Load PCD Data",
    )


@task(name="Send ETL Notification", retries=1)
def send_etl_notification() -> None:
    """
    Send an email notification summarising the ETL run status.
    """
    subject = "PCD ETL Pipeline Completion"
    body = (
        "The Primary Care Data (PCD) ETL pipeline has completed successfully.\n"
        "Please review the logs for detailed information."
    )
    recipients = ["etl-notifications@example.com"]

    _send_email(
        smtp_secret_name="email_smtp",
        subject=subject,
        body=body,
        recipients=recipients,
    )


# ----------------------------------------------------------------------
# Prefect flow
# ----------------------------------------------------------------------


@flow(
    name="check_pcd_sftp_folder_pipeline",
    task_runner=ConcurrentTaskRunner(),
)
def check_pcd_sftp_folder_pipeline() -> None:
    """
    Orchestrates the staged ETL pipeline for Primary Care Data (PCD).

    Execution order:
        1. Check PCD SFTP folder
        2. Check PCD shared folder (depends on step 1)
        3. Extract data from PCD APIs
        4. Process and load extracted data (depends on step 3)
        5. Send ETL completion notification (depends on step 4)
    """
    logger = get_run_logger()
    logger.info("Starting the PCD ETL pipeline")

    # Step 1: Validate SFTP folder
    sftp_result = check_pcd_sftp_folder()

    # Step 2: Validate shared network folder (depends on SFTP validation)
    shared_result = check_pcd_shared_folder(wait_for=[sftp_result])

    # Step 3: Extract data from APIs
    api_data = extract_pcd_api(wait_for=[shared_result])

    # Step 4: Process and load data
    process_result = process_and_load_pcd_data(wait_for=[api_data])

    # Step 5: Send notification
    send_etl_notification(wait_for=[process_result])

    logger.info("PCD ETL pipeline completed")


# ----------------------------------------------------------------------
# Entry point
# ----------------------------------------------------------------------


if __name__ == "__main__":
    # Running the flow directly (useful for local testing)
    check_pcd_sftp_folder_pipeline()