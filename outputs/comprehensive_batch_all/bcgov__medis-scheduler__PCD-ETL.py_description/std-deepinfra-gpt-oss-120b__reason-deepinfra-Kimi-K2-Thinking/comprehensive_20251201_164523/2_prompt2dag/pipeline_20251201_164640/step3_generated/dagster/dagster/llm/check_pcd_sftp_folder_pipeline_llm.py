# Generated by Dagster code generator
# Date: 2024-06-13
# Description: Dagster job for checking PCD SFTP and shared folders, extracting API data,
# processing and loading it, and sending an ETL notification.

from dagster import (
    op,
    job,
    RetryPolicy,
    In,
    Out,
    Nothing,
    ResourceDefinition,
    ConfigurableResource,
    InitResourceContext,
    executor,
    in_process_executor,
    k8s_job_executor,
    fs_io_manager,
)

# ----------------------------------------------------------------------
# Resource placeholders
# ----------------------------------------------------------------------


class SftpFolderResource(ConfigurableResource):
    """Placeholder for SFTP folder connection."""

    def list_files(self) -> list[str]:
        # Implement actual SFTP listing logic here
        return []


class SharedFolderResource(ConfigurableResource):
    """Placeholder for shared folder connection."""

    def list_files(self) -> list[str]:
        # Implement actual shared folder listing logic here
        return []


class KubernetesClusterResource(ConfigurableResource):
    """Placeholder for Kubernetes cluster resource used for job execution."""
    pass


class ApiFinancialExpenseResource(ConfigurableResource):
    pass


class ApiUpccFinancialReportingResource(ConfigurableResource):
    pass


class ApiChcFinancialReportingResource(ConfigurableResource):
    pass


class ApiPcnFinancialReportingResource(ConfigurableResource):
    pass


class ApiNppccFinancialReportingResource(ConfigurableResource):
    pass


class ApiFiscalYearReportingDatesResource(ConfigurableResource):
    pass


class ApiUpccPrimaryCarePatientServicesResource(ConfigurableResource):
    pass


class ApiChcPrimaryCarePatientServicesResource(ConfigurableResource):
    pass


class ApiPractitionerRoleMappingResource(ConfigurableResource):
    pass


class ApiStatusTrackerResource(ConfigurableResource):
    pass


class ApiHrRecordsResource(ConfigurableResource):
    pass


class ApiProvincialRiskTrackingResource(ConfigurableResource):
    pass


class ApiDecisionLogResource(ConfigurableResource):
    pass


class ApiHaHierarchyResource(ConfigurableResource):
    pass


class ApiUppcBudgetResource(ConfigurableResource):
    pass


class ApiChcBudgetResource(ConfigurableResource):
    pass


class ApiPcnBudgetResource(ConfigurableResource):
    pass


class ApiNppccBudgetResource(ConfigurableResource):
    pass


class EmailNotificationResource(ConfigurableResource):
    """Placeholder for ETL email notification system."""

    def send(self, subject: str, body: str) -> None:
        # Implement actual email sending logic here
        pass


# ----------------------------------------------------------------------
# Ops
# ----------------------------------------------------------------------


@op(
    name="check_pcd_sftp_folder",
    required_resource_keys={"sftp_folder_conn"},
    out=Out(list, description="List of files found in the SFTP folder."),
    retry_policy=RetryPolicy(max_retries=3),
    tags={"executor": "k8s_job_executor"},
)
def check_pcd_sftp_folder(context) -> list[str]:
    """
    Checks the PCD SFTP folder for expected files.

    Returns:
        List of file names present in the SFTP folder.
    """
    sftp: SftpFolderResource = context.resources.sftp_folder_conn
    files = sftp.list_files()
    context.log.info(f"Found {len(files)} files in SFTP folder.")
    return files


@op(
    name="check_pcd_shared_folder",
    required_resource_keys={"shared_folder_conn"},
    ins={"previous": In(Nothing)},
    out=Out(list, description="List of files found in the shared folder."),
    retry_policy=RetryPolicy(max_retries=3),
    tags={"executor": "k8s_job_executor"},
)
def check_pcd_shared_folder(context, previous: Nothing) -> list[str]:
    """
    Checks the PCD shared folder for expected files.

    Args:
        previous: Dependency placeholder; ensures this op runs after the SFTP check.

    Returns:
        List of file names present in the shared folder.
    """
    shared: SharedFolderResource = context.resources.shared_folder_conn
    files = shared.list_files()
    context.log.info(f"Found {len(files)} files in shared folder.")
    return files


@op(
    name="extract_pcd_api",
    required_resource_keys={
        "api_financial_expense_conn",
        "api_upcc_financial_reporting_conn",
        "api_chc_financial_reporting_conn",
        "api_pcn_financial_reporting_conn",
        "api_nppcc_financial_reporting_conn",
        "api_fiscal_year_reporting_dates_conn",
        "api_upcc_primary_care_patient_services_conn",
        "api_chc_primary_care_patient_services_conn",
        "api_practitioner_role_mapping_conn",
        "api_status_tracker_conn",
        "api_hr_records_conn",
        "api_provincial_risk_tracking_conn",
        "api_decision_log_conn",
        "api_ha_hierarchy_conn",
        "api_uppc_budget_conn",
        "api_chc_budget_conn",
        "api_pcn_budget_conn",
        "api_nppcc_budget_conn",
    },
    ins={"trigger": In(Nothing)},
    out=Out(dict, description="Extracted API data."),
    retry_policy=RetryPolicy(max_retries=2),
    tags={"executor": "in_process_executor"},
)
def extract_pcd_api(context, trigger: Nothing) -> dict:
    """
    Extracts data from various PCD related APIs.

    Returns:
        A dictionary containing the aggregated API data.
    """
    # Placeholder extraction logic â€“ replace with real API calls.
    context.log.info("Starting extraction from PCD APIs.")
    data = {
        "financial_expense": {},
        "upcc_financial_reporting": {},
        # ... other API payloads ...
    }
    context.log.info("Extraction completed.")
    return data


@op(
    name="process_and_load_pcd",
    required_resource_keys={"sftp_folder_conn", "shared_folder_conn"},
    ins={"api_data": In(dict)},
    out=Out(Nothing),
    retry_policy=RetryPolicy(max_retries=2),
    tags={"executor": "k8s_job_executor"},
)
def process_and_load_pcd(context, api_data: dict) -> Nothing:
    """
    Processes the extracted API data and loads it into the target system.

    Args:
        api_data: Dictionary containing data extracted from the APIs.
    """
    context.log.info("Processing API data.")
    # Insert processing logic here.
    # Example: transform, validate, and write to storage.
    context.log.info("Loading processed data to destination.")
    # Insert loading logic here.
    context.log.info("Processing and loading completed.")
    return Nothing


@op(
    name="send_etl_notification",
    required_resource_keys={"email_notification_conn"},
    ins={"trigger": In(Nothing)},
    out=Out(Nothing),
    retry_policy=RetryPolicy(max_retries=1),
    tags={"executor": "in_process_executor"},
)
def send_etl_notification(context, trigger: Nothing) -> Nothing:
    """
    Sends an email notification indicating the ETL pipeline status.

    Args:
        trigger: Dependency placeholder; ensures this runs after processing.
    """
    email: EmailNotificationResource = context.resources.email_notification_conn
    subject = "PCD ETL Pipeline Completed"
    body = "The PCD ETL pipeline has finished successfully."
    email.send(subject=subject, body=body)
    context.log.info("ETL notification email sent.")
    return Nothing


# ----------------------------------------------------------------------
# Job definition
# ----------------------------------------------------------------------


@job(
    name="check_pcd_sftp_folder_pipeline",
    description="No description provided.",
    resource_defs={
        "sftp_folder_conn": ResourceDefinition.hardcoded_resource(SftpFolderResource()),
        "shared_folder_conn": ResourceDefinition.hardcoded_resource(SharedFolderResource()),
        "kubernetes_cluster_conn": ResourceDefinition.hardcoded_resource(KubernetesClusterResource()),
        "api_financial_expense_conn": ResourceDefinition.hardcoded_resource(ApiFinancialExpenseResource()),
        "api_upcc_financial_reporting_conn": ResourceDefinition.hardcoded_resource(ApiUpccFinancialReportingResource()),
        "api_chc_financial_reporting_conn": ResourceDefinition.hardcoded_resource(ApiChcFinancialReportingResource()),
        "api_pcn_financial_reporting_conn": ResourceDefinition.hardcoded_resource(ApiPcnFinancialReportingResource()),
        "api_nppcc_financial_reporting_conn": ResourceDefinition.hardcoded_resource(ApiNppccFinancialReportingResource()),
        "api_fiscal_year_reporting_dates_conn": ResourceDefinition.hardcoded_resource(ApiFiscalYearReportingDatesResource()),
        "api_upcc_primary_care_patient_services_conn": ResourceDefinition.hardcoded_resource(ApiUpccPrimaryCarePatientServicesResource()),
        "api_chc_primary_care_patient_services_conn": ResourceDefinition.hardcoded_resource(ApiChcPrimaryCarePatientServicesResource()),
        "api_practitioner_role_mapping_conn": ResourceDefinition.hardcoded_resource(ApiPractitionerRoleMappingResource()),
        "api_status_tracker_conn": ResourceDefinition.hardcoded_resource(ApiStatusTrackerResource()),
        "api_hr_records_conn": ResourceDefinition.hardcoded_resource(ApiHrRecordsResource()),
        "api_provincial_risk_tracking_conn": ResourceDefinition.hardcoded_resource(ApiProvincialRiskTrackingResource()),
        "api_decision_log_conn": ResourceDefinition.hardcoded_resource(ApiDecisionLogResource()),
        "api_ha_hierarchy_conn": ResourceDefinition.hardcoded_resource(ApiHaHierarchyResource()),
        "api_uppc_budget_conn": ResourceDefinition.hardcoded_resource(ApiUppcBudgetResource()),
        "api_chc_budget_conn": ResourceDefinition.hardcoded_resource(ApiChcBudgetResource()),
        "api_pcn_budget_conn": ResourceDefinition.hardcoded_resource(ApiPcnBudgetResource()),
        "api_nppcc_budget_conn": ResourceDefinition.hardcoded_resource(ApiNppccBudgetResource()),
        "email_notification_conn": ResourceDefinition.hardcoded_resource(EmailNotificationResource()),
        "io_manager": fs_io_manager,
    },
    executor_def=k8s_job_executor,
)
def check_pcd_sftp_folder_pipeline():
    """
    Orchestrates the PCD ETL workflow:
    1. Checks SFTP folder.
    2. Checks shared folder.
    3. Extracts data from multiple APIs.
    4. Processes and loads the data.
    5. Sends an ETL completion notification.
    """
    sftp_files = check_pcd_sftp_folder()
    shared_files = check_pcd_shared_folder(previous=Nothing())
    api_data = extract_pcd_api(trigger=Nothing())
    process_and_load_pcd(api_data=api_data)
    send_etl_notification(trigger=Nothing())