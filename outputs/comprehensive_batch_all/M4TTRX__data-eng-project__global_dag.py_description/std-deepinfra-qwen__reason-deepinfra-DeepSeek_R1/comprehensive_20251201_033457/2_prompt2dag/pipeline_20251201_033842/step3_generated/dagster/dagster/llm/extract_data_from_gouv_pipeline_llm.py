# Generated by Dagster Code Generator
# Date: 2023-10-05
# Dagster Version: 1.5.0

from dagster import (
    job,
    op,
    In,
    Out,
    RetryPolicy,
    fs_io_manager,
    multiprocess_executor,
    resource,
)

# Resources
@resource
def data_gouv_api():
    """Resource for data.gouv.fr API."""
    pass

@resource
def redis_cache():
    """Resource for Redis Cache."""
    pass

@resource
def postgresql_db():
    """Resource for PostgreSQL Database."""
    pass

@resource
def ingestion_filesystem():
    """Resource for Ingestion Filesystem."""
    pass

@resource
def staging_filesystem():
    """Resource for Staging Filesystem."""
    pass

@resource
def sql_tmp_filesystem():
    """Resource for SQL Temporary Filesystem."""
    pass

# Ops
@op(
    name="extract_data_from_gouv",
    required_resource_keys={"data_gouv_api"},
    out={"data": Out()},
    retry_policy=RetryPolicy(max_retries=1),
)
def extract_data_from_gouv(context):
    """Extract data from data.gouv.fr."""
    data = context.resources.data_gouv_api.fetch_data()
    return data

@op(
    name="download_city_geo",
    required_resource_keys={"ingestion_filesystem"},
    out={"geo_data": Out()},
    retry_policy=RetryPolicy(max_retries=1),
)
def download_city_geo(context):
    """Download city geographic coordinates."""
    geo_data = context.resources.ingestion_filesystem.download_geo_data()
    return geo_data

@op(
    name="fetch_nuclear_data",
    required_resource_keys={"data_gouv_api"},
    out={"nuclear_data": Out()},
    retry_policy=RetryPolicy(max_retries=1),
)
def fetch_nuclear_data(context):
    """Fetch nuclear power plant data."""
    nuclear_data = context.resources.data_gouv_api.fetch_nuclear_data()
    return nuclear_data

@op(
    name="fetch_thermal_data",
    required_resource_keys={"data_gouv_api"},
    out={"thermal_data": Out()},
    retry_policy=RetryPolicy(max_retries=1),
)
def fetch_thermal_data(context):
    """Fetch thermal power plant data."""
    thermal_data = context.resources.data_gouv_api.fetch_thermal_data()
    return thermal_data

@op(
    name="fetch_death_records",
    required_resource_keys={"data_gouv_api"},
    out={"death_records": Out()},
    retry_policy=RetryPolicy(max_retries=1),
)
def fetch_death_records(context):
    """Fetch death records."""
    death_records = context.resources.data_gouv_api.fetch_death_records()
    return death_records

@op(
    name="create_death_table",
    required_resource_keys={"postgresql_db"},
    out={"death_table": Out()},
    retry_policy=RetryPolicy(max_retries=1),
)
def create_death_table(context):
    """Create death table in PostgreSQL."""
    context.resources.postgresql_db.create_table("death")
    return "death_table"

@op(
    name="create_power_plants_table",
    required_resource_keys={"postgresql_db"},
    out={"power_plants_table": Out()},
    retry_policy=RetryPolicy(max_retries=1),
)
def create_power_plants_table(context):
    """Create power plants table in PostgreSQL."""
    context.resources.postgresql_db.create_table("power_plants")
    return "power_plants_table"

@op(
    name="load_death_records_to_redis",
    required_resource_keys={"redis_cache"},
    out={"redis_data": Out()},
    retry_policy=RetryPolicy(max_retries=1),
)
def load_death_records_to_redis(context, death_records):
    """Load death records to Redis."""
    context.resources.redis_cache.load_data(death_records)
    return "redis_data"

@op(
    name="cleanse_death_data",
    required_resource_keys={"staging_filesystem"},
    out={"cleaned_death_data": Out()},
    retry_policy=RetryPolicy(max_retries=1),
)
def cleanse_death_data(context, death_table, redis_data):
    """Cleanse death data."""
    cleaned_death_data = context.resources.staging_filesystem.cleanse_data(death_table, redis_data)
    return cleaned_death_data

@op(
    name="cleanse_power_plant_data",
    required_resource_keys={"staging_filesystem"},
    out={"cleaned_power_plant_data": Out()},
    retry_policy=RetryPolicy(max_retries=1),
)
def cleanse_power_plant_data(context, power_plants_table):
    """Cleanse power plant data."""
    cleaned_power_plant_data = context.resources.staging_filesystem.cleanse_data(power_plants_table)
    return cleaned_power_plant_data

@op(
    name="generate_plant_persist_sql",
    required_resource_keys={"sql_tmp_filesystem"},
    out={"sql_script": Out()},
    retry_policy=RetryPolicy(max_retries=1),
)
def generate_plant_persist_sql(context, cleaned_power_plant_data):
    """Generate SQL script to persist power plant data."""
    sql_script = context.resources.sql_tmp_filesystem.generate_sql(cleaned_power_plant_data)
    return sql_script

@op(
    name="check_death_data_emptiness",
    required_resource_keys={"staging_filesystem"},
    out={"is_empty": Out()},
    retry_policy=RetryPolicy(max_retries=1),
)
def check_death_data_emptiness(context, cleaned_death_data):
    """Check if death data is empty."""
    is_empty = context.resources.staging_filesystem.check_data_emptiness(cleaned_death_data)
    return is_empty

@op(
    name="store_deaths_in_postgres",
    required_resource_keys={"postgresql_db"},
    out={"stored_death_data": Out()},
    retry_policy=RetryPolicy(max_retries=1),
)
def store_deaths_in_postgres(context, is_empty, cleaned_death_data):
    """Store deaths in PostgreSQL."""
    if not is_empty:
        context.resources.postgresql_db.store_data(cleaned_death_data)
    return "stored_death_data"

@op(
    name="staging_end",
    required_resource_keys={"staging_filesystem"},
    out={"staging_end_signal": Out()},
    retry_policy=RetryPolicy(max_retries=1),
)
def staging_end(context, is_empty):
    """Signal the end of the staging process."""
    context.resources.staging_filesystem.end_staging(is_empty)
    return "staging_end_signal"

@op(
    name="store_plants_in_postgres",
    required_resource_keys={"postgresql_db"},
    out={"stored_plant_data": Out()},
    retry_policy=RetryPolicy(max_retries=1),
)
def store_plants_in_postgres(context, sql_script, staging_end_signal):
    """Store power plants in PostgreSQL."""
    context.resources.postgresql_db.execute_sql(sql_script)
    return "stored_plant_data"

@op(
    name="clean_tmp_death_files",
    required_resource_keys={"sql_tmp_filesystem"},
    out={"cleaned_files_signal": Out()},
    retry_policy=RetryPolicy(max_retries=1),
)
def clean_tmp_death_files(context, stored_death_data, stored_plant_data):
    """Clean temporary death files."""
    context.resources.sql_tmp_filesystem.clean_files()
    return "cleaned_files_signal"

# Job
@job(
    name="extract_data_from_gouv_pipeline",
    description="No description provided.",
    executor_def=multiprocess_executor,
    resource_defs={
        "data_gouv_api": data_gouv_api,
        "redis_cache": redis_cache,
        "postgresql_db": postgresql_db,
        "ingestion_filesystem": ingestion_filesystem,
        "staging_filesystem": staging_filesystem,
        "sql_tmp_filesystem": sql_tmp_filesystem,
    },
    io_manager_def=fs_io_manager,
)
def extract_data_from_gouv_pipeline():
    """Dagster job to extract data from data.gouv.fr and process it."""
    extract_data_from_gouv_op = extract_data_from_gouv()
    download_city_geo_op = download_city_geo()
    fetch_nuclear_data_op = fetch_nuclear_data()
    fetch_thermal_data_op = fetch_thermal_data()
    fetch_death_records_op = fetch_death_records()
    
    create_death_table_op = create_death_table()
    create_power_plants_table_op = create_power_plants_table()
    load_death_records_to_redis_op = load_death_records_to_redis(fetch_death_records_op)
    
    cleanse_death_data_op = cleanse_death_data(create_death_table_op, load_death_records_to_redis_op)
    cleanse_power_plant_data_op = cleanse_power_plant_data(create_power_plants_table_op)
    
    generate_plant_persist_sql_op = generate_plant_persist_sql(cleanse_power_plant_data_op)
    check_death_data_emptiness_op = check_death_data_emptiness(cleanse_death_data_op)
    
    store_deaths_in_postgres_op = store_deaths_in_postgres(check_death_data_emptiness_op, cleanse_death_data_op)
    staging_end_op = staging_end(check_death_data_emptiness_op)
    
    store_plants_in_postgres_op = store_plants_in_postgres(generate_plant_persist_sql_op, staging_end_op)
    clean_tmp_death_files_op = clean_tmp_death_files(store_deaths_in_postgres_op, store_plants_in_postgres_op)