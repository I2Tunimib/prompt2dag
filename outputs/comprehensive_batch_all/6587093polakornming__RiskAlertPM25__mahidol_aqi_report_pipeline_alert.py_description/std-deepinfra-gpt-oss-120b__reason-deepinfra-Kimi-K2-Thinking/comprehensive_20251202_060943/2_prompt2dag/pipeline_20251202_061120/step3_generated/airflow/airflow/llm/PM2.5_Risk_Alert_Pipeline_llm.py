# Generated by Airflow DAG Generator
# Date: 2024-06-13
# Description: DAG for PM2.5_Risk_Alert_Pipeline

import json
import logging
import smtplib
from datetime import datetime
from email.mime.text import MIMEText
from typing import Any, Dict

import pandas as pd
import psycopg2
import requests
from airflow import DAG
from airflow.decorators import task
from airflow.models import Variable
from airflow.providers.http.hooks.http import HttpHook
from airflow.providers.postgres.hooks.postgres import PostgresHook
from airflow.providers.smtp.hooks.smtp import SmtpHook
from airflow.utils.trigger_rule import TriggerRule

# Default arguments for the DAG
default_args = {
    "owner": "airflow",
    "depends_on_past": False,
    "retries": 0,
    "retry_delay": None,
    "email_on_failure": False,
    "email_on_retry": False,
}

# DAG definition
with DAG(
    dag_id="PM2.5_Risk_Alert_Pipeline",
    description="Comprehensive Pipeline Description",
    schedule_interval=None,  # Disabled schedule
    start_date=datetime(2024, 1, 1),
    catchup=False,
    default_args=default_args,
    tags=["pm2.5", "aqi", "mahidol"],
    is_paused_upon_creation=True,
    max_active_runs=1,
) as dag:

    @task(task_id="extract_mahidol_aqi_html", retries=0)
    def extract_mahidol_aqi_html() -> str:
        """
        Extract raw HTML from Mahidol University AQI website.
        Returns the HTML content as a string.
        """
        try:
            http = HttpHook(http_conn_id="mahidol_aqi_api", method="GET")
            response = http.run(endpoint="/")
            response.raise_for_status()
            logging.info("Successfully fetched Mahidol AQI HTML.")
            return response.text
        except Exception as exc:
            logging.error("Failed to fetch Mahidol AQI HTML: %s", exc)
            raise

    @task(task_id="transform_mahidol_aqi_json", retries=0)
    def transform_mahidol_aqi_json(html_content: str) -> Dict[str, Any]:
        """
        Transform the raw HTML into a structured JSON dictionary.
        """
        try:
            # Simple example: extract a table using pandas
            tables = pd.read_html(html_content)
            if not tables:
                raise ValueError("No tables found in HTML.")
            df = tables[0]
            json_data = df.to_dict(orient="records")
            logging.info("Transformed HTML to JSON with %d records.", len(json_data))
            return {"records": json_data}
        except Exception as exc:
            logging.error("Failed to transform HTML to JSON: %s", exc)
            raise

    @task(task_id="data_freshness_branch", retries=0)
    def data_freshness_branch(transformed_data: Dict[str, Any]) -> str:
        """
        Branch based on data freshness.
        Returns the task_id of the downstream task to follow.
        """
        try:
            # Placeholder logic: assume data is fresh if timestamp within 1 hour
            # Here we just always proceed to load task.
            return "load_mahidol_aqi_postgres"
        except Exception as exc:
            logging.error("Data freshness check failed: %s", exc)
            raise

    @task(task_id="aqi_threshold_branch", retries=0)
    def aqi_threshold_branch(transformed_data: Dict[str, Any]) -> str:
        """
        Branch based on AQI threshold.
        Returns the task_id of the downstream task to follow.
        """
        try:
            # Placeholder: trigger alert if any PM2.5 value > 35
            records = transformed_data.get("records", [])
            for rec in records:
                pm25 = rec.get("PM2.5") or rec.get("pm25") or rec.get("PM25")
                if pm25 is not None and float(pm25) > 35:
                    return "notify_pm25_email_alert"
            # No alert needed
            return "skip_email_alert"
        except Exception as exc:
            logging.error("AQI threshold check failed: %s", exc)
            raise

    @task(task_id="load_mahidol_aqi_postgres", retries=0, trigger_rule=TriggerRule.NONE_FAILED)
    def load_mahidol_aqi_postgres(transformed_data: Dict[str, Any]) -> None:
        """
        Load transformed AQI data into PostgreSQL warehouse.
        """
        try:
            pg_hook = PostgresHook(postgres_conn_id="postgres_warehouse")
            records = transformed_data.get("records", [])
            if not records:
                logging.warning("No records to load into PostgreSQL.")
                return

            # Assuming a table `mahidol_aqi` with appropriate columns exists.
            insert_sql = """
                INSERT INTO mahidol_aqi (data)
                VALUES (%s)
                ON CONFLICT DO NOTHING;
            """
            with pg_hook.get_conn() as conn:
                with conn.cursor() as cur:
                    for rec in records:
                        cur.execute(insert_sql, (json.dumps(rec),))
                conn.commit()
            logging.info("Loaded %d records into PostgreSQL.", len(records))
        except Exception as exc:
            logging.error("Failed to load data into PostgreSQL: %s", exc)
            raise

    @task(task_id="notify_pm25_email_alert", retries=0, trigger_rule=TriggerRule.NONE_FAILED)
    def notify_pm25_email_alert(transformed_data: Dict[str, Any]) -> None:
        """
        Send an email alert when PM2.5 exceeds the threshold.
        """
        try:
            smtp_hook = SmtpHook(smtp_conn_id="smtp_gmail")
            # Build email content
            subject = "PM2.5 Alert - Mahidol AQI"
            body_lines = ["The following records exceed the PM2.5 threshold:\n"]
            for rec in transformed_data.get("records", []):
                pm25 = rec.get("PM2.5") or rec.get("pm25") or rec.get("PM25")
                if pm25 is not None and float(pm25) > 35:
                    body_lines.append(json.dumps(rec, ensure_ascii=False))
            body = "\n".join(body_lines)

            msg = MIMEText(body, "plain", "utf-8")
            msg["Subject"] = subject
            msg["From"] = smtp_hook.smtp_user
            msg["To"] = Variable.get("alert_email_recipients", default_var="")

            smtp_hook.send_email(to=msg["To"], subject=subject, html_content=body)
            logging.info("PM2.5 alert email sent to %s.", msg["To"])
        except Exception as exc:
            logging.error("Failed to send PM2.5 alert email: %s", exc)
            raise

    @task(task_id="skip_email_alert", retries=0, trigger_rule=TriggerRule.NONE_FAILED)
    def skip_email_alert() -> None:
        """
        Dummy task when no email alert is required.
        """
        logging.info("No PM2.5 threshold breach detected; skipping email alert.")

    # Define task pipeline
    html = extract_mahidol_aqi_html()
    json_data = transform_mahidol_aqi_json(html)

    # Branching
    freshness_branch = data_freshness_branch(json_data)
    threshold_branch = aqi_threshold_branch(json_data)

    # Load task follows freshness branch
    load_task = load_mahidol_aqi_postgres(json_data)
    freshness_branch >> load_task

    # Notification tasks follow threshold branch
    notify_task = notify_pm25_email_alert(json_data)
    skip_task = skip_email_alert()
    threshold_branch >> [notify_task, skip_task]