# Generated by Dagster Pipeline Generator
# Date: 2024-06-28
# Pipeline: PM2.5_Risk_Alert_Pipeline
# Description: Comprehensive Pipeline Description
# Executor: in_process_executor
# Dagster version: 1.5.0

from typing import Dict, Any

import json
import smtplib
from email.mime.text import MIMEText

import dagster
from dagster import op, job, In, Out, Nothing, RetryPolicy, ResourceDefinition, ConfigurableResource, InitResourceContext, get_dagster_logger, InOut, op_output


# ----------------------------------------------------------------------
# Resource Definitions
# ----------------------------------------------------------------------


class MahidolAqiApiResource(ConfigurableResource):
    """Resource for fetching AQI data from Mahidol University website."""

    base_url: str = "https://aqi.mahidol.ac.th"

    def fetch_html(self) -> str:
        # Placeholder implementation; replace with actual HTTP request logic.
        logger = get_dagster_logger()
        logger.info(f"Fetching AQI HTML from {self.base_url}")
        return "<html><body>Sample AQI HTML content</body></html>"


class LocalFilesystemIOManager(ResourceDefinition):
    """Simple filesystem IO manager for local storage."""

    def __init__(self, base_dir: str = "/tmp/dagster"):
        self.base_dir = base_dir

    def handle_output(self, context, obj):
        path = f"{self.base_dir}/{context.step_key}.json"
        with open(path, "w") as f:
            json.dump(obj, f)
        context.log.info(f"Wrote output to {path}")

    def load_input(self, context):
        path = f"{self.base_dir}/{context.upstream_output.step_key}.json"
        with open(path, "r") as f:
            data = json.load(f)
        context.log.info(f"Loaded input from {path}")
        return data


class PostgresWarehouseResource(ConfigurableResource):
    """Resource for interacting with a PostgreSQL data warehouse."""

    connection_string: str = "postgresql://user:password@localhost:5432/warehouse"

    def insert_aqi(self, aqi_data: Dict[str, Any]) -> None:
        # Placeholder implementation; replace with actual DB insertion logic.
        logger = get_dagster_logger()
        logger.info(f"Inserting AQI data into PostgreSQL: {aqi_data}")


class SmtpGmailResource(ConfigurableResource):
    """Resource for sending emails via Gmail SMTP."""

    smtp_server: str = "smtp.gmail.com"
    smtp_port: int = 587
    username: str = "your.email@gmail.com"
    password: str = "your_app_password"

    def send_email(self, subject: str, body: str, to: str) -> None:
        msg = MIMEText(body)
        msg["Subject"] = subject
        msg["From"] = self.username
        msg["To"] = to

        with smtplib.SMTP(self.smtp_server, self.smtp_port) as server:
            server.starttls()
            server.login(self.username, self.password)
            server.send_message(msg)


# ----------------------------------------------------------------------
# Ops
# ----------------------------------------------------------------------


@op(
    name="Extract Mahidol AQI HTML",
    description="Fetches raw AQI HTML from Mahidol University website.",
    required_resource_keys={"mahidol_aqi_api"},
    out=Out(str),
    retry_policy=RetryPolicy(max_retries=0),
)
def extract_mahidol_aqi_html(context: dagster.OpExecutionContext) -> str:
    """Extract raw HTML containing AQI information."""
    html = context.resources.mahidol_aqi_api.fetch_html()
    context.log.info("Successfully fetched AQI HTML.")
    return html


@op(
    name="Transform Mahidol AQI to JSON",
    description="Parses the raw HTML and converts it into a structured JSON dict.",
    ins={"html": In(str)},
    out=Out(dict),
    required_resource_keys=set(),
    retry_policy=RetryPolicy(max_retries=0),
)
def transform_mahidol_aqi_json(context: dagster.OpExecutionContext, html: str) -> Dict[str, Any]:
    """Transform raw HTML into a JSON representation."""
    # Placeholder parsing logic; replace with BeautifulSoup or similar.
    context.log.info("Transforming HTML to JSON.")
    parsed = {"aqi": 85, "pm25": 55, "timestamp": "2024-06-28T00:00:00Z"}
    return parsed


@op(
    name="Data Freshness Branch",
    description="Determines whether the fetched AQI data is fresh enough for loading.",
    ins={"aqi_json": In(dict)},
    out=Out(bool),
    required_resource_keys=set(),
    retry_policy=RetryPolicy(max_retries=0),
)
def data_freshness_branch(context: dagster.OpExecutionContext, aqi_json: Dict[str, Any]) -> bool:
    """Simple freshness check placeholder."""
    context.log.info("Evaluating data freshness.")
    # Placeholder: always true
    return True


@op(
    name="Load Mahidol AQI into PostgreSQL",
    description="Loads the AQI JSON data into the PostgreSQL data warehouse if data is fresh.",
    ins={
        "aqi_json": In(dict),
        "is_fresh": In(bool),
    },
    out=Out(Nothing),
    required_resource_keys={"postgres_warehouse"},
    retry_policy=RetryPolicy(max_retries=0),
)
def load_mahidol_aqi_postgres(
    context: dagster.OpExecutionContext,
    aqi_json: Dict[str, Any],
    is_fresh: bool,
) -> Nothing:
    """Load AQI data into PostgreSQL when freshness condition is met."""
    if not is_fresh:
        context.log.warning("Data is not fresh; skipping load.")
        return Nothing
    context.resources.postgres_warehouse.insert_aqi(aqi_json)
    context.log.info("AQI data loaded into PostgreSQL.")
    return Nothing


@op(
    name="AQI Threshold Branch",
    description="Checks if PM2.5 exceeds a predefined threshold to trigger an alert.",
    ins={"aqi_json": In(dict)},
    out=Out(bool),
    required_resource_keys=set(),
    retry_policy=RetryPolicy(max_retries=0),
)
def aqi_threshold_branch(context: dagster.OpExecutionContext, aqi_json: Dict[str, Any]) -> bool:
    """Determine if PM2.5 exceeds alert threshold."""
    threshold = 50  # Example threshold for PM2.5
    pm25 = aqi_json.get("pm25", 0)
    context.log.info(f"PM2.5 value: {pm25}, threshold: {threshold}")
    return pm25 > threshold


@op(
    name="Notify PM2.5 Email Alert",
    description="Sends an email alert when PM2.5 exceeds the defined threshold.",
    ins={
        "aqi_json": In(dict),
        "alert_needed": In(bool),
    },
    out=Out(Nothing),
    required_resource_keys={"smtp_gmail"},
    retry_policy=RetryPolicy(max_retries=0),
)
def notify_pm25_email_alert(
    context: dagster.OpExecutionContext,
    aqi_json: Dict[str, Any],
    alert_needed: bool,
) -> Nothing:
    """Send email notification if PM2.5 alert condition is true."""
    if not alert_needed:
        context.log.info("PM2.5 below threshold; no email sent.")
        return Nothing

    subject = "PM2.5 Alert – High Pollution Detected"
    body = f"""\
    Alert generated at {aqi_json.get('timestamp')}.

    Current PM2.5 level: {aqi_json.get('pm25')} µg/m³
    AQI: {aqi_json.get('aqi')}

    Please take appropriate precautions.
    """
    recipient = "recipient@example.com"
    context.resources.smtp_gmail.send_email(subject, body, recipient)
    context.log.info(f"Alert email sent to {recipient}.")
    return Nothing


# ----------------------------------------------------------------------
# Job Definition
# ----------------------------------------------------------------------


@job(
    name="pm2.5_risk_alert_pipeline",
    description="Comprehensive Pipeline Description",
    executor_def=dagster.in_process_executor,
    resource_defs={
        "mahidol_aqi_api": MahidolAqiApiResource(),
        "local_filesystem": LocalFilesystemIOManager(),
        "postgres_warehouse": PostgresWarehouseResource(),
        "smtp_gmail": SmtpGmailResource(),
    },
    # The default IO manager is set to the local filesystem manager.
    # This can be overridden per op if needed.
    config={"resources": {"local_filesystem": {"config": {"base_dir": "/tmp/dagster"}}}},
)
def PM2_5_Risk_Alert_Pipeline():
    """Sequential pipeline that extracts, transforms, loads AQI data and sends alerts."""
    # Extraction and transformation
    html = extract_mahidol_aqi_html()
    aqi_json = transform_mahidol_aqi_json(html)

    # Branching logic
    is_fresh = data_freshness_branch(aqi_json)
    alert_needed = aqi_threshold_branch(aqi_json)

    # Load and notification steps
    load_mahidol_aqi_postgres(aqi_json=aqi_json, is_fresh=is_fresh)
    notify_pm25_email_alert(aqi_json=aqi_json, alert_needed=alert_needed)


# ----------------------------------------------------------------------
# Entry point for local execution (optional)
# ----------------------------------------------------------------------


if __name__ == "__main__":
    # Execute the job locally for testing/debugging.
    result = PM2_5_Risk_Alert_Pipeline.execute_in_process()
    assert result.success
    print("Pipeline executed successfully.")