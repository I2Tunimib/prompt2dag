# Generated by Dagster Code Generator
# Date: 2023-10-05
# Dagster Version: 1.5.0

from dagster import (
    job,
    op,
    Out,
    In,
    RetryPolicy,
    in_process_executor,
    fs_io_manager,
    resource,
)

# Resources
@resource
def mahidol_aqi_website():
    """Resource for Mahidol University AQI Website."""
    pass

@resource
def local_filesystem():
    """Resource for Local Filesystem."""
    pass

@resource
def postgres_conn():
    """Resource for PostgreSQL Connection."""
    pass

@resource
def smtp_server():
    """Resource for SMTP Server."""
    pass

@resource
def config_files():
    """Resource for Configuration Files."""
    pass

# Ops
@op(
    required_resource_keys={"mahidol_aqi_website"},
    out={"aqi_data": Out()},
)
def get_data_mahidol_aqi_report(context):
    """Fetch AQI data from Mahidol University website."""
    aqi_data = context.resources.mahidol_aqi_website.get_data()
    return aqi_data

@op(
    ins={"aqi_data": In()},
    out={"json_data": Out()},
)
def create_json_object(context, aqi_data):
    """Create a JSON object from the fetched AQI data."""
    json_data = aqi_data.to_json()
    return json_data

@op(
    required_resource_keys={"postgres_conn"},
    ins={"json_data": In()},
)
def load_mahidol_aqi_to_postgres(context, json_data):
    """Load the JSON data into PostgreSQL."""
    context.resources.postgres_conn.load_data(json_data)

@op(
    required_resource_keys={"smtp_server"},
)
def alert_email(context):
    """Send an email alert after data is loaded to PostgreSQL."""
    context.resources.smtp_server.send_email("Data loaded successfully")

# Job
@job(
    name="get_data_mahidol_aqi_report_pipeline",
    description="No description provided.",
    executor_def=in_process_executor,
    resource_defs={
        "mahidol_aqi_website": mahidol_aqi_website,
        "local_filesystem": local_filesystem,
        "postgres_conn": postgres_conn,
        "smtp_server": smtp_server,
        "config_files": config_files,
    },
    io_manager_def=fs_io_manager,
)
def get_data_mahidol_aqi_report_pipeline():
    """Dagster job to fetch AQI data from Mahidol University, create a JSON object, load it to PostgreSQL, and send an email alert."""
    json_data = create_json_object(get_data_mahidol_aqi_report())
    load_mahidol_aqi_to_postgres(json_data)
    alert_email()