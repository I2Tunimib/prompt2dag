# Generated by Prefect 2.x Code Generator
# Date: 2023-10-05
# Prefect Version: 2.14.0

from prefect import flow, task, get_run_logger
from prefect.task_runners import SequentialTaskRunner
from prefect.blocks.system import Secret, LocalFileSystem
from prefect.infrastructure import Docker, Process
from prefect.blocks.notifications import EmailBlock
import json

# Load secrets and resources
mahidol_aqi_website = Secret.load("mahidol_aqi_website")
local_filesystem = LocalFileSystem.load("local_filesystem")
postgres_data_warehouse = Secret.load("postgres_data_warehouse")
smtp_server = Secret.load("smtp_server")
config_filesystem = LocalFileSystem.load("config_filesystem")

@task(retries=0, name="Scrape Mahidol AQI Report")
def get_data_mahidol_aqi_report():
    logger = get_run_logger()
    logger.info("Scraping Mahidol AQI Report from %s", mahidol_aqi_website.get())
    # Placeholder for actual scraping logic
    aqi_data = {"aqi": 50, "location": "Bangkok", "date": "2023-10-05"}
    return aqi_data

@task(retries=0, name="Parse and Validate AQI Data")
def create_json_object(aqi_data):
    logger = get_run_logger()
    logger.info("Parsing and validating AQI data: %s", aqi_data)
    # Placeholder for actual parsing and validation logic
    json_data = json.dumps(aqi_data)
    return json_data

@task(retries=0, name="Load AQI Data to PostgreSQL")
def load_mahidol_aqi_to_postgres(json_data):
    logger = get_run_logger()
    logger.info("Loading AQI data to PostgreSQL: %s", json_data)
    # Placeholder for actual loading logic
    # Example: Execute SQL insert statement
    return True

@task(retries=0, name="Send AQI Alert Emails")
def alert_email():
    logger = get_run_logger()
    logger.info("Sending AQI alert emails")
    # Placeholder for actual email sending logic
    email_block = EmailBlock.load("smtp_server")
    email_block.send_email(
        subject="AQI Alert",
        msg="The AQI has reached a critical level.",
        email_to="recipient@example.com"
    )
    return True

@flow(name="get_data_mahidol_aqi_report_pipeline", task_runner=SequentialTaskRunner())
def get_data_mahidol_aqi_report_pipeline():
    logger = get_run_logger()
    logger.info("Starting get_data_mahidol_aqi_report_pipeline")

    aqi_data = get_data_mahidol_aqi_report()
    json_data = create_json_object(aqi_data)
    load_status = load_mahidol_aqi_to_postgres(json_data)
    alert_email()

if __name__ == "__main__":
    get_data_mahidol_aqi_report_pipeline()