# Generated by Prefect 2.x Code Generator
# Date: 2023-10-05
# Prefect Version: 2.14.0

from prefect import flow, task, get_run_logger
from prefect.task_runners import SequentialTaskRunner
from prefect.blocks.system import Secret
from prefect.infrastructure.docker import DockerContainer
from prefect.exceptions import PrefectException
import subprocess

# Load secrets
snowflake_conn = Secret.load("snowflake-conn")
slack_conn = Secret.load("slack-conn")

@task(retries=3, name="Run CTAS")
def run_ctas():
    """
    Task to run a CTAS (Create Table As Select) query.
    """
    logger = get_run_logger()
    try:
        # Example command to run a CTAS query using Snowflake CLI
        # Replace with actual command and parameters
        result = subprocess.run(
            ["snowsql", "-a", snowflake_conn.get(), "-q", "CREATE TABLE new_table AS SELECT * FROM old_table"],
            capture_output=True,
            text=True,
            check=True
        )
        logger.info(f"CTAS query executed successfully: {result.stdout}")
    except subprocess.CalledProcessError as e:
        logger.error(f"CTAS query failed: {e.stderr}")
        raise PrefectException("CTAS query execution failed") from e

@flow(
    name="run_ctas_pipeline",
    task_runner=SequentialTaskRunner(),
    schedule="0 0 * * *",
    timezone="UTC",
    catchup=False
)
def run_ctas_pipeline():
    """
    Prefect flow to run the CTAS pipeline.
    """
    logger = get_run_logger()
    logger.info("Starting CTAS pipeline")

    # Run the CTAS task
    run_ctas()

if __name__ == "__main__":
    run_ctas_pipeline()