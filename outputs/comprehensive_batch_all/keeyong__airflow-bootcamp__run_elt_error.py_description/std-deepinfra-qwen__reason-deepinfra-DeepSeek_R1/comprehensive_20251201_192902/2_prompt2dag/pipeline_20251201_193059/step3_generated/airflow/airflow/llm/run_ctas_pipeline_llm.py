# Generated by Airflow DAG Code Generator
# Date: 2023-10-05
# Author: Airflow Expert
# Description: This DAG runs a CTAS (Create Table As Select) query on Snowflake.

from airflow import DAG
from airflow.operators.python import PythonOperator
from airflow.providers.slack.operators.slack_webhook import SlackWebhookOperator
from airflow.utils.dates import days_ago
from airflow.exceptions import AirflowException
from airflow.providers.snowflake.hooks.snowflake import SnowflakeHook
from datetime import timedelta
import logging

# Default arguments for the DAG
default_args = {
    'owner': 'airflow',
    'depends_on_past': False,
    'email_on_failure': False,
    'email_on_retry': False,
    'retries': 3,
    'retry_delay': timedelta(minutes=5),
}

# Define the DAG
with DAG(
    dag_id='run_ctas_pipeline',
    description='No description provided.',
    schedule_interval='@daily',
    start_date=days_ago(1),
    catchup=False,
    default_args=default_args,
    tags=['example', 'snowflake'],
) as dag:

    def run_ctas(**kwargs):
        """
        Run a CTAS query on Snowflake.
        """
        snowflake_hook = SnowflakeHook(snowflake_conn_id='snowflake_conn')
        try:
            # Example CTAS query
            query = """
            CREATE OR REPLACE TABLE my_table AS
            SELECT * FROM source_table;
            """
            snowflake_hook.run(query)
            logging.info("CTAS query executed successfully.")
        except Exception as e:
            logging.error(f"Error executing CTAS query: {e}")
            raise AirflowException(f"CTAS query failed: {e}")

    # Define the PythonOperator for running the CTAS query
    run_ctas_task = PythonOperator(
        task_id='run_ctas',
        python_callable=run_ctas,
        provide_context=True,
        retries=3,
        retry_delay=timedelta(minutes=5),
    )

    # Define the Slack notification task
    def send_slack_notification(context):
        """
        Send a Slack notification on task failure.
        """
        task_instance = context['task_instance']
        task_id = task_instance.task_id
        log_url = context['task_instance'].log_url
        message = f"Task {task_id} failed. Logs: {log_url}"
        SlackWebhookOperator(
            task_id='send_slack_notification',
            http_conn_id='slack_conn',
            message=message,
            username='Airflow',
        ).execute(context)

    # Set up the on_failure_callback for the DAG
    dag.on_failure_callback = send_slack_notification

    # Set task dependencies
    run_ctas_task >> SlackWebhookOperator(
        task_id='notify_completion',
        http_conn_id='slack_conn',
        message="CTAS pipeline completed successfully.",
        username='Airflow',
    )