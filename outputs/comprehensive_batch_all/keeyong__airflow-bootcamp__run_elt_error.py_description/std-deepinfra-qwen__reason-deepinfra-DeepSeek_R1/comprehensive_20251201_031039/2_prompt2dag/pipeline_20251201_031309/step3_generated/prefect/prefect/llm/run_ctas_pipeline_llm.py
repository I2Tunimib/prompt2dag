# Generated by Prefect 2.x Code Generator
# Generation Date: [Insert Date Here]
# Prefect Version: 2.14.0

from prefect import flow, task, get_run_logger
from prefect.task_runners import SequentialTaskRunner
from prefect.blocks.system import Secret
import subprocess

# Task: Run CTAS
@task(retries=0)
def run_ctas(snowflake_conn):
    logger = get_run_logger()
    logger.info("Running CTAS...")
    # Example command to run CTAS in Snowflake
    command = f'snowsql -a <account> -u <user> -p {snowflake_conn} -d <database> -s <schema> -q "CREATE TABLE new_table AS SELECT * FROM old_table;"'
    result = subprocess.run(command, shell=True, capture_output=True, text=True)
    if result.returncode != 0:
        logger.error(f"CTAS failed: {result.stderr}")
        raise Exception("CTAS failed")
    logger.info("CTAS completed successfully")

# Task: Send Slack Notification
@task(retries=0)
def send_slack_notification(slack_conn):
    logger = get_run_logger()
    logger.info("Sending Slack notification...")
    # Example command to send a Slack notification
    command = f'curl -X POST -H "Content-type: application/json" --data \'{{"text":"CTAS pipeline completed successfully"}}\' {slack_conn}'
    result = subprocess.run(command, shell=True, capture_output=True, text=True)
    if result.returncode != 0:
        logger.error(f"Slack notification failed: {result.stderr}")
        raise Exception("Slack notification failed")
    logger.info("Slack notification sent successfully")

# Flow: run_ctas_pipeline
@flow(name="run_ctas_pipeline", task_runner=SequentialTaskRunner(), schedule="@daily", timezone="UTC", catchup=False)
def run_ctas_pipeline():
    logger = get_run_logger()
    logger.info("Starting run_ctas_pipeline...")

    # Load secrets
    snowflake_conn = Secret.load("snowflake-conn").get()
    slack_conn = Secret.load("slack-conn").get()

    # Run tasks
    run_ctas_result = run_ctas(snowflake_conn)
    send_slack_notification(slack_conn)

if __name__ == "__main__":
    run_ctas_pipeline()