# Generated by Dagster Code Generator
# Date: [Current Date]
# Dagster Version: 1.5.0

from dagster import job, op, In, Out, RetryPolicy, ResourceDefinition, fs_io_manager, in_process_executor
from dagster_slack import slack_resource
from dagster_snowflake import snowflake_resource

# Define the Run CTAS operation
@op(
    name="run_ctas",
    description="Run a CTAS (Create Table As Select) query in Snowflake",
    required_resource_keys={"snowflake_conn"},
    out=Out(str, description="The name of the created table"),
)
def run_ctas(context):
    """
    Executes a CTAS query in Snowflake.
    """
    query = "CREATE TABLE new_table AS SELECT * FROM source_table"
    context.resources.snowflake_conn.execute(query)
    return "new_table"

# Define the Send Slack Notification operation
@op(
    name="send_slack_notification",
    description="Send a Slack notification",
    required_resource_keys={"slack_conn"},
    ins={"table_name": In(str, description="The name of the created table")},
)
def send_slack_notification(context, table_name):
    """
    Sends a Slack notification with the name of the created table.
    """
    message = f"CTAS job completed. New table created: {table_name}"
    context.resources.slack_conn.chat_postMessage(channel="#notifications", text=message)

# Define the job
@job(
    name="run_ctas_pipeline",
    description="No description provided.",
    executor_def=in_process_executor,
    resource_defs={
        "snowflake_conn": snowflake_resource,
        "slack_conn": slack_resource,
        "io_manager": fs_io_manager,
    },
)
def run_ctas_pipeline():
    """
    A Dagster job that runs a CTAS query in Snowflake and sends a Slack notification.
    """
    table_name = run_ctas()
    send_slack_notification(table_name)

# Define the schedule
from dagster import ScheduleDefinition, DefaultScheduleStatus

run_ctas_pipeline_schedule = ScheduleDefinition(
    job=run_ctas_pipeline,
    cron_schedule="@daily",
    execution_timezone="UTC",
    name="run_ctas_pipeline_schedule",
    default_status=DefaultScheduleStatus.RUNNING,
    should_execute=lambda _context: True,
    execution_time_window=None,
    tags=None,
    description="Daily schedule for the run_ctas_pipeline job.",
)