# Generated by Prefect Pipeline Generator
# Pipeline: RunELT_Alert
# Description: Comprehensive Pipeline Description
# Generated on: 2024-06-13

import os
from typing import Any, Dict

import prefect
from prefect import flow, task, get_run_logger
from prefect.task_runners import SequentialTaskRunner
from prefect.deployments import DeploymentSpec
from prefect.orion.schemas.schedules import CronSchedule
from prefect.blocks.system import Secret

# Optional: import Snowflake connector and Slack SDK
try:
    import snowflake.connector
except ImportError:  # pragma: no cover
    snowflake = None

try:
    from slack_sdk import WebClient
    from slack_sdk.errors import SlackApiError
except ImportError:  # pragma: no cover
    WebClient = None
    SlackApiError = Exception


@task(retries=0, name="Create Analytics Table via CTAS")
def create_analytics_table(snowflake_secret_name: str = "snowflake_conn") -> None:
    """
    Executes a Snowflake CTAS (Create Table As Select) statement to build the analytics table.

    Args:
        snowflake_secret_name: Name of the Prefect Secret block containing Snowflake credentials.

    Raises:
        RuntimeError: If the Snowflake operation fails.
    """
    logger = get_run_logger()
    logger.info("Loading Snowflake credentials from secret block '%s'.", snowflake_secret_name)

    # Load Snowflake credentials from Prefect Secret block
    secret_block = Secret.load(snowflake_secret_name)
    credentials: Dict[str, Any] = secret_block.get()

    required_keys = {"user", "password", "account", "warehouse", "database", "schema"}
    if not required_keys.issubset(credentials):
        missing = required_keys - credentials.keys()
        raise RuntimeError(f"Missing Snowflake credential fields: {missing}")

    if snowflake is None:
        raise RuntimeError("snowflake-connector-python is not installed.")

    ctx = snowflake.connector.connect(
        user=credentials["user"],
        password=credentials["password"],
        account=credentials["account"],
        warehouse=credentials["warehouse"],
        database=credentials["database"],
        schema=credentials["schema"],
    )
    cs = ctx.cursor()
    try:
        logger.info("Running CTAS statement to create analytics table.")
        ctas_sql = """
        CREATE OR REPLACE TABLE analytics_table AS
        SELECT *
        FROM source_table
        WHERE DATE_TRUNC('day', created_at) = CURRENT_DATE() - INTERVAL '1 DAY';
        """
        cs.execute(ctas_sql)
        logger.info("Analytics table created successfully.")
    except Exception as exc:
        logger.error("Failed to create analytics table: %s", exc)
        raise RuntimeError("CTAS operation failed.") from exc
    finally:
        cs.close()
        ctx.close()


@task(retries=3, name="Slack Failure Notifier")
def slack_failure_notifier(
    error_message: str,
    slack_secret_name: str = "slack_api",
    channel: str = "#alerts",
) -> None:
    """
    Sends a failure notification to Slack.

    Args:
        error_message: The error message to include in the Slack notification.
        slack_secret_name: Name of the Prefect Secret block containing the Slack Bot token.
        channel: Slack channel where the message will be posted.

    Raises:
        RuntimeError: If sending the Slack message fails.
    """
    logger = get_run_logger()
    logger.info("Loading Slack token from secret block '%s'.", slack_secret_name)

    secret_block = Secret.load(slack_secret_name)
    token: str = secret_block.get()

    if WebClient is None:
        raise RuntimeError("slack-sdk is not installed.")

    client = WebClient(token=token)

    message = f":warning: *ELT Pipeline Failure*\nError: ```{error_message}```"
    try:
        logger.info("Posting failure notification to Slack channel %s.", channel)
        response = client.chat_postMessage(channel=channel, text=message)
        logger.debug("Slack response: %s", response)
    except SlackApiError as exc:
        logger.error("Failed to send Slack notification: %s", exc)
        raise RuntimeError("Slack notification failed.") from exc


@flow(
    name="runelt_alert",
    task_runner=SequentialTaskRunner(),
)
def runelt_alert_flow() -> None:
    """
    Orchestrates the ELT pipeline:
    1. Creates the analytics table in Snowflake.
    2. If the creation fails, sends a Slack failure notification.
    """
    logger = get_run_logger()
    try:
        logger.info("Starting task: create_analytics_table")
        create_analytics_table()
        logger.info("Task create_analytics_table completed successfully.")
    except Exception as exc:
        error_msg = str(exc)
        logger.error("create_analytics_table failed with error: %s", error_msg)
        logger.info("Triggering slack_failure_notifier due to failure.")
        slack_failure_notifier(error_message=error_msg)


# -------------------------------------------------------------------------
# Deployment configuration
# -------------------------------------------------------------------------

DeploymentSpec(
    name="runelt_alert_deployment",
    flow=runelt_alert_flow,
    schedule=CronSchedule(cron="@daily", timezone="UTC", day_or=False),
    tags=["runelt_alert"],
    parameters={},
    flow_name="runelt_alert",
    work_pool_name="default-agent-pool",
    enforce_parameter_schema=False,
    description="Deployment for RunELT_Alert pipeline.",
    schedule_kwargs={"catchup": False},
)

# Enable the deployment when this module is imported
if __name__ == "__main__":
    # This block allows quick local testing without Prefect Orion server.
    # In production, deployments are registered via `prefect deployment apply`.
    runelt_alert_flow()