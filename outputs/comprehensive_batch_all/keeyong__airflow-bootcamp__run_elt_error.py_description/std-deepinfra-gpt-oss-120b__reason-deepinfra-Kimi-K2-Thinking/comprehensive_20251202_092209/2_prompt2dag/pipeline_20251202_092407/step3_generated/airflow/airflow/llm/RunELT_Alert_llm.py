# Generated by Airflow DAG Generator on 2024-06-13
# DAG: RunELT_Alert
# Description: Comprehensive Pipeline Description

import json
import logging
from datetime import datetime

import pendulum
import requests
from airflow import DAG
from airflow.decorators import task
from airflow.models import Variable
from airflow.providers.snowflake.hooks.snowflake import SnowflakeHook
from airflow.utils.trigger_rule import TriggerRule
from airflow.utils.task_group import TaskGroup
from airflow.utils.dates import days_ago
from airflow.models import BaseOperator
from airflow.operators.python import PythonOperator

# Default arguments for the DAG
default_args = {
    "owner": "airflow",
    "depends_on_past": False,
    "retries": 0,
    "retry_delay": pendulum.duration(minutes=5),
    "email_on_failure": False,
    "email_on_retry": False,
}

# DAG definition
with DAG(
    dag_id="RunELT_Alert",
    description="Comprehensive Pipeline Description",
    schedule_interval="@daily",
    start_date=days_ago(1),
    catchup=False,
    default_args=default_args,
    tags=["elt", "analytics"],
    max_active_runs=1,
    timezone="UTC",
) as dag:

    @task(
        task_id="create_analytics_table",
        retries=0,
        retry_delay=pendulum.duration(minutes=5),
    )
    def create_analytics_table():
        """
        Create Analytics Table via CTAS (Create Table As Select) in Snowflake.
        """
        query = """
        CREATE OR REPLACE TABLE analytics.my_analytics_table AS
        SELECT *
        FROM source_schema.source_table;
        """
        try:
            hook = SnowflakeHook(snowflake_conn_id="snowflake")
            hook.run(query)
            logging.info("Analytics table created successfully.")
        except Exception as e:
            logging.error(f"Failed to create analytics table: {e}")
            raise

    @task(
        task_id="slack_failure_notifier",
        retries=3,
        retry_delay=pendulum.duration(minutes=2),
        trigger_rule=TriggerRule.ALL_FAILED,
    )
    def slack_failure_notifier():
        """
        Send a failure notification to Slack using the configured Slack API connection.
        """
        try:
            # Retrieve Slack webhook URL from Airflow connection
            conn = BaseOperator.get_connection("slack_api")
            webhook_url = conn.host  # Assuming the webhook URL is stored in the host field
            if not webhook_url:
                raise ValueError("Slack webhook URL not found in connection 'slack_api'.")

            message = {
                "text": ":x: *RunELT_Alert* pipeline failed during *Create Analytics Table* step."
            }

            response = requests.post(
                url=webhook_url,
                data=json.dumps(message),
                headers={"Content-Type": "application/json"},
                timeout=10,
            )
            response.raise_for_status()
            logging.info("Slack failure notification sent successfully.")
        except Exception as exc:
            logging.error(f"Failed to send Slack notification: {exc}")
            raise

    # Define task dependencies
    create_analytics_table_task = create_analytics_table()
    slack_failure_notifier_task = slack_failure_notifier()

    create_analytics_table_task >> slack_failure_notifier_task