# Generated by Prefect Pipeline Generator
# Date: 2024-06-13
# Pipeline: RunELT_Alert
# Description: Sequential ELT pipeline that builds analytics tables in Snowflake using CTAS operations,
#              with data validation, atomic swaps, and Slack failure notifications.

from prefect import flow, task, get_run_logger
from prefect.task_runners import SequentialTaskRunner
from prefect.deployments import DeploymentSpec
from prefect.server.schemas.schedules import CronSchedule
from prefect.exceptions import PrefectException

from prefect_snowflake import SnowflakeConnector
from prefect_slack import SlackWebhook


@task(retries=3, retry_delay_seconds=60, name="Slack Failure Notification")
def notify_failure_slack(error_message: str) -> None:
    """
    Send a failure notification to Slack.

    Args:
        error_message: The error message to include in the Slack notification.
    """
    logger = get_run_logger()
    try:
        slack: SlackWebhook = SlackWebhook.load("slack_conn")
        message = f":x: *RunELT Alert* failed.\nError: ```{error_message}```"
        slack.run(message=message)
        logger.info("Sent failure notification to Slack.")
    except Exception as exc:
        logger.error(f"Failed to send Slack notification: {exc}")
        # Re‑raise to surface the failure in the flow run
        raise


@task(retries=0, name="Run CTAS to Build Analytics Tables")
def run_ctas() -> None:
    """
    Execute CTAS statements in Snowflake to build analytics tables.

    This task assumes that the Snowflake connection block named ``snowflake_conn``
    is configured with the appropriate credentials and default warehouse/database.
    """
    logger = get_run_logger()
    try:
        snowflake: SnowflakeConnector = SnowflakeConnector.load("snowflake_conn")
        # Example CTAS statements – replace with real business logic
        ctas_queries = [
            """
            CREATE OR REPLACE TABLE analytics.sales_summary AS
            SELECT
                region,
                SUM(amount) AS total_sales,
                COUNT(*) AS transaction_count
            FROM raw.sales
            GROUP BY region
            """,
            """
            CREATE OR REPLACE TABLE analytics.customer_lifetime_value AS
            SELECT
                customer_id,
                SUM(amount) AS lifetime_value
            FROM raw.sales
            GROUP BY customer_id
            """
        ]

        for query in ctas_queries:
            logger.info(f"Executing CTAS query: {query.strip().splitlines()[0]}...")
            snowflake.execute(query)
            logger.info("Query executed successfully.")

        logger.info("All CTAS operations completed.")
    except Exception as exc:
        logger.error(f"CTAS execution failed: {exc}")
        # Propagate the exception so the flow can handle it
        raise PrefectException(f"CTAS execution error: {exc}") from exc


@flow(
    name="runelt_alert",
    task_runner=SequentialTaskRunner(),
)
def runelt_alert_flow() -> None:
    """
    Orchestrates the ELT process:
    1. Runs CTAS statements to build analytics tables in Snowflake.
    2. If any step fails, sends a Slack failure notification.
    """
    logger = get_run_logger()
    try:
        run_ctas()
        logger.info("ELT pipeline completed successfully.")
    except Exception as err:
        logger.error(f"ELT pipeline encountered an error: {err}")
        # Notify Slack about the failure
        notify_failure_slack.submit(str(err))
        # Optionally re‑raise to mark the flow run as failed
        raise


# Deployment specification
DeploymentSpec(
    name="runelt_alert_deployment",
    flow=runelt_alert_flow,
    schedule=CronSchedule(cron="0 0 * * *", timezone="UTC"),  # @daily at 00:00 UTC
    tags=["default-agent-pool"],
    parameters={},
    flow_runner=SequentialTaskRunner(),
    enforce_parameter_schema=False,
    description="Daily ELT job that builds Snowflake analytics tables and notifies Slack on failure.",
    work_queue_name="default-agent-pool",
    is_schedule_active=True,
)