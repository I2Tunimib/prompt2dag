# Generated by Dagster Pipeline Generator
# Date: 2024-06-28
# Pipeline: run_ctas_pipeline
# Description: No description provided.

from dagster import (
    op,
    job,
    In,
    Out,
    RetryPolicy,
    ResourceDefinition,
    fs_io_manager,
    in_process_executor,
    ScheduleDefinition,
    DefaultScheduleStatus,
    HookContext,
    Failure,
    HookResult,
    Hook,
    ConfigurableResource,
)

# ----------------------------------------------------------------------
# Resources
# ----------------------------------------------------------------------


class SnowflakeResource(ConfigurableResource):
    """Placeholder Snowflake resource.

    In a real deployment, implement connection handling and query execution.
    """

    account: str
    user: str
    password: str
    warehouse: str
    database: str
    schema: str

    def execute_query(self, query: str) -> None:
        # Replace with actual Snowflake execution logic.
        print(f"[Snowflake] Executing query: {query}")


class SlackResource(ConfigurableResource):
    """Placeholder Slack resource.

    In a real deployment, implement HTTP calls to Slack API.
    """

    webhook_url: str

    def send_message(self, text: str) -> None:
        # Replace with actual Slack API call.
        print(f"[Slack] Sending message: {text}")


# ----------------------------------------------------------------------
# Failure Hook
# ----------------------------------------------------------------------


def slack_failure_hook(context: HookContext) -> HookResult:
    """Send a Slack notification when an op fails.

    Args:
        context: Hook context containing resources and failure information.

    Returns:
        HookResult indicating successful handling.
    """
    slack: SlackResource = context.resources.slack_api
    failure: Failure = context.failure
    message = (
        f"Dagster job `{context.job_name}` failed in op `{context.op.name}`.\n"
        f"Error: {failure.error}"
    )
    slack.send_message(message)
    return HookResult.success()


# ----------------------------------------------------------------------
# Ops
# ----------------------------------------------------------------------


@op(
    required_resource_keys={"snowflake_conn"},
    description="Create analytics table via CTAS in Snowflake.",
    out=Out(str),
    hooks={"on_failure": [slack_failure_hook]},
)
def run_ctas(context) -> str:
    """Execute a CTAS statement to build the analytics table.

    Returns:
        A string indicating successful completion.
    """
    snowflake: SnowflakeResource = context.resources.snowflake_conn
    ctas_query = """
    CREATE OR REPLACE TABLE analytics AS
    SELECT *
    FROM source_table;
    """
    context.log.info("Running CTAS query in Snowflake.")
    snowflake.execute_query(ctas_query)
    context.log.info("Analytics table created successfully.")
    return "ctas_success"


@op(
    required_resource_keys={"slack_api"},
    description="Send a Slack notification on job failure.",
    out=Out(None),
)
def slack_failure_alert(context, _: str) -> None:
    """Placeholder op for Slack failure alerts.

    This op is not directly invoked; failure handling is performed via
    `slack_failure_hook`. It exists to satisfy the pipeline specification.
    """
    # No implementation needed; the hook handles notifications.
    pass


# ----------------------------------------------------------------------
# Job Definition
# ----------------------------------------------------------------------


@job(
    executor_def=in_process_executor,
    resource_defs={
        "snowflake_conn": SnowflakeResource.configure_at_launch(),
        "slack_api": SlackResource.configure_at_launch(),
        "io_manager": fs_io_manager,
    },
    description="No description provided.",
)
def run_ctas_pipeline():
    """Dagster job that creates an analytics table and notifies Slack on failure."""
    # The primary operation.
    ctas_result = run_ctas()
    # The Slack alert op is defined for completeness but is not part of the
    # execution graph; failure notifications are handled by the hook.
    slack_failure_alert(ctas_result)


# ----------------------------------------------------------------------
# Schedule (disabled)
# ----------------------------------------------------------------------


run_ctas_schedule = ScheduleDefinition(
    job=run_ctas_pipeline,
    cron_schedule="@daily",
    default_status=DefaultScheduleStatus.INACTIVE,
    timezone="UTC",
    description="Daily schedule for run_ctas_pipeline (currently disabled).",
)