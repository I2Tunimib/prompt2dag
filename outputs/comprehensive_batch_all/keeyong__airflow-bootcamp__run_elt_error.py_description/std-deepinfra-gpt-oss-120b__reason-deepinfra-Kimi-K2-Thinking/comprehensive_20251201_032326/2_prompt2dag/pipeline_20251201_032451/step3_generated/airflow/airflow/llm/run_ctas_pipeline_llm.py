# Generated by Airflow DAG generator on 2024-06-13
# DAG: run_ctas_pipeline
# Description: No description provided.
# Pattern: sequential

import json
from datetime import datetime, timedelta

import pendulum
from airflow import DAG
from airflow.exceptions import AirflowException
from airflow.models import Variable
from airflow.providers.snowflake.hooks.snowflake import SnowflakeHook
from airflow.providers.http.hooks.http import HttpHook
from airflow.utils.trigger_rule import TriggerRule
from airflow.decorators import task

# Default arguments for the DAG
default_args = {
    "owner": "airflow",
    "depends_on_past": False,
    "retries": 0,
    "retry_delay": timedelta(minutes=5),
    "email_on_failure": False,
    "email_on_retry": False,
}

# DAG definition
with DAG(
    dag_id="run_ctas_pipeline",
    description="No description provided.",
    schedule_interval="@daily",
    start_date=datetime(2024, 1, 1, tzinfo=pendulum.timezone("UTC")),
    catchup=False,
    default_args=default_args,
    tags=["snowflake", "slack"],
    is_paused_upon_creation=True,  # Disabled by default
    render_template_as_native_obj=True,
) as dag:

    @task(task_id="run_ctas", retries=0)
    def run_ctas():
        """
        Create Analytics Table via CTAS in Snowflake.
        """
        # Define the CTAS query â€“ replace with your actual query
        ctas_query = """
        CREATE OR REPLACE TABLE analytics.my_analytics_table AS
        SELECT *
        FROM source_schema.source_table
        WHERE created_at >= DATEADD(day, -1, CURRENT_DATE())
        """
        try:
            snowflake = SnowflakeHook(snowflake_conn_id="snowflake")
            snowflake.run(ctas_query)
        except Exception as exc:
            raise AirflowException(f"CTAS query failed: {exc}")

    @task(
        task_id="slack_failure_alert",
        retries=0,
        trigger_rule=TriggerRule.ONE_FAILED,
    )
    def slack_failure_alert(context):
        """
        Send a Slack notification when the CTAS task fails.
        """
        # Retrieve the failed task information from context
        failed_task = context.get("task_instance")
        dag_id = context.get("dag").dag_id
        execution_date = context.get("execution_date")
        log_url = failed_task.log_url if failed_task else "N/A"

        message = {
            "text": f":x: *Airflow Alert*\n"
            f"*DAG*: `{dag_id}`\n"
            f"*Task*: `{failed_task.task_id if failed_task else 'unknown'}`\n"
            f"*Execution*: `{execution_date}`\n"
            f"*Log*: {log_url}"
        }

        try:
            http = HttpHook(http_conn_id="slack_api", method="POST")
            # Slack expects JSON payload
            response = http.run(
                endpoint="",  # Assuming the connection's base URL is the webhook URL
                data=json.dumps(message),
                headers={"Content-Type": "application/json"},
            )
            if response.status_code != 200:
                raise AirflowException(
                    f"Slack notification failed with status {response.status_code}: {response.text}"
                )
        except Exception as exc:
            raise AirflowException(f"Failed to send Slack alert: {exc}")

    # Define task dependencies
    run_ctas_task = run_ctas()
    slack_alert_task = slack_failure_alert()

    run_ctas_task >> slack_alert_task