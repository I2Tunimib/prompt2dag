# Generated by Dagster code generator
# Date: 2024-06-13
# Pipeline: start_pipeline_pipeline
# Description: No description provided.

from typing import List, Dict, Any
import pandas as pd
from dagster import (
    op,
    job,
    RetryPolicy,
    In,
    Out,
    Nothing,
    Output,
    ResourceDefinition,
    fs_io_manager,
    multiprocess_executor,
    ConfigurableResource,
    InitResourceContext,
)

# ----------------------------------------------------------------------
# Resources
# ----------------------------------------------------------------------


class CSVStorageResource(ConfigurableResource):
    """Simple resource that provides a base directory for CSV files."""

    base_path: str

    def get_path(self, filename: str) -> str:
        """Return the full path for a given filename."""
        return f"{self.base_path}/{filename}"


class EmailNotificationResource(ConfigurableResource):
    """Placeholder resource for sending email notifications."""

    smtp_server: str
    smtp_port: int
    username: str
    password: str

    def send_email(self, subject: str, body: str, recipients: List[str]) -> None:
        """Send an email (no‑op placeholder)."""
        # In a real implementation, integrate with smtplib or a third‑party service.
        pass


# ----------------------------------------------------------------------
# Ops
# ----------------------------------------------------------------------


@op(
    out=Out(pd.DataFrame),
    description="Entry point of the pipeline; does not produce data.",
    required_resource_keys=set(),
)
def start_pipeline(_: Nothing) -> Nothing:
    """Start of the pipeline – used for orchestration only."""
    return None


def _read_csv(context: InitResourceContext, filename: str) -> pd.DataFrame:
    path = context.resources.csv_storage.get_path(filename)
    context.log.info(f"Reading CSV from {path}")
    return pd.read_csv(path)


@op(
    out=Out(pd.DataFrame),
    retry_policy=RetryPolicy(max_retries=2),
    description="Ingest APAC sales CSV data.",
    required_resource_keys={"regional_sales_apac"},
)
def ingest_apac(context) -> pd.DataFrame:
    return _read_csv(context, "apac_sales.csv")


@op(
    out=Out(pd.DataFrame),
    retry_policy=RetryPolicy(max_retries=2),
    description="Ingest EU sales CSV data.",
    required_resource_keys={"regional_sales_eu"},
)
def ingest_eu(context) -> pd.DataFrame:
    return _read_csv(context, "eu_sales.csv")


@op(
    out=Out(pd.DataFrame),
    retry_policy=RetryPolicy(max_retries=2),
    description="Ingest US‑East sales CSV data.",
    required_resource_keys={"regional_sales_us_east"},
)
def ingest_us_east(context) -> pd.DataFrame:
    return _read_csv(context, "us_east_sales.csv")


@op(
    out=Out(pd.DataFrame),
    retry_policy=RetryPolicy(max_retries=2),
    description="Ingest US‑West sales CSV data.",
    required_resource_keys={"regional_sales_us_west"},
)
def ingest_us_west(context) -> pd.DataFrame:
    return _read_csv(context, "us_west_sales.csv")


def _convert_to_usd(df: pd.DataFrame, rate: float) -> pd.DataFrame:
    """Convert a monetary column named 'revenue' to USD using the supplied rate."""
    df = df.copy()
    if "revenue" in df.columns:
        df["revenue_usd"] = df["revenue"] * rate
    else:
        df["revenue_usd"] = 0.0
    return df


@op(
    ins={"sales": In(pd.DataFrame)},
    out=Out(pd.DataFrame),
    retry_policy=RetryPolicy(max_retries=2),
    description="Convert APAC currency to USD.",
)
def convert_currency_apac(sales: pd.DataFrame) -> pd.DataFrame:
    # Placeholder conversion rate; replace with real logic.
    conversion_rate = 0.00075  # Example: 1 local unit = 0.00075 USD
    return _convert_to_usd(sales, conversion_rate)


@op(
    ins={"sales": In(pd.DataFrame)},
    out=Out(pd.DataFrame),
    retry_policy=RetryPolicy(max_retries=2),
    description="Convert EU currency to USD.",
)
def convert_currency_eu(sales: pd.DataFrame) -> pd.DataFrame:
    conversion_rate = 1.10  # Example: 1 EUR = 1.10 USD
    return _convert_to_usd(sales, conversion_rate)


@op(
    ins={"sales": In(pd.DataFrame)},
    out=Out(pd.DataFrame),
    retry_policy=RetryPolicy(max_retries=2),
    description="Convert US‑East currency to USD (identity).",
)
def convert_currency_us_east(sales: pd.DataFrame) -> pd.DataFrame:
    conversion_rate = 1.0
    return _convert_to_usd(sales, conversion_rate)


@op(
    ins={"sales": In(pd.DataFrame)},
    out=Out(pd.DataFrame),
    retry_policy=RetryPolicy(max_retries=2),
    description="Convert US‑West currency to USD (identity).",
)
def convert_currency_us_west(sales: pd.DataFrame) -> pd.DataFrame:
    conversion_rate = 1.0
    return _convert_to_usd(sales, conversion_rate)


@op(
    ins={
        "apac": In(pd.DataFrame),
        "eu": In(pd.DataFrame),
        "us_east": In(pd.DataFrame),
        "us_west": In(pd.DataFrame),
    },
    out=Out(pd.DataFrame),
    retry_policy=RetryPolicy(max_retries=2),
    description="Aggregate all regional revenues into a global report.",
    required_resource_keys={"global_report_storage"},
)
def aggregate_global_revenue(
    apac: pd.DataFrame,
    eu: pd.DataFrame,
    us_east: pd.DataFrame,
    us_west: pd.DataFrame,
    context,
) -> pd.DataFrame:
    """Combine regional DataFrames and compute total revenue."""
    combined = pd.concat([apac, eu, us_east, us_west], ignore_index=True)
    total_usd = combined["revenue_usd"].sum()
    report = pd.DataFrame({"total_revenue_usd": [total_usd]})
    # Persist report
    output_path = context.resources.global_report_storage.get_path("global_revenue_report.csv")
    context.log.info(f"Writing global report to {output_path}")
    report.to_csv(output_path, index=False)
    return report


@op(
    ins={"report": In(pd.DataFrame)},
    out=Out(Nothing),
    description="Finalize pipeline; send notification email.",
    required_resource_keys={"email_notification_smtp"},
)
def end_pipeline(context, report: pd.DataFrame) -> Nothing:
    """Send a notification that the pipeline completed successfully."""
    subject = "Global Revenue Report Ready"
    body = f"The global revenue report has been generated. Total USD revenue: {report['total_revenue_usd'].iloc[0]:,.2f}"
    recipients = ["finance@example.com"]
    context.resources.email_notification_smtp.send_email(subject, body, recipients)
    context.log.info("Notification email sent.")
    return None


# ----------------------------------------------------------------------
# Job definition
# ----------------------------------------------------------------------


@job(
    executor_def=multiprocess_executor,
    description="No description provided.",
    resource_defs={
        "regional_sales_apac": CSVStorageResource(base_path="/data/apac"),
        "regional_sales_eu": CSVStorageResource(base_path="/data/eu"),
        "regional_sales_us_east": CSVStorageResource(base_path="/data/us_east"),
        "regional_sales_us_west": CSVStorageResource(base_path="/data/us_west"),
        "global_report_storage": CSVStorageResource(base_path="/data/global_reports"),
        "email_notification_smtp": EmailNotificationResource(
            smtp_server="smtp.example.com",
            smtp_port=587,
            username="user",
            password="pass",
        ),
        "fs_io_manager": fs_io_manager,
    },
)
def start_pipeline_pipeline():
    """Dagster job implementing the fan‑out/fan‑in revenue aggregation pipeline."""
    # Start node
    start = start_pipeline()

    # Ingestion fan‑out
    us_east_raw = ingest_us_east()
    us_west_raw = ingest_us_west()
    eu_raw = ingest_eu()
    apac_raw = ingest_apac()

    # Currency conversion fan‑out
    us_east_usd = convert_currency_us_east(us_east_raw)
    us_west_usd = convert_currency_us_west(us_west_raw)
    eu_usd = convert_currency_eu(eu_raw)
    apac_usd = convert_currency_apac(apac_raw)

    # Aggregation (fan‑in)
    report = aggregate_global_revenue(
        apac=apac_usd,
        eu=eu_usd,
        us_east=us_east_usd,
        us_west=us_west_usd,
    )

    # End node
    end_pipeline(report)