# Generated by Airflow DAG Generator
# Date: 2023-10-05
# Airflow Version: 2.x
# Description: No description provided.
# Pattern: fanout_fanin

from airflow import DAG
from airflow.operators.python import PythonOperator
from airflow.utils.dates import days_ago
from datetime import timedelta

# Default arguments for the DAG
default_args = {
    'owner': 'airflow',
    'retries': 0,
    'retry_delay': timedelta(minutes=5),
}

# Define the DAG
with DAG(
    dag_id='start_pipeline_pipeline',
    default_args=default_args,
    schedule_interval='@daily',
    start_date=days_ago(1),
    catchup=False,
    tags=['example'],
) as dag:

    # Define the start_pipeline task
    def start_pipeline():
        print("Pipeline started")

    start_pipeline_task = PythonOperator(
        task_id='start_pipeline',
        python_callable=start_pipeline,
        retries=0,
    )

    # Define the ingest tasks
    def ingest_sales_data(region):
        print(f"Ingesting {region} sales data")

    ingest_apac_task = PythonOperator(
        task_id='ingest_apac',
        python_callable=ingest_sales_data,
        op_kwargs={'region': 'APAC'},
        retries=2,
    )

    ingest_eu_task = PythonOperator(
        task_id='ingest_eu',
        python_callable=ingest_sales_data,
        op_kwargs={'region': 'EU'},
        retries=2,
    )

    ingest_us_east_task = PythonOperator(
        task_id='ingest_us_east',
        python_callable=ingest_sales_data,
        op_kwargs={'region': 'US-East'},
        retries=2,
    )

    ingest_us_west_task = PythonOperator(
        task_id='ingest_us_west',
        python_callable=ingest_sales_data,
        op_kwargs={'region': 'US-West'},
        retries=2,
    )

    # Define the convert currency tasks
    def convert_currency(region):
        print(f"Converting {region} currency to USD")

    convert_currency_apac_task = PythonOperator(
        task_id='convert_currency_apac',
        python_callable=convert_currency,
        op_kwargs={'region': 'APAC'},
        retries=2,
    )

    convert_currency_eu_task = PythonOperator(
        task_id='convert_currency_eu',
        python_callable=convert_currency,
        op_kwargs={'region': 'EU'},
        retries=2,
    )

    convert_currency_us_east_task = PythonOperator(
        task_id='convert_currency_us_east',
        python_callable=convert_currency,
        op_kwargs={'region': 'US-East'},
        retries=2,
    )

    convert_currency_us_west_task = PythonOperator(
        task_id='convert_currency_us_west',
        python_callable=convert_currency,
        op_kwargs={'region': 'US-West'},
        retries=2,
    )

    # Define the aggregate global revenue task
    def aggregate_global_revenue():
        print("Aggregating global revenue")

    aggregate_global_revenue_task = PythonOperator(
        task_id='aggregate_global_revenue',
        python_callable=aggregate_global_revenue,
        retries=2,
    )

    # Define the end_pipeline task
    def end_pipeline():
        print("Pipeline ended")

    end_pipeline_task = PythonOperator(
        task_id='end_pipeline',
        python_callable=end_pipeline,
        retries=0,
    )

    # Set task dependencies
    start_pipeline_task >> [ingest_apac_task, ingest_eu_task, ingest_us_east_task, ingest_us_west_task]
    ingest_apac_task >> convert_currency_apac_task
    ingest_eu_task >> convert_currency_eu_task
    ingest_us_east_task >> convert_currency_us_east_task
    ingest_us_west_task >> convert_currency_us_west_task
    [convert_currency_apac_task, convert_currency_eu_task, convert_currency_us_east_task, convert_currency_us_west_task] >> aggregate_global_revenue_task
    aggregate_global_revenue_task >> end_pipeline_task