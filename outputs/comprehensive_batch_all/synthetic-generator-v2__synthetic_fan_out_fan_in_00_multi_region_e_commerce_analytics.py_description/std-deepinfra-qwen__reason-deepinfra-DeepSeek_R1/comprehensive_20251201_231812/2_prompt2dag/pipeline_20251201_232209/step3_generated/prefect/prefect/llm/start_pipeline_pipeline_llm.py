# Generated by Prefect 2.x Code Generator
# Date: 2023-10-05
# Prefect Version: 2.14.0

from prefect import flow, task, get_run_logger
from prefect.task_runners import ConcurrentTaskRunner
from prefect.deployments import Deployment
from prefect.orion.schemas.schedules import CronSchedule
from prefect.filesystems import LocalFileSystem
from prefect.blocks.system import Secret
import subprocess

# Load the required resources
us_east_data_source = LocalFileSystem.load("us_east_data_source")
us_west_data_source = LocalFileSystem.load("us_west_data_source")
eu_data_source = LocalFileSystem.load("eu_data_source")
apac_data_source = LocalFileSystem.load("apac_data_source")
xcom = Secret.load("xcom")

@task(retries=0)
def start_pipeline():
    """Start the pipeline."""
    logger = get_run_logger()
    logger.info("Pipeline started.")
    return "Pipeline started."

@task(retries=2)
def ingest_sales_data(data_source, region):
    """Ingest sales data from the specified region."""
    logger = get_run_logger()
    logger.info(f"Ingesting sales data from {region}...")
    # Example command: subprocess.run(["python", "ingest.py", "--region", region])
    subprocess.run(["python", "ingest.py", "--region", region])
    logger.info(f"Sales data from {region} ingested successfully.")
    return f"Sales data from {region} ingested successfully."

@task(retries=2)
def convert_currency(region):
    """Convert currency to USD for the specified region."""
    logger = get_run_logger()
    logger.info(f"Converting currency to USD for {region}...")
    # Example command: subprocess.run(["python", "convert_currency.py", "--region", region])
    subprocess.run(["python", "convert_currency.py", "--region", region])
    logger.info(f"Currency for {region} converted to USD successfully.")
    return f"Currency for {region} converted to USD successfully."

@task(retries=2)
def aggregate_global_revenue():
    """Aggregate global revenue."""
    logger = get_run_logger()
    logger.info("Aggregating global revenue...")
    # Example command: subprocess.run(["python", "aggregate_revenue.py"])
    subprocess.run(["python", "aggregate_revenue.py"])
    logger.info("Global revenue aggregated successfully.")
    return "Global revenue aggregated successfully."

@task(retries=0)
def end_pipeline():
    """End the pipeline."""
    logger = get_run_logger()
    logger.info("Pipeline ended.")
    return "Pipeline ended."

@flow(name="start_pipeline_pipeline", task_runner=ConcurrentTaskRunner())
def start_pipeline_pipeline():
    """Main pipeline flow to ingest, convert, and aggregate sales data."""
    start = start_pipeline()

    ingest_us_east = ingest_sales_data.submit(us_east_data_source, "US-East", wait_for=[start])
    ingest_us_west = ingest_sales_data.submit(us_west_data_source, "US-West", wait_for=[start])
    ingest_eu = ingest_sales_data.submit(eu_data_source, "EU", wait_for=[start])
    ingest_apac = ingest_sales_data.submit(apac_data_source, "APAC", wait_for=[start])

    convert_us_east = convert_currency.submit("US-East", wait_for=[ingest_us_east])
    convert_us_west = convert_currency.submit("US-West", wait_for=[ingest_us_west])
    convert_eu = convert_currency.submit("EU", wait_for=[ingest_eu])
    convert_apac = convert_currency.submit("APAC", wait_for=[ingest_apac])

    aggregate = aggregate_global_revenue.submit(wait_for=[convert_us_east, convert_us_west, convert_eu, convert_apac])

    end = end_pipeline.submit(wait_for=[aggregate])

# Schedule the deployment
deployment = Deployment.build_from_flow(
    flow=start_pipeline_pipeline,
    name="start_pipeline_pipeline_deployment",
    work_pool_name="default-agent-pool",
    schedule=CronSchedule(cron="0 0 * * *", timezone="UTC", catchup=False),
)

if __name__ == "__main__":
    deployment.apply()