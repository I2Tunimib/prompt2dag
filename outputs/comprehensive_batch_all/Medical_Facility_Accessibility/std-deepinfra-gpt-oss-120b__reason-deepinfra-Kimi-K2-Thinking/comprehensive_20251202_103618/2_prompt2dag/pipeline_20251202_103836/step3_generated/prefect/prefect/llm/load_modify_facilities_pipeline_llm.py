# Generated by Prefect Pipeline Generator
# Pipeline: load_modify_facilities_pipeline
# Description: No description provided.
# Generated on: 2024-06-13

from __future__ import annotations

import os
from typing import Dict

from prefect import flow, task
from prefect.task_runners import SequentialTaskRunner
from prefect_docker import DockerContainer
from prefect.blocks.system import Secret
from prefect.filesystems import LocalFileSystem


def _get_local_path(block_name: str) -> str:
    """
    Load a ``LocalFileSystem`` block and return its base path.

    Args:
        block_name: Name of the Prefect block.

    Returns:
        The absolute path to the directory represented by the block.
    """
    block: LocalFileSystem = LocalFileSystem.load(block_name)
    return os.path.abspath(block.base_path)


def _get_secret_value(secret_name: str) -> str:
    """
    Load a ``Secret`` block and return its stored value.

    Args:
        secret_name: Name of the Prefect secret block.

    Returns:
        The secret value as a string.
    """
    secret: Secret = Secret.load(secret_name)
    return secret.get()


def _docker_task(
    image: str,
    env: Dict[str, str],
    volumes: Dict[str, Dict[str, str]] | None = None,
) -> DockerContainer:
    """
    Helper to create a ``DockerContainer`` task with common configuration.

    Args:
        image: Docker image to run.
        env: Environment variables for the container.
        volumes: Optional volume bindings.

    Returns:
        Configured ``DockerContainer`` task.
    """
    return DockerContainer(
        image=image,
        env=env,
        volumes=volumes,
        # Pull the latest image each run to avoid stale caches
        pull=True,
        # Ensure the container is removed after execution
        remove=True,
    )


# -------------------------------------------------------------------------
# Task definitions
# -------------------------------------------------------------------------

@task(retries=1, name="Load and Modify Facilities Data")
def load_modify_facilities() -> str:
    """
    Load raw facilities data and apply initial modifications.

    Returns:
        Container logs or identifier for downstream tasks.
    """
    data_dir = _get_local_path("data_dir_volume")
    volumes = {data_dir: {"bind": "/app/data", "mode": "rw"}}

    docker_task = _docker_task(
        image="i2t-backendwithintertwino6-load-and-modify:latest",
        env={"DATASET_ID": "2", "TABLE_NAME_PREFIX": "JOT_"},
        volumes=volumes,
    )
    return docker_task.run()


@task(retries=1, name="Geocode Facilities Using HERE API")
def geocode_facilities() -> str:
    """
    Enrich facilities with latitude/longitude using the HERE geocoding service.

    Returns:
        Container logs or identifier for downstream tasks.
    """
    data_dir = _get_local_path("data_dir_volume")
    volumes = {data_dir: {"bind": "/app/data", "mode": "rw"}}

    here_token = _get_secret_value("here_geocoding_api")

    docker_task = _docker_task(
        image="i2t-backendwithintertwino6-reconciliation:latest",
        env={
            "PRIMARY_COLUMN": "address",
            "RECONCILIATOR_ID": "geocodingHere",
            "API_TOKEN": here_token,
            "DATASET_ID": "2",
        },
        volumes=volumes,
    )
    return docker_task.run()


@task(retries=1, name="Calculate Distance to Nearest Public Transport")
def calculate_distance_to_public_transport() -> str:
    """
    Compute the distance from each facility to the nearest public transport stop.

    Returns:
        Container logs or identifier for downstream tasks.
    """
    data_dir = _get_local_path("data_dir_volume")
    transport_geojson = _get_local_path("transport_stops_geojson")
    # Bind the directory containing the GeoJSON file
    volumes = {
        data_dir: {"bind": "/app/data", "mode": "rw"},
        transport_geojson: {"bind": "/app/data/transport_stops.geojson", "mode": "ro"},
    }

    docker_task = _docker_task(
        image="i2t-backendwithintertwino6-column-extension:latest",
        env={
            "EXTENDER_ID": "spatialDistanceCalculator",
            "LAT_COLUMN": "latitude",
            "LON_COLUMN": "longitude",
            "TARGET_LAYER": "public_transport",
            "TARGET_DATA_SOURCE": "/app/data/transport_stops.geojson",
            "OUTPUT_COLUMN": "distance_to_pt",
            "DATASET_ID": "2",
        },
        volumes=volumes,
    )
    return docker_task.run()


@task(retries=1, name="Calculate Distance to Nearest Residential Area")
def calculate_distance_to_residential_areas() -> str:
    """
    Compute the distance from each facility to the nearest residential area.

    Returns:
        Container logs or identifier for downstream tasks.
    """
    data_dir = _get_local_path("data_dir_volume")
    residential_geojson = _get_local_path("residential_areas_geojson")
    volumes = {
        data_dir: {"bind": "/app/data", "mode": "rw"},
        residential_geojson: {"bind": "/app/data/residential_areas.geojson", "mode": "ro"},
    }

    docker_task = _docker_task(
        image="i2t-backendwithintertwino6-column-extension:latest",
        env={
            "EXTENDER_ID": "spatialDistanceCalculator",
            "LAT_COLUMN": "latitude",
            "LON_COLUMN": "longitude",
            "TARGET_LAYER": "residential_areas",
            "TARGET_DATA_SOURCE": "/app/data/residential_areas.geojson",
            "OUTPUT_COLUMN": "distance_to_residential",
            "DATASET_ID": "2",
        },
        volumes=volumes,
    )
    return docker_task.run()


@task(retries=1, name="Save Enriched Facility Accessibility Data")
def save_facilities_accessibility() -> str:
    """
    Persist the enriched facility dataset back to the internal API service.

    Returns:
        Container logs or identifier confirming successful save.
    """
    data_dir = _get_local_path("data_dir_volume")
    volumes = {data_dir: {"bind": "/app/data", "mode": "rw"}}

    docker_task = _docker_task(
        image="i2t-backendwithintertwino6-save:latest",
        env={"DATASET_ID": "2"},
        volumes=volumes,
    )
    return docker_task.run()


# -------------------------------------------------------------------------
# Flow definition
# -------------------------------------------------------------------------

@flow(
    name="load_modify_facilities_pipeline",
    task_runner=SequentialTaskRunner(),
)
def load_modify_facilities_pipeline() -> None:
    """
    Orchestrates the full pipeline for loading, enriching, and saving facility data.

    Execution order:
        1. Load and modify facilities
        2. Geocode facilities
        3. Calculate distance to public transport
        4. Calculate distance to residential areas
        5. Save the enriched dataset
    """
    # Step 1
    load_modify_facilities_result = load_modify_facilities()

    # Step 2
    geocode_facilities_result = geocode_facilities(wait_for=[load_modify_facilities_result])

    # Step 3
    distance_pt_result = calculate_distance_to_public_transport(
        wait_for=[geocode_facilities_result]
    )

    # Step 4
    distance_res_result = calculate_distance_to_residential_areas(
        wait_for=[distance_pt_result]
    )

    # Step 5
    save_facilities_accessibility(wait_for=[distance_res_result])


if __name__ == "__main__":
    # Execute the flow locally; in production this flow would be deployed
    # via a Prefect deployment with the configuration provided in the spec.
    load_modify_facilities_pipeline()