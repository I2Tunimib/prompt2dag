# Generated by Dagster Code Generator
# Date: 2024-06-20
# Pipeline: load_modify_facilities_pipeline
# Description: No description provided.
# Executor: docker_executor
# Dagster version: 1.5.0

from typing import Any, Dict

import dagster
from dagster import (
    op,
    job,
    RetryPolicy,
    In,
    Out,
    Nothing,
    ConfigurableResource,
    ResourceDefinition,
    InitResourceContext,
    Output,
    get_dagster_logger,
)

# ----------------------------------------------------------------------
# Resource placeholders (replace with real implementations)
# ----------------------------------------------------------------------


class FsIOManager(ConfigurableResource):
    """File system IO manager for reading/writing data."""

    base_dir: str = "/tmp/data"

    def read(self, path: str) -> Any:
        logger = get_dagster_logger()
        logger.info(f"Reading data from {self.base_dir}/{path}")
        # Placeholder: replace with actual read logic
        return {}

    def write(self, path: str, obj: Any) -> None:
        logger = get_dagster_logger()
        logger.info(f"Writing data to {self.base_dir}/{path}")
        # Placeholder: replace with actual write logic


class InternalApiService(ConfigurableResource):
    """Internal service for load‑modify / reconciliation / column‑extension / save."""

    def process_facilities(self, data: Any) -> Any:
        # Placeholder implementation
        return data


class HereGeocodingApi(ConfigurableResource):
    """HERE Geocoding API client."""

    api_key: str

    def geocode(self, facilities: Any) -> Any:
        # Placeholder implementation
        return facilities


class MongoDbResource(ConfigurableResource):
    """MongoDB connection resource."""

    uri: str

    def get_client(self):
        # Placeholder implementation
        return None


class IntertwinoApi(ConfigurableResource):
    """Intertwino API client."""

    token: str

    def enrich(self, data: Any) -> Any:
        # Placeholder implementation
        return data


# ----------------------------------------------------------------------
# Ops
# ----------------------------------------------------------------------


@op(
    name="load_modify_facilities",
    description="Load raw facilities data and apply internal modifications.",
    out=Out(dagster.Any, description="Modified facilities data"),
    retry_policy=RetryPolicy(max_retries=1),
    required_resource_keys={"internal_api_service", "data_dir_volume"},
)
def load_modify_facilities(context: dagster.OpExecutionContext) -> Any:
    """Load facilities from the shared data directory and apply internal modifications."""
    logger = context.log
    data_dir = context.resources.data_dir_volume
    internal_api = context.resources.internal_api_service

    raw_data = data_dir.read("raw_facilities.json")
    logger.info("Raw facilities data loaded.")
    modified = internal_api.process_facilities(raw_data)
    logger.info("Facilities data modified via internal API.")
    return modified


@op(
    name="geocode_facilities",
    description="Geocode facilities using the HERE Geocoding API.",
    ins={"facilities": In(dagster.Any)},
    out=Out(dagster.Any, description="Facilities with geocoded coordinates"),
    retry_policy=RetryPolicy(max_retries=1),
    required_resource_keys={"here_geocoding_api"},
)
def geocode_facilities(context: dagster.OpExecutionContext, facilities: Any) -> Any:
    """Enrich facilities with latitude/longitude using HERE Geocoding."""
    logger = context.log
    geocoder = context.resources.here_geocoding_api

    geocoded = geocoder.geocode(facilities)
    logger.info("Facilities geocoded via HERE API.")
    return geocoded


@op(
    name="calculate_distance_to_public_transport",
    description="Calculate distance from each facility to the nearest public transport stop.",
    ins={"facilities": In(dagster.Any)},
    out=Out(dagster.Any, description="Facilities with distance to public transport"),
    retry_policy=RetryPolicy(max_retries=1),
    required_resource_keys={"transport_stops_geojson"},
)
def calculate_distance_to_public_transport(
    context: dagster.OpExecutionContext, facilities: Any
) -> Any:
    """Compute distance to nearest public transport stop for each facility."""
    logger = context.log
    stops_geojson = context.resources.transport_stops_geojson.read("public_transport_stops.geojson")

    # Placeholder distance calculation
    enriched = facilities  # Replace with real distance logic
    logger.info("Calculated distance to public transport.")
    return enriched


@op(
    name="calculate_distance_to_residential_areas",
    description="Calculate distance from each facility to the nearest residential area.",
    ins={"facilities": In(dagster.Any)},
    out=Out(dagster.Any, description="Facilities with distance to residential areas"),
    retry_policy=RetryPolicy(max_retries=1),
    required_resource_keys={"residential_areas_geojson"},
)
def calculate_distance_to_residential_areas(
    context: dagster.OpExecutionContext, facilities: Any
) -> Any:
    """Compute distance to nearest residential area for each facility."""
    logger = context.log
    residential_geojson = context.resources.residential_areas_geojson.read(
        "residential_areas.geojson"
    )

    # Placeholder distance calculation
    enriched = facilities  # Replace with real distance logic
    logger.info("Calculated distance to residential areas.")
    return enriched


@op(
    name="save_facilities_accessibility",
    description="Persist the enriched facility accessibility data.",
    ins={"facilities": In(dagster.Any)},
    out=Out(Nothing),
    retry_policy=RetryPolicy(max_retries=1),
    required_resource_keys={"data_dir_volume"},
)
def save_facilities_accessibility(
    context: dagster.OpExecutionContext, facilities: Any
) -> Nothing:
    """Write the final enriched facilities data back to the shared data directory."""
    logger = context.log
    data_dir = context.resources.data_dir_volume

    data_dir.write("enriched_facilities.json", facilities)
    logger.info("Enriched facilities data saved.")
    return Nothing


# ----------------------------------------------------------------------
# Job definition
# ----------------------------------------------------------------------


@job(
    name="load_modify_facilities_pipeline",
    description="No description provided.",
    executor_def=dagster.DockerExecutor(
        # Example configuration; adjust image and options as needed.
        image="python:3.11-slim",
        network="host",
        env_vars={"PYTHONUNBUFFERED": "1"},
    ),
    resource_defs={
        "data_dir_volume": FsIOManager(),
        "internal_api_service": InternalApiService(),
        "here_geocoding_api": HereGeocodingApi(api_key="YOUR_HERE_API_KEY"),
        "mongo_db": MongoDbResource(uri="mongodb://localhost:27017"),
        "intertwino_api": IntertwinoApi(token="YOUR_INTERTWINO_TOKEN"),
        "transport_stops_geojson": FsIOManager(),
        "residential_areas_geojson": FsIOManager(),
    },
)
def load_modify_facilities_pipeline():
    """Sequential pipeline that loads, enriches, and saves facility accessibility data."""
    facilities = load_modify_facilities()
    geocoded = geocode_facilities(facilities)
    with_public_transport = calculate_distance_to_public_transport(geocoded)
    with_residential = calculate_distance_to_residential_areas(with_public_transport)
    save_facilities_accessibility(with_residential)