# Generated by Airflow DAG generator on 2024-06-28
"""
DAG: load_and_modify_facilities_pipeline
Description: Sequential pipeline to load, modify, geocode facilities and calculate accessibility metrics.
"""

from datetime import datetime, timedelta
from pathlib import Path

from airflow import DAG
from airflow.providers.docker.operators.docker import DockerOperator
from airflow.utils.trigger_rule import TriggerRule
from airflow.utils.email import send_email

# ----------------------------------------------------------------------
# Default arguments applied to all tasks
# ----------------------------------------------------------------------
default_args = {
    "owner": "airflow",
    "depends_on_past": False,
    "retries": 1,
    "retry_delay": timedelta(minutes=5),
    "email_on_failure": False,
    "email_on_retry": False,
}


def _failure_callback(context):
    """Send a simple email on task failure."""
    dag_id = context.get("dag").dag_id
    task_id = context.get("task_instance").task_id
    execution_date = context.get("execution_date")
    log_url = context.get("task_instance").log_url

    subject = f"[Airflow] DAG {dag_id} - Task {task_id} Failed"
    html_content = f"""
    <p>Task <strong>{task_id}</strong> in DAG <strong>{dag_id}</strong> has failed.</p>
    <p><strong>Execution date:</strong> {execution_date}</p>
    <p><strong>Log URL:</strong> <a href="{log_url}">{log_url}</a></p>
    """
    # Adjust the recipient list as needed
    send_email(to=["airflow-alerts@example.com"], subject=subject, html_content=html_content)


# ----------------------------------------------------------------------
# DAG definition
# ----------------------------------------------------------------------
with DAG(
    dag_id="load_and_modify_facilities_pipeline",
    description="Sequential pipeline to load, modify, geocode facilities and calculate accessibility metrics.",
    default_args=default_args,
    schedule_interval=None,  # Disabled schedule
    start_date=datetime(2024, 1, 1),
    catchup=False,
    tags=["load_modify", "geocoding", "accessibility"],
    on_failure_callback=_failure_callback,
    render_template_as_native_obj=True,
) as dag:

    # ------------------------------------------------------------------
    # Common Docker configuration
    # ------------------------------------------------------------------
    # The shared data directory is mounted into containers at /app/data.
    # Adjust the host path according to your environment.
    DATA_VOLUME_HOST_PATH = "/opt/airflow/shared_data"
    DATA_VOLUME_CONTAINER_PATH = "/app/data"
    VOLUMES = {
        DATA_VOLUME_HOST_PATH: {
            "bind": DATA_VOLUME_CONTAINER_PATH,
            "mode": "rw",
        }
    }

    # ------------------------------------------------------------------
    # Task: Load & Modify Facilities Data
    # ------------------------------------------------------------------
    load_and_modify_facilities = DockerOperator(
        task_id="load_and_modify_facilities",
        image="i2t-backendwithintertwino6-load-and-modify:latest",
        api_version="auto",
        auto_remove=True,
        command=None,
        docker_url="unix://var/run/docker.sock",
        network_mode="bridge",
        environment={
            "DATASET_ID": "2",
            "TABLE_NAME_PREFIX": "JOT_",
        },
        volumes=VOLUMES,
        trigger_rule=TriggerRule.ALL_SUCCESS,
    )

    # ------------------------------------------------------------------
    # Task: Geocode Facilities (HERE)
    # ------------------------------------------------------------------
    geocode_facilities_here = DockerOperator(
        task_id="geocode_facilities_here",
        image="i2t-backendwithintertwino6-reconciliation:latest",
        api_version="auto",
        auto_remove=True,
        command=None,
        docker_url="unix://var/run/docker.sock",
        network_mode="bridge",
        environment={
            "PRIMARY_COLUMN": "address",
            "RECONCILIATOR_ID": "geocodingHere",
            "API_TOKEN": "{{ var.value.here_api_token }}",  # Airflow Variable
            "DATASET_ID": "2",
        },
        volumes=VOLUMES,
        trigger_rule=TriggerRule.ALL_SUCCESS,
    )

    # ------------------------------------------------------------------
    # Task: Calculate Distance to Public Transport
    # ------------------------------------------------------------------
    calculate_distance_to_public_transport = DockerOperator(
        task_id="calculate_distance_to_public_transport",
        image="i2t-backendwithintertwino6-column-extension:latest",
        api_version="auto",
        auto_remove=True,
        command=None,
        docker_url="unix://var/run/docker.sock",
        network_mode="bridge",
        environment={
            "EXTENDER_ID": "spatialDistanceCalculator",
            "LAT_COLUMN": "latitude",
            "LON_COLUMN": "longitude",
            "TARGET_LAYER": "public_transport",
            "TARGET_DATA_SOURCE": f"{DATA_VOLUME_CONTAINER_PATH}/transport_stops.geojson",
            "OUTPUT_COLUMN": "distance_to_pt",
            "DATASET_ID": "2",
        },
        volumes=VOLUMES,
        trigger_rule=TriggerRule.ALL_SUCCESS,
    )

    # ------------------------------------------------------------------
    # Task: Calculate Distance to Residential Areas
    # ------------------------------------------------------------------
    calculate_distance_to_residential_areas = DockerOperator(
        task_id="calculate_distance_to_residential_areas",
        image="i2t-backendwithintertwino6-column-extension:latest",
        api_version="auto",
        auto_remove=True,
        command=None,
        docker_url="unix://var/run/docker.sock",
        network_mode="bridge",
        environment={
            "EXTENDER_ID": "spatialDistanceCalculator",
            "LAT_COLUMN": "latitude",
            "LON_COLUMN": "longitude",
            "TARGET_LAYER": "residential_areas",
            "TARGET_DATA_SOURCE": f"{DATA_VOLUME_CONTAINER_PATH}/residential_areas.geojson",
            "OUTPUT_COLUMN": "distance_to_residential",
            "DATASET_ID": "2",
        },
        volumes=VOLUMES,
        trigger_rule=TriggerRule.ALL_SUCCESS,
    )

    # ------------------------------------------------------------------
    # Task: Save Final Facility Accessibility Data
    # ------------------------------------------------------------------
    save_facilities_accessibility_csv = DockerOperator(
        task_id="save_facilities_accessibility_csv",
        image="i2t-backendwithintertwino6-save:latest",
        api_version="auto",
        auto_remove=True,
        command=None,
        docker_url="unix://var/run/docker.sock",
        network_mode="bridge",
        environment={
            "DATASET_ID": "2",
        },
        volumes=VOLUMES,
        trigger_rule=TriggerRule.ALL_SUCCESS,
    )

    # ------------------------------------------------------------------
    # Set task dependencies (sequential flow)
    # ------------------------------------------------------------------
    (
        load_and_modify_facilities
        >> geocode_facilities_here
        >> calculate_distance_to_public_transport
        >> calculate_distance_to_residential_areas
        >> save_facilities_accessibility_csv
    )