# Generated by Prefect Pipeline Generator
# Date: 2024-06-13
# Pipeline: load_and_modify_facilities_pipeline
# Prefect version: 2.14.0

from typing import List, Tuple

from prefect import flow, task, get_run_logger
from prefect.task_runners import SequentialTaskRunner
from prefect_docker import DockerContainer
from prefect.filesystems import LocalFileSystem
from prefect.blocks.system import Secret


def _mount_volume(host_path: str, container_path: str = "/app/data") -> List[Tuple[str, str]]:
    """
    Helper to create a Docker volume mount tuple.

    Args:
        host_path: Path on the host machine.
        container_path: Path inside the Docker container (default: /app/data).

    Returns:
        List containing a single (host_path, container_path) tuple.
    """
    return [(host_path, container_path)]


@task(retries=1, retry_delay_seconds=30)
def load_and_modify_facilities(data_dir_path: str) -> None:
    """
    Load and modify facilities data using the dedicated Docker image.

    Args:
        data_dir_path: Path to the shared data directory mounted into the container.
    """
    logger = get_run_logger()
    logger.info("Running Load & Modify Facilities Docker container")
    container = DockerContainer(
        image="i2t-backendwithintertwino6-load-and-modify:latest",
        env={"DATASET_ID": "2", "TABLE_NAME_PREFIX": "JOT_"},
        volumes=_mount_volume(data_dir_path),
    )
    container.run()


@task(retries=1, retry_delay_seconds=30)
def geocode_facilities_here(data_dir_path: str, here_api_token: str) -> None:
    """
    Geocode facilities using the HERE API.

    Args:
        data_dir_path: Path to the shared data directory.
        here_api_token: HERE API token retrieved from a Prefect Secret block.
    """
    logger = get_run_logger()
    logger.info("Running Geocode Facilities (HERE) Docker container")
    container = DockerContainer(
        image="i2t-backendwithintertwino6-reconciliation:latest",
        env={
            "PRIMARY_COLUMN": "address",
            "RECONCILIATOR_ID": "geocodingHere",
            "API_TOKEN": here_api_token,
            "DATASET_ID": "2",
        },
        volumes=_mount_volume(data_dir_path),
    )
    container.run()


@task(retries=1, retry_delay_seconds=30)
def calculate_distance_to_public_transport(data_dir_path: str) -> None:
    """
    Calculate distance from each facility to the nearest public transport stop.

    Args:
        data_dir_path: Path to the shared data directory containing the GeoJSON file.
    """
    logger = get_run_logger()
    logger.info("Running Calculate Distance to Public Transport Docker container")
    container = DockerContainer(
        image="i2t-backendwithintertwino6-column-extension:latest",
        env={
            "EXTENDER_ID": "spatialDistanceCalculator",
            "LAT_COLUMN": "latitude",
            "LON_COLUMN": "longitude",
            "TARGET_LAYER": "public_transport",
            "TARGET_DATA_SOURCE": "/app/data/transport_stops.geojson",
            "OUTPUT_COLUMN": "distance_to_pt",
            "DATASET_ID": "2",
        },
        volumes=_mount_volume(data_dir_path),
    )
    container.run()


@task(retries=1, retry_delay_seconds=30)
def calculate_distance_to_residential_areas(data_dir_path: str) -> None:
    """
    Calculate distance from each facility to the nearest residential area.

    Args:
        data_dir_path: Path to the shared data directory containing the GeoJSON file.
    """
    logger = get_run_logger()
    logger.info("Running Calculate Distance to Residential Areas Docker container")
    container = DockerContainer(
        image="i2t-backendwithintertwino6-column-extension:latest",
        env={
            "EXTENDER_ID": "spatialDistanceCalculator",
            "LAT_COLUMN": "latitude",
            "LON_COLUMN": "longitude",
            "TARGET_LAYER": "residential_areas",
            "TARGET_DATA_SOURCE": "/app/data/residential_areas.geojson",
            "OUTPUT_COLUMN": "distance_to_residential",
            "DATASET_ID": "2",
        },
        volumes=_mount_volume(data_dir_path),
    )
    container.run()


@task(retries=1, retry_delay_seconds=30)
def save_facilities_accessibility_csv(data_dir_path: str) -> None:
    """
    Save the final facility accessibility data as a CSV file.

    Args:
        data_dir_path: Path to the shared data directory where the output will be written.
    """
    logger = get_run_logger()
    logger.info("Running Save Final Facility Accessibility Data Docker container")
    container = DockerContainer(
        image="i2t-backendwithintertwino6-save:latest",
        env={"DATASET_ID": "2"},
        volumes=_mount_volume(data_dir_path),
    )
    container.run()


@flow(
    name="load_and_modify_facilities_pipeline",
    task_runner=SequentialTaskRunner(),
)
def load_and_modify_facilities_pipeline() -> None:
    """
    Orchestrates the full pipeline for loading, modifying, geocoding,
    extending, and saving facility accessibility data.
    """
    logger = get_run_logger()

    # Load shared data directory block
    data_dir_block = LocalFileSystem.load("data_dir_volume")
    data_dir_path = data_dir_block.basepath
    logger.info(f"Using shared data directory at: {data_dir_path}")

    # Load required secrets
    here_secret = Secret.load("here_geocoding_api")
    here_api_token = here_secret.get()
    logger.info("Retrieved HERE API token from secret block")

    # Execute tasks in the defined order
    load_and_modify_facilities(data_dir_path)
    geocode_facilities_here(data_dir_path, here_api_token)
    calculate_distance_to_public_transport(data_dir_path)
    calculate_distance_to_residential_areas(data_dir_path)
    save_facilities_accessibility_csv(data_dir_path)


if __name__ == "__main__":
    # Running the flow locally for testing/debugging purposes
    load_and_modify_facilities_pipeline()