# Generated by Prefect 2.x Code Generator
# Generation Date: [Insert Date Here]
# Prefect Version: 2.14.0

from prefect import flow, task, get_run_logger
from prefect.task_runners import SequentialTaskRunner
from prefect.docker import DockerContainer
from prefect.blocks.system import Secret
from prefect.filesystems import LocalFileSystem

# Define the environment variables for each task
load_and_modify_env = {
    "DATASET_ID": "2",
    "TABLE_NAME_PREFIX": "JOT_"
}

reconcile_geocoding_env = {
    "PRIMARY_COLUMN": "address",
    "RECONCILIATOR_ID": "geocodingHere",
    "API_TOKEN": Secret.load("reconciliation_service").get(),
    "DATASET_ID": "2"
}

calculate_distance_pt_env = {
    "EXTENDER_ID": "spatialDistanceCalculator",
    "LAT_COLUMN": "latitude",
    "LON_COLUMN": "longitude",
    "TARGET_LAYER": "public_transport",
    "TARGET_DATA_SOURCE": "/app/data/transport_stops.geojson",
    "OUTPUT_COLUMN": "distance_to_pt",
    "DATASET_ID": "2"
}

calculate_distance_residential_env = {
    "EXTENDER_ID": "spatialDistanceCalculator",
    "LAT_COLUMN": "latitude",
    "LON_COLUMN": "longitude",
    "TARGET_LAYER": "residential_areas",
    "TARGET_DATA_SOURCE": "/app/data/residential_areas.geojson",
    "OUTPUT_COLUMN": "distance_to_residential",
    "DATASET_ID": "2"
}

save_final_data_env = {
    "DATASET_ID": "2"
}

# Define the tasks
@task(retries=1, name="Load and Modify Data")
def load_and_modify_data():
    logger = get_run_logger()
    logger.info("Starting load and modify data task")
    container = DockerContainer(
        image="i2t-backendwithintertwino6-load-and-modify:latest",
        env=load_and_modify_env
    )
    container.run()

@task(retries=1, name="Reconcile Geocoding")
def reconcile_geocoding():
    logger = get_run_logger()
    logger.info("Starting reconcile geocoding task")
    container = DockerContainer(
        image="i2t-backendwithintertwino6-reconciliation:latest",
        env=reconcile_geocoding_env
    )
    container.run()

@task(retries=1, name="Calculate Distance to Public Transport")
def calculate_distance_pt():
    logger = get_run_logger()
    logger.info("Starting calculate distance to public transport task")
    container = DockerContainer(
        image="i2t-backendwithintertwino6-column-extension:latest",
        env=calculate_distance_pt_env
    )
    container.run()

@task(retries=1, name="Calculate Distance to Residential Areas")
def calculate_distance_residential():
    logger = get_run_logger()
    logger.info("Starting calculate distance to residential areas task")
    container = DockerContainer(
        image="i2t-backendwithintertwino6-column-extension:latest",
        env=calculate_distance_residential_env
    )
    container.run()

@task(retries=1, name="Save Final Data")
def save_final_data():
    logger = get_run_logger()
    logger.info("Starting save final data task")
    container = DockerContainer(
        image="i2t-backendwithintertwino6-save:latest",
        env=save_final_data_env
    )
    container.run()

# Define the flow
@flow(name="load_and_modify_data_pipeline", task_runner=SequentialTaskRunner())
def load_and_modify_data_pipeline():
    logger = get_run_logger()
    logger.info("Starting load and modify data pipeline")

    load_and_modify_data()
    reconcile_geocoding()
    calculate_distance_pt()
    calculate_distance_residential()
    save_final_data()

# Run the flow
if __name__ == "__main__":
    load_and_modify_data_pipeline()