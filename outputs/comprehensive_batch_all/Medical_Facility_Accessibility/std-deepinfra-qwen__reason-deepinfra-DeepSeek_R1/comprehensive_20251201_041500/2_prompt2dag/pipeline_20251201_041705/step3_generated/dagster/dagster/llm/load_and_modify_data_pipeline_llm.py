# Generated by Dagster Code Generator
# Generation Metadata:
# - Job Name: load_and_modify_data_pipeline
# - Description: No description provided.
# - Executor Type: docker_executor
# - IO Manager: fs_io_manager
# - Dagster Version: 1.5.0
# - Use Assets: False
# - Required Resources: data_dir, here_api

from dagster import job, op, Out, In, RetryPolicy, fs_io_manager, Field, String, resource, execute_job, docker_executor

# Define resources
@resource(config_schema={"data_dir": Field(String)})
def data_dir(context):
    """Data Directory resource."""
    return context.resource_config["data_dir"]

@resource
def load_and_modify_service(context):
    """Load and Modify Service resource."""
    pass

@resource
def reconciliation_service(context):
    """Reconciliation Service resource."""
    pass

@resource
def column_extension_service(context):
    """Column Extension Service resource."""
    pass

@resource
def save_service(context):
    """Save Service resource."""
    pass

@resource(config_schema={"transport_stops_geojson": Field(String)})
def transport_stops_geojson(context):
    """Transport Stops GeoJSON resource."""
    return context.resource_config["transport_stops_geojson"]

@resource(config_schema={"residential_areas_geojson": Field(String)})
def residential_areas_geojson(context):
    """Residential Areas GeoJSON resource."""
    return context.resource_config["residential_areas_geojson"]

@resource(config_schema={"uri": Field(String)})
def mongodb(context):
    """MongoDB resource."""
    return context.resource_config["uri"]

@resource(config_schema={"api_key": Field(String)})
def intertwino_api(context):
    """Intertwino API resource."""
    return context.resource_config["api_key"]

# Define ops
@op(
    required_resource_keys={"data_dir", "load_and_modify_service"},
    out={"modified_data": Out()},
    retry_policy=RetryPolicy(max_retries=1),
)
def load_and_modify_data(context):
    """Load and modify data using the load_and_modify_service."""
    data_dir = context.resources.data_dir
    service = context.resources.load_and_modify_service
    # Perform data loading and modification
    modified_data = service.load_and_modify(data_dir)
    return modified_data

@op(
    required_resource_keys={"reconciliation_service"},
    out={"reconciled_data": Out()},
    retry_policy=RetryPolicy(max_retries=1),
)
def reconcile_geocoding(context, modified_data):
    """Reconcile geocoding using the reconciliation_service."""
    service = context.resources.reconciliation_service
    # Perform geocoding reconciliation
    reconciled_data = service.reconcile_geocoding(modified_data)
    return reconciled_data

@op(
    required_resource_keys={"column_extension_service", "transport_stops_geojson"},
    out={"distance_to_pt_data": Out()},
    retry_policy=RetryPolicy(max_retries=1),
)
def calculate_distance_pt(context, reconciled_data):
    """Calculate distance to public transport using the column_extension_service."""
    service = context.resources.column_extension_service
    transport_stops = context.resources.transport_stops_geojson
    # Calculate distance to public transport
    distance_to_pt_data = service.calculate_distance(reconciled_data, transport_stops)
    return distance_to_pt_data

@op(
    required_resource_keys={"column_extension_service", "residential_areas_geojson"},
    out={"distance_to_residential_data": Out()},
    retry_policy=RetryPolicy(max_retries=1),
)
def calculate_distance_residential(context, distance_to_pt_data):
    """Calculate distance to residential areas using the column_extension_service."""
    service = context.resources.column_extension_service
    residential_areas = context.resources.residential_areas_geojson
    # Calculate distance to residential areas
    distance_to_residential_data = service.calculate_distance(distance_to_pt_data, residential_areas)
    return distance_to_residential_data

@op(
    required_resource_keys={"save_service", "data_dir"},
    retry_policy=RetryPolicy(max_retries=1),
)
def save_final_data(context, distance_to_residential_data):
    """Save final data using the save_service."""
    service = context.resources.save_service
    data_dir = context.resources.data_dir
    # Save final data
    service.save_data(distance_to_residential_data, data_dir)

# Define job
@job(
    resource_defs={
        "data_dir": data_dir,
        "load_and_modify_service": load_and_modify_service,
        "reconciliation_service": reconciliation_service,
        "column_extension_service": column_extension_service,
        "save_service": save_service,
        "transport_stops_geojson": transport_stops_geojson,
        "residential_areas_geojson": residential_areas_geojson,
        "mongodb": mongodb,
        "intertwino_api": intertwino_api,
    },
    executor_def=docker_executor,
    description="No description provided.",
)
def load_and_modify_data_pipeline():
    """Dagster job to load, modify, and save data."""
    modified_data = load_and_modify_data()
    reconciled_data = reconcile_geocoding(modified_data)
    distance_to_pt_data = calculate_distance_pt(reconciled_data)
    distance_to_residential_data = calculate_distance_residential(distance_to_pt_data)
    save_final_data(distance_to_residential_data)

# Example execution
if __name__ == "__main__":
    execute_job(
        load_and_modify_data_pipeline,
        run_config={
            "resources": {
                "data_dir": {"config": {"data_dir": "/path/to/data"}},
                "transport_stops_geojson": {"config": {"transport_stops_geojson": "/path/to/transport_stops.geojson"}},
                "residential_areas_geojson": {"config": {"residential_areas_geojson": "/path/to/residential_areas.geojson"}},
                "mongodb": {"config": {"uri": "mongodb://localhost:27017"}},
                "intertwino_api": {"config": {"api_key": "your_api_key"}},
            }
        },
    )