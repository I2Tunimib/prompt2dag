# Generated by Prefect 2.x Code Generator
# Generation Date: [Current Date]
# Prefect Version: 2.14.0

from prefect import flow, task, get_run_logger
from prefect_docker import DockerContainer
from prefect_docker.credentials import DockerHost
from prefect.infrastructure import LocalFileSystem, Secret
from prefect.task_runners import SequentialTaskRunner

# Define the environment variables for each task
load_and_modify_env = {
    "DATASET_ID": "2",
    "TABLE_NAME_PREFIX": "JOT_"
}

reconcile_geocoding_env = {
    "PRIMARY_COLUMN": "address",
    "RECONCILIATOR_ID": "geocodingHere",
    "API_TOKEN": Secret.load("HERE_API_TOKEN").get(),
    "DATASET_ID": "2"
}

calculate_distance_pt_env = {
    "EXTENDER_ID": "spatialDistanceCalculator",
    "LAT_COLUMN": "latitude",
    "LON_COLUMN": "longitude",
    "TARGET_LAYER": "public_transport",
    "TARGET_DATA_SOURCE": "/app/data/transport_stops.geojson",
    "OUTPUT_COLUMN": "distance_to_pt",
    "DATASET_ID": "2"
}

calculate_distance_residential_env = {
    "EXTENDER_ID": "spatialDistanceCalculator",
    "LAT_COLUMN": "latitude",
    "LON_COLUMN": "longitude",
    "TARGET_LAYER": "residential_areas",
    "TARGET_DATA_SOURCE": "/app/data/residential_areas.geojson",
    "OUTPUT_COLUMN": "distance_to_residential",
    "DATASET_ID": "2"
}

save_final_data_env = {
    "DATASET_ID": "2"
}

# Define the tasks
@task(retries=1, name="Load and Modify Data")
def load_and_modify_data():
    logger = get_run_logger()
    logger.info("Starting Load and Modify Data task")
    container = DockerContainer(
        image="i2t-backendwithintertwino6-load-and-modify:latest",
        env=load_and_modify_env,
        docker_host=DockerHost.load("default-docker-host"),
        volumes=[
            LocalFileSystem.load("data_dir").path + ":/app/data"
        ]
    )
    container.run()

@task(retries=1, name="Reconcile Geocoding")
def reconcile_geocoding():
    logger = get_run_logger()
    logger.info("Starting Reconcile Geocoding task")
    container = DockerContainer(
        image="i2t-backendwithintertwino6-reconciliation:latest",
        env=reconcile_geocoding_env,
        docker_host=DockerHost.load("default-docker-host"),
        volumes=[
            LocalFileSystem.load("data_dir").path + ":/app/data"
        ]
    )
    container.run()

@task(retries=1, name="Calculate Distance to Public Transport")
def calculate_distance_pt():
    logger = get_run_logger()
    logger.info("Starting Calculate Distance to Public Transport task")
    container = DockerContainer(
        image="i2t-backendwithintertwino6-column-extension:latest",
        env=calculate_distance_pt_env,
        docker_host=DockerHost.load("default-docker-host"),
        volumes=[
            LocalFileSystem.load("transport_stops_geojson").path + ":/app/data/transport_stops.geojson"
        ]
    )
    container.run()

@task(retries=1, name="Calculate Distance to Residential Areas")
def calculate_distance_residential():
    logger = get_run_logger()
    logger.info("Starting Calculate Distance to Residential Areas task")
    container = DockerContainer(
        image="i2t-backendwithintertwino6-column-extension:latest",
        env=calculate_distance_residential_env,
        docker_host=DockerHost.load("default-docker-host"),
        volumes=[
            LocalFileSystem.load("residential_areas_geojson").path + ":/app/data/residential_areas.geojson"
        ]
    )
    container.run()

@task(retries=1, name="Save Final Data")
def save_final_data():
    logger = get_run_logger()
    logger.info("Starting Save Final Data task")
    container = DockerContainer(
        image="i2t-backendwithintertwino6-save:latest",
        env=save_final_data_env,
        docker_host=DockerHost.load("default-docker-host"),
        volumes=[
            LocalFileSystem.load("data_dir").path + ":/app/data"
        ]
    )
    container.run()

# Define the flow
@flow(name="load_and_modify_data_pipeline", task_runner=SequentialTaskRunner())
def load_and_modify_data_pipeline():
    logger = get_run_logger()
    logger.info("Starting load_and_modify_data_pipeline")

    load_and_modify_data_result = load_and_modify_data()
    reconcile_geocoding_result = reconcile_geocoding(wait_for=[load_and_modify_data_result])
    calculate_distance_pt_result = calculate_distance_pt(wait_for=[reconcile_geocoding_result])
    calculate_distance_residential_result = calculate_distance_residential(wait_for=[calculate_distance_pt_result])
    save_final_data_result = save_final_data(wait_for=[calculate_distance_residential_result])

if __name__ == "__main__":
    load_and_modify_data_pipeline()